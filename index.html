<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArkRecode å°æˆ°ç´€éŒ„å™¨ v2.5.3</title>
    
    <!-- å…§å®¹å®‰å…¨æ”¿ç­– -->
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'self'; 
                   script-src 'self' https://unpkg.com https://cdn.tailwindcss.com 'unsafe-inline' 'unsafe-eval'; 
                   connect-src 'self' https://script.google.com https://script.googleapis.com;
                   style-src 'self' https://cdn.tailwindcss.com 'unsafe-inline';">
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel Standalone for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* è‡ªè¨‚ç¾©Lucideåœ–æ¨™ */
        .lucide-icon {
            display: inline-block;
            width: 1em;
            height: 1em;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        /* å‚™è¨»æ¬„ä½tooltipæ¨£å¼ */
        .notes-cell {
            position: relative;
            cursor: help;
        }
        
        .notes-cell .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1f2937;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 1000;
            max-width: 200px;
            white-space: pre-wrap;
            word-wrap: break-word;
            text-align: center;
        }
        
        .notes-cell .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #1f2937;
        }
        
        .notes-cell:hover .tooltip {
            opacity: 1;
            visibility: visible;
        }
        
        /* ä½œè€…ä¿¡æ¯æ¨£å¼ */
        .author-info {
            position: fixed;
            bottom: 4px;
            right: 4px;
            font-size: 8px;
            color: #9ca3af;
            opacity: 0.3;
            z-index: 10;
        }

        /* æ‰¹é‡ä¸Šå‚³é€²åº¦æ¢ */
        .upload-progress {
            width: 100%;
            height: 4px;
            background-color: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .upload-progress-bar {
            height: 100%;
            background-color: #3b82f6;
            transition: width 0.3s ease;
        }

        /* å…è²¬è²æ˜æ¨£å¼ */
        .disclaimer-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .disclaimer-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 24px;
            margin: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        
        .disclaimer-content h2 {
            color: #dc2626;
            border-bottom: 2px solid #fecaca;
            padding-bottom: 8px;
            margin-bottom: 16px;
        }
        
        .disclaimer-section {
            margin-bottom: 20px;
            padding: 12px;
            border-left: 4px solid #3b82f6;
            background-color: #f8fafc;
        }
        
        .warning-section {
            border-left-color: #f59e0b;
            background-color: #fffbeb;
        }
        
        .danger-section {
            border-left-color: #dc2626;
            background-color: #fef2f2;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <!-- ä½œè€…è³‡è¨Š -->
    <div class="author-info">by zzas | v2.5.3</div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useCallback } = React;

        // ==================== å·¥å…·å‡½æ•¸ ====================
        const SecurityUtils = {
            // åŸºæœ¬è¼¸å…¥æ¸…ç† - ç”¨æ–¼å¯¦æ™‚è¼¸å…¥ï¼Œå‚™è¨»æ¬„ä½å…è¨±ç©ºç™½
            cleanInput: (input, allowSpaces = false) => {
                if (typeof input !== 'string') return input;
                let cleaned = input
                    .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '') // ç§»é™¤è…³æœ¬
                    .replace(/<[^>]*>/g, ''); // ç§»é™¤HTMLæ¨™ç±¤
                
                if (!allowSpaces) {
                    cleaned = cleaned.trim();
                } else {
                    // å‚™è¨»æ¬„ä½ï¼šå…è¨±ç©ºç™½ä½†é™åˆ¶é€£çºŒç©ºç™½æœ€å¤š1å€‹
                    cleaned = cleaned.replace(/\s{2,}/g, ' ');
                }
                
                return cleaned;
            },

            // XSSé˜²è­·ï¼šæ¸…ç†ç”¨æˆ¶è¼¸å…¥ - ç”¨æ–¼å­˜å„²å’Œé¡¯ç¤º
            sanitizeInput: (input) => {
                if (typeof input !== 'string') return input;
                return input
                    .replace(/&/g, '&amp;')  // å¿…é ˆå…ˆè™•ç† & ç¬¦è™Ÿ
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#x27;')
                    .replace(/\//g, '&#x2F;')
                    .trim();
            },

            // æ¸…ç†HTMLå…§å®¹ - ç”¨æ–¼é¡¯ç¤º
            sanitizeHtml: (html) => {
                if (typeof html !== 'string') return html;
                return html
                    .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
                    // è§£ç¢¼å¸¸ç”¨çš„HTMLå¯¦é«”
                    .replace(/&#x2F;/g, '/')
                    .replace(/&#x27;/g, "'")
                    .replace(/&quot;/g, '"')
                    .replace(/&lt;/g, '<')
                    .replace(/&gt;/g, '>')
                    .replace(/&amp;/g, '&');
            },

            // é©—è­‰Google Sheets URL
            validateGoogleSheetsUrl: (url) => {
                if (!url || typeof url !== 'string') return false;
                
                try {
                    const urlObj = new URL(url);
                    const allowedHosts = [
                        'script.google.com',
                        'script.googleapis.com'
                    ];
                    
                    return allowedHosts.some(host => 
                        urlObj.hostname === host || urlObj.hostname.endsWith('.' + host)
                    );
                } catch {
                    return false;
                }
            },

            // æ•¸æ“šæ··æ·†ï¼ˆåŸºç¤ä¿è­·ï¼‰
            obfuscateData: (data) => {
                try {
                    return btoa(JSON.stringify(data));
                } catch {
                    return JSON.stringify(data);
                }
            },

            deobfuscateData: (data) => {
                try {
                    return JSON.parse(atob(data));
                } catch {
                    try {
                        return JSON.parse(data);
                    } catch {
                        return null;
                    }
                }
            },

            // æª¢æŸ¥ç€è¦½å™¨å­˜å„²æ”¯æ´
            checkStorageSupport: () => {
                try {
                    const testKey = '__storage_test__';
                    localStorage.setItem(testKey, 'test');
                    localStorage.removeItem(testKey);
                    return true;
                } catch {
                    return false;
                }
            }
        };

        // ==================== å…è²¬è²æ˜çµ„ä»¶ ====================
        const DisclaimerModal = ({ onAccept, onDecline }) => {
            return (
                <div className="disclaimer-modal">
                    <div className="disclaimer-content">
                        <h2 className="text-xl font-bold text-red-600 mb-4">
                            âš ï¸ ä½¿ç”¨æ¢æ¬¾èˆ‡å…è²¬è²æ˜
                        </h2>
                        
                        <div className="disclaimer-section danger-section">
                            <h3 className="font-semibold text-red-700 mb-2">ğŸš¨ é‡è¦æé†’</h3>
                            <ul className="text-sm text-red-600 space-y-1">
                                <li>â€¢ æ­¤å·¥å…·ç‚º<strong>é›¢ç·šæ‡‰ç”¨ç¨‹å¼</strong>ï¼Œæ•¸æ“šåƒ…å­˜å„²åœ¨æ‚¨çš„ç€è¦½å™¨æœ¬åœ°</li>
                                <li>â€¢ Google SheetsåŒæ­¥åŠŸèƒ½éœ€è¦æ‚¨<strong>è‡ªè¡Œé…ç½®API</strong>ï¼Œä¸æœƒèˆ‡ä»–äººå…±äº«</li>
                                <li>â€¢ è«‹<strong>å®šæœŸå‚™ä»½</strong>æ‚¨çš„å°æˆ°è¨˜éŒ„ï¼Œé¿å…æ•¸æ“šä¸Ÿå¤±</li>
                                <li>â€¢ å»ºè­°åœ¨<strong>ç§äººè¨­å‚™</strong>ä¸Šä½¿ç”¨ï¼Œé¿å…åœ¨å…¬ç”¨é›»è…¦æ“ä½œ</li>
                            </ul>
                        </div>

                        <div className="disclaimer-section warning-section">
                            <h3 className="font-semibold text-amber-700 mb-2">ğŸ“‹ è³‡æ–™è™•ç†èªªæ˜</h3>
                            <ul className="text-sm text-amber-600 space-y-1">
                                <li>â€¢ æ‚¨çš„å°æˆ°è¨˜éŒ„ã€è§’è‰²è¨­å®šç­‰æ•¸æ“šåƒ…å­˜æ–¼æœ¬æ©Ÿç€è¦½å™¨</li>
                                <li>â€¢ Google SheetsåŒæ­¥ç‚º<strong>å¯é¸åŠŸèƒ½</strong>ï¼Œç”±æ‚¨å®Œå…¨æ§åˆ¶</li>
                                <li>â€¢ æˆ‘å€‘<strong>ä¸æ”¶é›†ã€ä¸å­˜å„²ã€ä¸å‚³è¼¸</strong>æ‚¨çš„ä»»ä½•å€‹äººè³‡æ–™</li>
                                <li>â€¢ æ¸…é™¤ç€è¦½å™¨æ•¸æ“šå°‡<strong>æ°¸ä¹…åˆªé™¤</strong>æ‰€æœ‰è¨˜éŒ„</li>
                            </ul>
                        </div>

                        <div className="disclaimer-section">
                            <h3 className="font-semibold text-blue-700 mb-2">âš–ï¸ æ³•å¾‹å…è²¬æ¢æ¬¾</h3>
                            <div className="text-sm text-gray-600 space-y-2">
                                <p>ä½¿ç”¨æœ¬å·¥å…·è¡¨ç¤ºæ‚¨åŒæ„ä»¥ä¸‹æ¢æ¬¾ï¼š</p>
                                <ul className="space-y-1 ml-4">
                                    <li>1. æœ¬å·¥å…·æŒ‰<strong>ã€Œç¾ç‹€ã€</strong>æä¾›ï¼Œä¸æä¾›ä»»ä½•å½¢å¼çš„ä¿è­‰</li>
                                    <li>2. é–‹ç™¼è€…ä¸å°ä½¿ç”¨æœ¬å·¥å…·é€ æˆçš„<strong>ä»»ä½•æå¤±</strong>æ‰¿æ“”è²¬ä»»</li>
                                    <li>3. ç”¨æˆ¶æ‡‰<strong>è‡ªè¡Œè©•ä¼°</strong>ä½¿ç”¨é¢¨éšªä¸¦æ¡å–é©ç•¶é˜²è­·æªæ–½</li>
                                    <li>4. å°æ–¼<strong>ç¬¬ä¸‰æ–¹æœå‹™</strong>ï¼ˆå¦‚Google Sheetsï¼‰çš„å®‰å…¨æ€§ï¼Œé–‹ç™¼è€…ä¸æ‰¿æ“”è²¬ä»»</li>
                                    <li>5. æœ¬å…è²¬è²æ˜å—<strong>ä¸­è¯æ°‘åœ‹æ³•å¾‹</strong>ç®¡è½„</li>
                                </ul>
                            </div>
                        </div>

                        <div className="disclaimer-section">
                            <h3 className="font-semibold text-green-700 mb-2">âœ… å»ºè­°</h3>
                            <ul className="text-sm text-green-600 space-y-1">
                                <li>â€¢ å®šæœŸä½¿ç”¨ã€Œå®Œæ•´å‚™ä»½ã€åŠŸèƒ½åŒ¯å‡ºè³‡æ–™</li>
                                <li>â€¢ åƒ…åœ¨ä¿¡ä»»çš„ç¶²è·¯ç’°å¢ƒä¸‹ä½¿ç”¨Google SheetsåŒæ­¥</li>
                                <li>â€¢ å¦‚ç™¼ç¾ç•°å¸¸è¡Œç‚ºï¼Œè«‹ç«‹å³åœæ­¢ä½¿ç”¨ä¸¦æ¸…é™¤è³‡æ–™</li>
                                <li>â€¢ å»ºè­°ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ç¾ä»£ç€è¦½å™¨</li>
                            </ul>
                        </div>

                        <div className="disclaimer-section">
                            <h3 className="font-semibold text-purple-700 mb-2">ğŸ“ è¯çµ¡è³‡è¨Š</h3>
                            <div className="text-sm text-gray-600">
                                <p>å¦‚æœ‰å•é¡Œæˆ–å»ºè­°ï¼Œæ­¡è¿å›é¥‹ï¼š</p>
                                <ul className="mt-2 space-y-1">
                                    <li>â€¢ é–‹ç™¼è€…ï¼šzzas</li>
                                    <li>â€¢ ç‰ˆæœ¬ï¼šv2.5.3</li>
                                    <li>â€¢ æ›´æ–°æ—¥æœŸï¼š{new Date().toLocaleDateString('zh-TW')}</li>
                                </ul>
                            </div>
                        </div>

                        <div className="mt-6 flex gap-4 justify-end">
                            <button
                                onClick={onDecline}
                                className="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors"
                            >
                                ä¸åŒæ„ï¼Œé›¢é–‹
                            </button>
                            <button
                                onClick={onAccept}
                                className="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-semibold"
                            >
                                æˆ‘å·²é–±è®€ä¸¦åŒæ„ä¸Šè¿°æ¢æ¬¾
                            </button>
                        </div>
                        
                        <div className="mt-4 text-xs text-gray-500 text-center">
                            é»æ“Šã€Œæˆ‘å·²é–±è®€ä¸¦åŒæ„ä¸Šè¿°æ¢æ¬¾ã€å³è¡¨ç¤ºæ‚¨å·²å……åˆ†ç†è§£ä¸¦æ¥å—æ‰€æœ‰ä½¿ç”¨æ¢æ¬¾èˆ‡é¢¨éšª
                        </div>
                    </div>
                </div>
            );
        };

        // ==================== åœ–æ¨™çµ„ä»¶ ====================
        const IconComponents = {
            Plus: ({ size = 16, className = "" }) => (
                <svg className={`lucide-icon ${className}`} width={size} height={size} viewBox="0 0 24 24">
                    <path d="M5 12h14M12 5v14"/>
                </svg>
            ),
            Settings: ({ size = 16, className = "" }) => (
                <svg className={`lucide-icon ${className}`} width={size} height={size} viewBox="0 0 24 24">
                    <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                    <circle cx="12" cy="12" r="3"/>
                </svg>
            ),
            Trophy: ({ size = 16, className = "" }) => (
                <svg className={`lucide-icon ${className}`} width={size} height={size} viewBox="0 0 24 24">
                    <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/>
                    <path d="M6 9h12"/>
                    <path d="M19 9v10a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V9"/>
                    <path d="m9 22 3-3 3 3"/>
                    <path d="M9 12h6"/>
                    <path d="M9 15h6"/>
                </svg>
            ),
            FileText: ({ size = 16, className = "" }) => (
                <svg className={`lucide-icon ${className}`} width={size} height={size} viewBox="0 0 24 24">
                    <path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/>
                    <path d="M14 2v4a2 2 0 0 0 2 2h4"/>
                    <path d="M10 9H8"/>
                    <path d="M16 13H8"/>
                    <path d="M16 17H8"/>
                </svg>
            ),
            Upload: ({ size = 16, className = "" }) => (
                <svg className={`lucide-icon ${className}`} width={size} height={size} viewBox="0 0 24 24">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7,10 12,5 17,10"/>
                    <line x1="12" x2="12" y1="5" y2="15"/>
                </svg>
            ),
            Download: ({ size = 16, className = "" }) => (
                <svg className={`lucide-icon ${className}`} width={size} height={size} viewBox="0 0 24 24">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7,10 12,15 17,10"/>
                    <line x1="12" x2="12" y1="15" y2="3"/>
                </svg>
            ),
            Target: ({ size = 16, className = "" }) => (
                <svg className={`lucide-icon ${className}`} width={size} height={size} viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10"/>
                    <circle cx="12" cy="12" r="6"/>
                    <circle cx="12" cy="12" r="2"/>
                </svg>
            ),
            Shield: ({ size = 16, className = "" }) => (
                <svg className={`lucide-icon ${className}`} width={size} height={size} viewBox="0 0 24 24">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                </svg>
            ),
            Calculator: ({ size = 16, className = "" }) => (
                <svg className={`lucide-icon ${className}`} width={size} height={size} viewBox="0 0 24 24">
                    <rect width="16" height="20" x="4" y="2" rx="2"/>
                    <line x1="8" x2="16" y1="6" y2="6"/>
                    <line x1="16" x2="16" y1="14" y2="18"/>
                    <path d="m16 10-4 4-4-4"/>
                </svg>
            ),
            Trash: ({ size = 16, className = "" }) => (
                <svg className={`lucide-icon ${className}`} width={size} height={size} viewBox="0 0 24 24">
                    <path d="M3 6h18"/>
                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                </svg>
            )
        };

        // ==================== é€Ÿåº¦è¨ˆç®—å™¨çµ„ä»¶ ====================
        const SpeedCalculator = React.memo(({ isVisible, onClose }) => {
            const [inputs, setInputs] = useState({
                ally: { speed: "", random: "", initial: "" },
                opponent1: { random: "", initial: "" },
                opponent2: { random: "", initial: "" },
                opponent3: { random: "", initial: "" }
            });
            const [results, setResults] = useState([]);

            const handleInputChange = useCallback((character, field, value) => {
                const cleanValue = SecurityUtils.cleanInput(value);
                setInputs((prev) => ({
                    ...prev,
                    [character]: { ...prev[character], [field]: cleanValue },
                }));
            }, []);

            const calculateOpponentSpeeds = useCallback(() => {
                const { ally, ...opponents } = inputs;
                
                // æª¢æŸ¥åŸºæœ¬å¿…å¡«æ¬„ä½
                if (!ally.speed || !ally.initial) {
                    alert('è«‹å¡«å¯«æˆ‘æ–¹çš„é€Ÿåº¦å’Œåˆå§‹è¡Œå‹•å€¼ï¼');
                    return;
                }
                
                const allySpeed = parseFloat(ally.speed);
                const allyInitial = parseFloat(ally.initial);
                const allyRandom = ally.random === "" ? null : parseFloat(ally.random);
                
                if (isNaN(allySpeed) || isNaN(allyInitial)) {
                    alert('è«‹ç¢ºèªæˆ‘æ–¹æ•¸æ“šå¡«å¯«æ­£ç¢ºï¼');
                    return;
                }

                // è¨ˆç®—æˆ‘æ–¹çš„é€Ÿåº¦æ¯”ä¾‹ç¯„åœ
                let allySpeedRatioMin, allySpeedRatioMax;
                
                if (allyRandom !== null) {
                    // æˆ‘æ–¹éš¨æ©Ÿå€¼å·²çŸ¥ï¼Œç²¾ç¢ºè¨ˆç®—
                    const allyActualInitial = allyInitial - allyRandom;
                    const allySpeedRatio = allySpeed / allyActualInitial;
                    allySpeedRatioMin = allySpeedRatioMax = allySpeedRatio;
                } else {
                    // æˆ‘æ–¹éš¨æ©Ÿå€¼æœªçŸ¥ï¼Œå‡è¨­0-5ç¯„åœ
                    const allyActualInitialMin = allyInitial - 5; // éš¨æ©Ÿå€¼æœ€å¤§ç‚º5
                    const allyActualInitialMax = allyInitial - 0; // éš¨æ©Ÿå€¼æœ€å°ç‚º0
                    allySpeedRatioMin = allySpeed / allyActualInitialMax;
                    allySpeedRatioMax = allySpeed / allyActualInitialMin;
                }

                if (!isFinite(allySpeedRatioMin) || !isFinite(allySpeedRatioMax)) {
                    alert('è¨ˆç®—å‡ºç¾éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æˆ‘æ–¹æ•¸æ“šï¼');
                    return;
                }

                const opponentSpeeds = Object.entries(opponents).map(
                    ([character, data]) => {
                        const opponentInitial = parseFloat(data.initial);
                        if (isNaN(opponentInitial) || !data.initial) {
                            return {
                                character,
                                speedMin: null,
                                speedMax: null,
                                random: data.random,
                                initial: data.initial,
                                position: character.replace('opponent', ''),
                            };
                        }

                        const opponentRandom = data.random === "" ? null : parseFloat(data.random);
                        let speedMin, speedMax;
                        
                        if (opponentRandom !== null) {
                            // å°æ‰‹éš¨æ©Ÿå€¼å·²çŸ¥
                            const opponentActualInitial = opponentInitial - opponentRandom;
                            speedMin = Math.round(opponentActualInitial * allySpeedRatioMin);
                            speedMax = Math.round(opponentActualInitial * allySpeedRatioMax);
                        } else {
                            // å°æ‰‹éš¨æ©Ÿå€¼æœªçŸ¥ï¼Œå‡è¨­0-5ç¯„åœ
                            const opponentActualInitialMin = opponentInitial - 5;
                            const opponentActualInitialMax = opponentInitial - 0;
                            speedMin = Math.round(opponentActualInitialMin * allySpeedRatioMin);
                            speedMax = Math.round(opponentActualInitialMax * allySpeedRatioMax);
                        }
                        
                        // ç¢ºä¿æœ€å°å€¼ä¸å¤§æ–¼æœ€å¤§å€¼
                        if (speedMin > speedMax) {
                            [speedMin, speedMax] = [speedMax, speedMin];
                        }

                        return {
                            character,
                            speedMin,
                            speedMax,
                            random: data.random,
                            initial: data.initial,
                            position: character.replace('opponent', ''),
                        };
                    }
                );

                setResults(opponentSpeeds);
            }, [inputs]);

            const clearInputs = useCallback(() => {
                setInputs({
                    ally: { speed: "", random: "", initial: "" },
                    opponent1: { random: "", initial: "" },
                    opponent2: { random: "", initial: "" },
                    opponent3: { random: "", initial: "" }
                });
                setResults([]);
            }, []);

            if (!isVisible) return null;

            return (
                <div className="bg-white rounded-lg shadow-lg p-4 mt-4 border-2 border-purple-200">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-lg font-semibold flex items-center gap-2">
                            <IconComponents.Calculator size={20} className="text-purple-500" />
                            é€Ÿåº¦è¨ˆç®—å™¨
                        </h3>
                        <div className="flex gap-2">
                            <button
                                onClick={clearInputs}
                                className="px-3 py-1 text-sm bg-gray-500 text-white rounded hover:bg-gray-600"
                            >
                                æ¸…ç©º
                            </button>
                            <button
                                onClick={onClose}
                                className="px-3 py-1 text-sm bg-red-500 text-white rounded hover:bg-red-600"
                            >
                                é—œé–‰
                            </button>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-4 gap-4">
                        {/* æˆ‘æ–¹åƒè€ƒæ•¸æ“š */}
                        <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
                            <h4 className="font-medium text-blue-800 mb-3 text-center">æˆ‘æ–¹åƒè€ƒæ•¸æ“š</h4>
                            <div className="space-y-2">
                                <input
                                    type="number"
                                    placeholder="é€Ÿåº¦ *"
                                    value={inputs.ally.speed}
                                    onChange={(e) => handleInputChange("ally", "speed", e.target.value)}
                                    className="w-full text-sm border rounded px-2 py-1 focus:ring-1 focus:ring-blue-500"
                                />
                                <input
                                    type="number"
                                    placeholder="éš¨æ©Ÿå€¼ (å¯é¸)"
                                    value={inputs.ally.random}
                                    onChange={(e) => handleInputChange("ally", "random", e.target.value)}
                                    className="w-full text-sm border rounded px-2 py-1 focus:ring-1 focus:ring-blue-500"
                                />
                                <input
                                    type="number"
                                    placeholder="åˆå§‹è¡Œå‹•å€¼ *"
                                    value={inputs.ally.initial}
                                    onChange={(e) => handleInputChange("ally", "initial", e.target.value)}
                                    className="w-full text-sm border rounded px-2 py-1 focus:ring-1 focus:ring-blue-500"
                                />
                            </div>
                        </div>

                        {/* å°æ‰‹æ•¸æ“š - æ”¹ç‚º3å€‹ */}
                        {["opponent1", "opponent2", "opponent3"].map((opponent, index) => (
                            <div key={opponent} className="bg-pink-50 rounded-lg p-4 border border-pink-200">
                                <h4 className="font-medium text-pink-800 mb-3 text-center">å°æ‰‹{index + 1}</h4>
                                <div className="space-y-2">
                                    <input
                                        type="number"
                                        placeholder="éš¨æ©Ÿå€¼ (å¯é¸)"
                                        value={inputs[opponent].random}
                                        onChange={(e) => handleInputChange(opponent, "random", e.target.value)}
                                        className="w-full text-sm border rounded px-2 py-1 focus:ring-1 focus:ring-pink-500"
                                    />
                                    <input
                                        type="number"
                                        placeholder="åˆå§‹è¡Œå‹•å€¼"
                                        value={inputs[opponent].initial}
                                        onChange={(e) => handleInputChange(opponent, "initial", e.target.value)}
                                        className="w-full text-sm border rounded px-2 py-1 focus:ring-1 focus:ring-pink-500"
                                    />
                                </div>

                                {/* è¨ˆç®—çµæœç›´æ¥é¡¯ç¤ºåœ¨è¼¸å…¥æ¬„ä½ä¸‹æ–¹ */}
                                {results.length > 0 && (
                                    <div className="mt-3 pt-3 border-t border-pink-200">
                                        {(() => {
                                            const result = results.find(r => r.character === opponent);
                                            if (!result) return null;
                                            
                                            return (
                                                <div>
                                                    <div className="bg-blue-100 text-blue-800 rounded p-2 text-center font-bold text-sm">
                                                        é€Ÿåº¦: {result.speedMin === null
                                                            ? "ç„¡æ³•è¨ˆç®—"
                                                            : result.speedMin === result.speedMax
                                                            ? result.speedMin
                                                            : `${result.speedMin} - ${result.speedMax}`}
                                                    </div>
                                                </div>
                                            );
                                        })()}
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>

                    <div className="mt-4 text-center">
                        <button
                            onClick={calculateOpponentSpeeds}
                            className="px-6 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 font-medium"
                        >
                            è¨ˆç®—å°æ‰‹é€Ÿåº¦
                        </button>
                    </div>

                    {/* è¨ˆç®—çµæœèªªæ˜ - ç§»åˆ°è¨ˆç®—æŒ‰éˆ•ä¸‹æ–¹ */}
                    {results.length > 0 && (
                        <div className="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded text-sm">
                            <div className="font-medium text-yellow-800 mb-2">ğŸ’¡ è¨ˆç®—èªªæ˜ï¼š</div>
                            <ul className="text-yellow-700 space-y-1 text-xs">
                                <li>â€¢ <strong>ç²¾ç¢ºè¨ˆç®—</strong>ï¼šæˆ‘æ–¹å’Œå°æ‰‹éš¨æ©Ÿå€¼éƒ½å·²çŸ¥æ™‚ï¼Œé¡¯ç¤ºç¢ºåˆ‡é€Ÿåº¦</li>
                                <li>â€¢ <strong>ç¯„åœè¨ˆç®—</strong>ï¼šéš¨æ©Ÿå€¼æœªçŸ¥æ™‚ï¼Œå‡è¨­éš¨æ©Ÿå€¼ç¯„åœ0-5é€²è¡Œä¼°ç®—</li>
                                <li>â€¢ <strong>æˆ‘æ–¹æœªçŸ¥</strong>ï¼šæˆ‘æ–¹éš¨æ©Ÿå€¼æœªå¡«æ™‚ï¼Œè¨ˆç®—ç¯„åœæœƒæ›´å¤§ä½†æ›´ä¿éšª</li>
                                <li>â€¢ <strong>åƒ…ä¾›åƒè€ƒ</strong>ï¼šæ­¤åŠŸèƒ½ä¸ä¿å­˜æ•¸æ“šï¼Œå°ˆæ³¨è¼”åŠ©å¯¦æˆ°æ±ºç­–</li>
                                <li>â€¢ <strong>å¿…å¡«æ¬„ä½</strong>ï¼šæˆ‘æ–¹é€Ÿåº¦å’Œåˆå§‹è¡Œå‹•å€¼ç‚ºå¿…å¡«é …</li>
                            </ul>
                        </div>
                    )}
                </div>
            );
        });

        // ==================== å·¥å…·å‡½æ•¸ ====================
        const Utils = {
            convertAlias: (input, characterAliases) => {
                if (!input) return input;
                
                // å…ˆæ¸…ç†è¼¸å…¥
                const cleanInput = SecurityUtils.sanitizeInput(input);
                
                for (const character of characterAliases) {
                    if (character.name.toLowerCase() === cleanInput.toLowerCase()) {
                        return character.name;
                    }
                    for (const alias of character.aliases) {
                        if (alias.toLowerCase() === cleanInput.toLowerCase()) {
                            return character.name;
                        }
                    }
                }
                return cleanInput;
            },

            getRankIcon: (rank) => {
                const icons = {
                    'é‡‘ç‰Œ': 'â­',
                    'å¤§å¸«': 'ğŸ’',
                    'æŒ‘æˆ°è€…': 'ğŸ‘‘',
                    'å„ªå‹è€…': 'ğŸ†',
                    'å‰100': 'ğŸ¥‡'
                };
                return icons[rank] || 'ğŸ®';
            },

            exportToCSV: (battleRecords) => {
                try {
                    if (!battleRecords || battleRecords.length === 0) {
                        alert('ç›®å‰æ²’æœ‰ç´€éŒ„å¯ä»¥åŒ¯å‡º');
                        return;
                    }

                    const headers = ['ç´€éŒ„è€…', 'æ—¥æœŸ', 'å°æ‰‹åç¨±', 'å°æ‰‹é™£å®¹', 'æˆ‘æ–¹é™£å®¹', 'å‹è² ', 'æ’ä½', 'å‚™è¨»'];
                    const csvData = battleRecords.map((record) => [
                        SecurityUtils.cleanInput(record.recorder || 'æœªçŸ¥ç”¨æˆ¶'),
                        SecurityUtils.cleanInput(record.date || 'æœªçŸ¥æ—¥æœŸ'),
                        SecurityUtils.cleanInput(record.opponentName || ''),
                        (record.opponentTeam || []).filter(x => x).map(SecurityUtils.cleanInput).join(' + ') || 'ç„¡',
                        (record.myTeam || []).filter(x => x).map(SecurityUtils.cleanInput).join(' + ') || 'ç„¡',
                        SecurityUtils.cleanInput(record.result || 'æœªçŸ¥'),
                        SecurityUtils.cleanInput(record.rank || 'æœªçŸ¥'),
                        SecurityUtils.cleanInput(record.notes || '')
                    ]);
                    
                    const csvContent = [headers, ...csvData]
                        .map(row => row.map(cell => `"${cell.replace(/"/g, '""')}"`).join(','))
                        .join('\n');
                    
                    const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `ArkRecodeå°æˆ°ç´€éŒ„_${new Date().toISOString().split('T')[0]}.csv`;
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    alert('âœ… CSVæ–‡ä»¶å·²ä¸‹è¼‰ï¼');
                    
                } catch (error) {
                    console.error('CSVåŒ¯å‡ºéŒ¯èª¤:', error);
                    alert('âŒ åŒ¯å‡ºå¤±æ•—ï¼š' + error.message);
                }
            },

            exportData: (data) => {
                try {
                    const exportData = {
                        ...data,
                        exportDate: new Date().toISOString(),
                        version: '2.5.3',
                        security: {
                            sanitized: true,
                            exported_by: 'ArkRecode_v2.5.3'
                        }
                    };
                    
                    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `ArkRecode_å®Œæ•´å‚™ä»½_${new Date().toISOString().split('T')[0]}.json`;
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    alert('âœ… å®Œæ•´å‚™ä»½å·²ä¸‹è¼‰ï¼');
                } catch (error) {
                    console.error('å‚™ä»½åŒ¯å‡ºéŒ¯èª¤:', error);
                    alert('âŒ å‚™ä»½å¤±æ•—ï¼š' + error.message);
                }
            }
        };

        // ==================== è¡¨å–®çµ„ä»¶ ====================
        const FormComponents = {
            TeamInput: React.memo(({ label, team, onChange, characterOptions, placeholder }) => (
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">{label}</label>
                    <div className="grid grid-cols-4 gap-2">
                        {team.map((char, idx) => (
                            <div key={idx} className="relative">
                                <input
                                    type="text"
                                    placeholder={`${placeholder}${idx + 1}`}
                                    value={char}
                                    onChange={(e) => {
                                        const cleanValue = SecurityUtils.cleanInput(e.target.value);
                                        onChange(cleanValue, idx);
                                    }}
                                    className="w-full text-sm border rounded px-2 py-1 focus:ring-1 focus:ring-blue-500"
                                    list={`${placeholder}-${idx}-options`}
                                    maxLength="50"
                                />
                                <datalist id={`${placeholder}-${idx}-options`}>
                                    {characterOptions.map(option => (
                                        <option key={option} value={option} />
                                    ))}
                                </datalist>
                            </div>
                        ))}
                    </div>
                </div>
            )),

            ResultSelector: React.memo(({ result, onChange }) => (
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">å‹è² çµæœ</label>
                    <div className="flex gap-2">
                        <label className="flex items-center cursor-pointer">
                            <input
                                type="radio"
                                name="result"
                                value="å‹"
                                checked={result === 'å‹'}
                                onChange={(e) => onChange(SecurityUtils.cleanInput(e.target.value))}
                                className="sr-only"
                            />
                            <div className={`px-3 py-1 text-sm border-2 rounded font-medium transition-all flex items-center gap-1 ${
                                result === 'å‹' 
                                    ? 'bg-green-500 text-white border-green-500' 
                                    : 'bg-white text-green-600 border-green-300 hover:bg-green-50'
                            }`}>
                                ğŸ† å‹åˆ©
                            </div>
                        </label>
                        <label className="flex items-center cursor-pointer">
                            <input
                                type="radio"
                                name="result"
                                value="è¼¸"
                                checked={result === 'è¼¸'}
                                onChange={(e) => onChange(SecurityUtils.cleanInput(e.target.value))}
                                className="sr-only"
                            />
                            <div className={`px-3 py-1 text-sm border-2 rounded font-medium transition-all flex items-center gap-1 ${
                                result === 'è¼¸' 
                                    ? 'bg-red-500 text-white border-red-500' 
                                    : 'bg-white text-red-600 border-red-300 hover:bg-red-50'
                            }`}>
                                ğŸ’” å¤±æ•—
                            </div>
                        </label>
                    </div>
                </div>
            )),

            RankSelector: React.memo(({ rank, onChange }) => (
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">æ’ä½ç­‰ç´š</label>
                    <select
                        value={rank}
                        onChange={(e) => onChange(SecurityUtils.cleanInput(e.target.value))}
                        className="w-32 text-sm border rounded px-2 py-1 focus:ring-1 focus:ring-blue-500"
                    >
                        <option value="">é¸æ“‡æ’ä½</option>
                        <option value="é‡‘ç‰Œ">â­ é‡‘ç‰Œ</option>
                        <option value="å¤§å¸«">ğŸ’ å¤§å¸«</option>
                        <option value="æŒ‘æˆ°è€…">ğŸ‘‘ æŒ‘æˆ°è€…</option>
                        <option value="å„ªå‹è€…">ğŸ† å„ªå‹è€…</option>
                        <option value="å‰100">ğŸ¥‡ å‰100</option>
                    </select>
                </div>
            ))
        };

        // ==================== å»ºè­°çµ„ä»¶ ====================
        const SuggestionComponents = {
            TeamSuggestions: React.memo(({ suggestions, onApply, title, bgColor }) => {
                if (suggestions.length === 0) return null;
                
                return (
                    <div className={`mt-2 p-2 ${bgColor} rounded text-xs`}>
                        <div className="font-medium mb-1">{title}:</div>
                        <div className="flex flex-wrap gap-1">
                            {suggestions.map((suggestion, idx) => (
                                <button
                                    key={idx}
                                    type="button"
                                    onClick={() => onApply(suggestion)}
                                    className="px-2 py-1 bg-yellow-200 text-yellow-800 rounded hover:bg-yellow-300 text-xs"
                                >
                                    {suggestion.name ? `${SecurityUtils.sanitizeHtml(suggestion.name)}: ` : ''}
                                    {suggestion.combo.join('+')}
                                    {suggestion.source === 'history' ? (
                                        <span> ({suggestion.count}æ¬¡
                                        {suggestion.matchCount && suggestion.matchCount > 2 && (
                                            <span>Â·{suggestion.matchCount}/4åŒ¹é…</span>
                                        )}) ğŸ“Š</span>
                                    ) : (
                                        <span> ({(suggestion.winRate * 100).toFixed(0)}%)</span>
                                    )}
                                </button>
                            ))}
                        </div>
                        
                        {/* èªªæ˜æ–‡å­— */}
                        <div className="mt-2 text-xs text-gray-600">
                            ğŸ“Š = è¿‘æœŸæ•¸æ“š (å‡ºç¾æ¬¡æ•¸Â·åŒ¹é…åº¦) | é è¨­çµ„åˆ (æ¨è–¦å‹ç‡)
                        </div>
                    </div>
                );
            }),

            CounterSuggestions: React.memo(({ suggestions, onApply }) => {
                if (suggestions.length === 0) return null;
                
                // å»é‡è¤‡çµ„åˆ - é‡å°ååˆ¶æ¨è–¦ä¹Ÿåšå»é‡
                const uniqueSuggestions = [];
                const seenCombos = new Set();
                
                for (const suggestion of suggestions) {
                    const combo = suggestion.combo || suggestion;
                    const comboKey = combo.slice().sort().join(',');
                    if (!seenCombos.has(comboKey)) {
                        seenCombos.add(comboKey);
                        uniqueSuggestions.push(suggestion);
                    }
                }
                
                return (
                    <div className="mt-2 p-2 bg-green-50 rounded text-xs">
                        <div className="font-medium mb-1">æ¨è–¦ååˆ¶:</div>
                        <div className="space-y-1">
                            {uniqueSuggestions.map((suggestion, idx) => (
                                <div key={idx} className="flex items-center gap-2">
                                    <button
                                        type="button"
                                        onClick={() => onApply(suggestion.combo || suggestion)}
                                        className={`px-2 py-1 rounded hover:opacity-80 text-xs flex items-center gap-1 ${
                                            suggestion.matchLevel === 'å®Œå…¨åŒ¹é…' ? 'bg-green-200 text-green-800' :
                                            suggestion.matchLevel === 'é«˜åº¦åŒ¹é…' ? 'bg-blue-200 text-blue-800' :
                                            'bg-gray-200 text-gray-800'
                                        }`}
                                    >
                                        {(suggestion.combo || suggestion).join('+')}
                                        {suggestion.confidence && suggestion.confidence >= 0.75 && (
                                            <span className="text-xs">â­</span>
                                        )}
                                    </button>
                                    <div className="flex flex-col">
                                        {suggestion.notes && (
                                            <span className="text-gray-600 text-xs">
                                                ({SecurityUtils.sanitizeHtml(suggestion.notes)})
                                            </span>
                                        )}
                                        {suggestion.matchLevel && (
                                            <span className={`text-xs font-medium ${
                                                suggestion.matchLevel === 'å®Œå…¨åŒ¹é…' ? 'text-green-600' :
                                                suggestion.matchLevel === 'é«˜åº¦åŒ¹é…' ? 'text-blue-600' :
                                                'text-gray-600'
                                            }`}>
                                                {SecurityUtils.sanitizeHtml(suggestion.matchLevel)}
                                                {suggestion.confidence && suggestion.confidence < 1 && (
                                                    <span className="ml-1">({(suggestion.confidence * 100).toFixed(0)}%)</span>
                                                )}
                                            </span>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                        
                        <div className="mt-2 pt-2 border-t border-green-200">
                            <div className="text-xs text-green-700">
                                <div className="flex items-center gap-2 mb-1">
                                    <span className="w-3 h-3 bg-green-200 rounded"></span>
                                    <span>å®Œå…¨åŒ¹é… (4/4è§’è‰²)</span>
                                    <span className="w-3 h-3 bg-blue-200 rounded ml-2"></span>
                                    <span>é«˜åº¦åŒ¹é… (3/4è§’è‰²)</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <span className="w-3 h-3 bg-gray-200 rounded"></span>
                                    <span>é€šç”¨å»ºè­°</span>
                                    <span className="ml-2">â­ = é«˜ä¿¡å¿ƒåº¦</span>
                                    <span className="ml-2">ğŸ“Š = è¿‘æœŸæ•¸æ“š(æ¬¡æ•¸)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            })
        };

        // ==================== çµ±è¨ˆçµ„ä»¶ ====================
        const StatsComponents = {
            StatsDashboard: React.memo(({ stats, onExportData, onBatchUpload, communitySettings, battleRecords }) => (
                <div className="bg-white rounded-lg shadow p-4">
                    <h3 className="text-sm font-semibold mb-3">çµ±è¨ˆè³‡æ–™</h3>
                    <div className="space-y-2 text-sm">
                        <div className="flex justify-between">
                            <span className="text-gray-600">ç¸½å ´æ¬¡</span>
                            <span className="font-bold text-blue-600">{stats.total}</span>
                        </div>
                        <div className="flex justify-between">
                            <span className="text-gray-600">å‹å ´</span>
                            <span className="font-bold text-green-600">{stats.wins}</span>
                        </div>
                        <div className="flex justify-between">
                            <span className="text-gray-600">å‹ç‡</span>
                            <span className="font-bold text-purple-600">{stats.winRate}%</span>
                        </div>
                    </div>
                    
                    <div className="mt-3 pt-3 border-t">
                        <div className="text-xs text-gray-500 mb-2 flex items-center gap-1">
                            <div className="w-2 h-2 rounded-full bg-green-500"></div>
                            è³‡æ–™å·²è‡ªå‹•ä¿å­˜
                        </div>
                        
                        {communitySettings.enabled && (
                            <div className="text-xs text-purple-600 mb-2 flex items-center gap-1">
                                <div className="w-2 h-2 rounded-full bg-purple-500"></div>
                                Google SheetsåŒæ­¥å·²å•Ÿç”¨
                                {communitySettings.lastSync && (
                                    <span className="text-gray-500">
                                        (æœ€å¾ŒåŒæ­¥: {new Date(communitySettings.lastSync).toLocaleString('zh-TW', { 
                                            month: 'numeric', 
                                            day: 'numeric', 
                                            hour: '2-digit', 
                                            minute: '2-digit' 
                                        })})
                                    </span>
                                )}
                            </div>
                        )}
                        
                        <div className="space-y-2">
                            <button
                                onClick={onExportData}
                                disabled={battleRecords.length === 0}
                                className={`w-full py-2 px-3 rounded text-sm flex items-center justify-center gap-2 transition-all ${
                                    battleRecords.length === 0
                                        ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                        : 'bg-blue-500 text-white hover:bg-blue-600'
                                }`}
                            >
                                <IconComponents.Download size={14} />
                                å®Œæ•´å‚™ä»½
                            </button>

                            {communitySettings.enabled && (
                                <button
                                    onClick={onBatchUpload}
                                    disabled={battleRecords.length === 0}
                                    className={`w-full py-1 px-2 rounded text-xs flex items-center justify-center gap-1 ${
                                        battleRecords.length === 0
                                            ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                            : 'bg-purple-500 text-white hover:bg-purple-600'
                                    }`}
                                    title={`æ‰¹é‡ä¸Šå‚³åˆ°æ‚¨çš„ç§äººGoogle Sheets (å…±${battleRecords.filter(r => !r.uploaded).length}ç­†æœªä¸Šå‚³)`}
                                >
                                    æ‰¹é‡ä¸Šå‚³ ({battleRecords.filter(r => !r.uploaded).length}ç­†æœªä¸Šå‚³)
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            ))
        };

        // ==================== ä¸»è¦è¡¨å–®çµ„ä»¶ ====================
        const BattleForm = React.memo(({ 
            formData, 
            onInputChange, 
            onSubmit, 
            characterOptions, 
            teamSuggestions, 
            counterSuggestions, 
            onApplySuggestion,
            onUploadSingle,
            communitySettings 
        }) => {
            const [showSpeedCalculator, setShowSpeedCalculator] = useState(false);

            return (
                <div className="lg:col-span-2 space-y-4">
                    {/* ä¸»è¦è¨˜éŒ„è¡¨å–® */}
                    <div className="bg-white rounded-lg shadow-lg p-4">
                        <div className="flex items-center gap-4 mb-4">
                            <h2 className="text-lg font-semibold">æ–°å¢å°æˆ°ç´€éŒ„</h2>
                            <div className="flex items-center gap-2">
                                <label className="text-sm text-gray-600">ç´€éŒ„è€…:</label>
                                <input
                                    type="text"
                                    value={formData.recorder}
                                    onChange={(e) => onInputChange('recorder', SecurityUtils.cleanInput(e.target.value))}
                                    className="w-20 text-sm border rounded px-2 py-1"
                                    placeholder="ç©å®¶å"
                                    maxLength="20"
                                />
                            </div>
                            {/* é€Ÿåº¦è¨ˆç®—å™¨é–‹é—œ */}
                            <div className="ml-auto">
                                <button
                                    onClick={() => setShowSpeedCalculator(!showSpeedCalculator)}
                                    className={`px-3 py-1 text-sm rounded flex items-center gap-1 transition-colors ${
                                        showSpeedCalculator 
                                            ? 'bg-purple-500 text-white' 
                                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                    }`}
                                >
                                    <IconComponents.Calculator size={14} />
                                    {showSpeedCalculator ? 'é—œé–‰è¨ˆç®—å™¨' : 'é€Ÿåº¦è¨ˆç®—å™¨'}
                                </button>
                            </div>
                        </div>
                        
                        <div className="space-y-4">
                            <div>
                                <FormComponents.TeamInput
                                    label="å°æ‰‹é™£å®¹"
                                    team={formData.opponentTeam}
                                    onChange={(value, idx) => onInputChange('opponentTeam', value, idx)}
                                    characterOptions={characterOptions}
                                    placeholder="å°æ‰‹"
                                />
                                
                                <SuggestionComponents.TeamSuggestions
                                    suggestions={teamSuggestions}
                                    onApply={(suggestion) => onApplySuggestion(suggestion, true)}
                                    title="å¸¸è¦‹çµ„åˆ"
                                    bgColor="bg-yellow-50"
                                />
                            </div>

                            <div>
                                <FormComponents.TeamInput
                                    label="æˆ‘æ–¹é™£å®¹"
                                    team={formData.myTeam}
                                    onChange={(value, idx) => onInputChange('myTeam', value, idx)}
                                    characterOptions={characterOptions}
                                    placeholder="æˆ‘æ–¹"
                                />
                                
                                <SuggestionComponents.CounterSuggestions
                                    suggestions={counterSuggestions}
                                    onApply={(suggestion) => onApplySuggestion(suggestion, false)}
                                />
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <FormComponents.ResultSelector
                                    result={formData.result}
                                    onChange={(value) => onInputChange('result', value)}
                                />
                                
                                <FormComponents.RankSelector
                                    rank={formData.rank}
                                    onChange={(value) => onInputChange('rank', value)}
                                />
                            </div>

                            {/* ä¿®æ”¹ï¼šå°æ‰‹åç¨±1/4å¯¬åº¦ï¼Œå‚™è¨»3/4å¯¬åº¦ */}
                            <div className="grid grid-cols-4 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">å°æ‰‹åç¨±</label>
                                    <input
                                        type="text"
                                        value={formData.opponentName}
                                        onChange={(e) => onInputChange('opponentName', SecurityUtils.cleanInput(e.target.value, true))}
                                        placeholder="å°æ‰‹ID..."
                                        className="w-full text-sm border rounded px-2 py-1 focus:ring-1 focus:ring-blue-500"
                                        maxLength="16"
                                    />
                                    <div className="text-xs text-gray-500 mt-1">
                                        {formData.opponentName.length}/16 å­—å…ƒ
                                    </div>
                                </div>

                                <div className="col-span-3">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">å‚™è¨»</label>
                                    <input
                                        type="text"
                                        value={formData.notes}
                                        onChange={(e) => onInputChange('notes', SecurityUtils.cleanInput(e.target.value, true))}
                                        placeholder="æˆ°è¡“è¦é»ã€ç‰¹æ®Šæƒ…æ³ç­‰..."
                                        className="w-full text-sm border rounded px-2 py-1 focus:ring-1 focus:ring-blue-500"
                                        maxLength="200"
                                    />
                                    <div className="text-xs text-gray-500 mt-1">
                                        {formData.notes.length}/200 å­—å…ƒ
                                    </div>
                                </div>
                            </div>

                            <button
                                type="button"
                                onClick={onSubmit}
                                className="w-full bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 font-medium"
                            >
                                ä¿å­˜ç´€éŒ„
                            </button>

                            {communitySettings.enabled && (
                                <button
                                    type="button"
                                    onClick={onUploadSingle}
                                    className="w-full bg-purple-500 text-white py-2 px-4 rounded hover:bg-purple-600 font-medium flex items-center justify-center gap-2"
                                >
                                    ğŸ“Š ä¸Šå‚³åˆ°Google Sheets
                                </button>
                            )}
                        </div>
                    </div>

                    {/* é€Ÿåº¦è¨ˆç®—å™¨ */}
                    <SpeedCalculator 
                        isVisible={showSpeedCalculator} 
                        onClose={() => setShowSpeedCalculator(false)}
                    />
                </div>
            );
        });

        // ==================== æ­·å²è¨˜éŒ„è¡¨æ ¼çµ„ä»¶ ====================  
        const HistoryTable = React.memo(({ 
            records, 
            onAddToCounter, 
            onUploadRecord,
            onDeleteRecord,
            onDeleteBatchByDate,
            onResetData,
            onImportData,
            communitySettings,
            sortBy,
            onSortChange,
            characterOptions,
            convertAlias,
            // æ–°å¢é€™å…©å€‹ props
            onSetFormData,
            onSetCurrentView
        }) => {
            // æœç´¢ç‹€æ…‹
            const [searchOpponents, setSearchOpponents] = useState(['', '', '', '']);
            const [showSearchResults, setShowSearchResults] = useState(false);
            const [isSearching, setIsSearching] = useState(false);
            const [lastSearchTerms, setLastSearchTerms] = useState(['', '', '', '']);

            // å„ªåŒ–çš„è§’è‰²åˆ¥åè½‰æ› - ä½¿ç”¨ç·©å­˜
            const aliasCache = useMemo(() => {
                const cache = new Map();
                characterOptions.forEach(option => {
                    const converted = convertAlias(option);
                    cache.set(option.toLowerCase(), converted);
                });
                return cache;
            }, [characterOptions, convertAlias]);

            // å¿«é€Ÿè§’è‰²è½‰æ›å‡½æ•¸
            const fastConvertAlias = useCallback((input) => {
                if (!input) return input;
                const cleanInput = SecurityUtils.cleanInput(input);
                const cached = aliasCache.get(cleanInput.toLowerCase());
                return cached || convertAlias(cleanInput);
            }, [aliasCache, convertAlias]);

            // åŸ·è¡Œæœç´¢çš„å‡½æ•¸
            const performSearch = useCallback(() => {
                setIsSearching(true);
                
                // ä½¿ç”¨ setTimeout è®“ UI æœ‰æ™‚é–“æ›´æ–°æœç´¢ç‹€æ…‹
                setTimeout(() => {
                    setLastSearchTerms([...searchOpponents]);
                    setIsSearching(false);
                    
                    // è‡ªå‹•é¡¯ç¤ºæœç´¢çµæœï¼ˆå¦‚æœæœ‰çµæœçš„è©±ï¼‰
                    const searchTeam = searchOpponents
                        .map(char => char ? fastConvertAlias(char) : '')
                        .filter(char => char);
                    
                    if (searchTeam.length >= 3) {
                        setShowSearchResults(true);
                    } else {
                        setShowSearchResults(false);
                    }
                }, 50);
            }, [searchOpponents, fastConvertAlias]);

            // è™•ç†è¼¸å…¥æ¬„å¤±ç„¦äº‹ä»¶
            const handleInputBlur = useCallback((index) => {
                // æª¢æŸ¥ç•¶å‰è¼¸å…¥æ˜¯å¦èˆ‡ä¸Šæ¬¡æœç´¢ä¸åŒï¼Œä¸”è‡³å°‘æœ‰3å€‹è§’è‰²
                const currentSearchTeam = searchOpponents.filter(char => char.trim()).length;
                const lastSearchTeam = lastSearchTerms.filter(char => char.trim()).length;
                
                if (currentSearchTeam >= 3 && 
                    (currentSearchTeam !== lastSearchTeam || 
                     searchOpponents.some((char, idx) => char !== lastSearchTerms[idx]))) {
                    performSearch();
                }
            }, [searchOpponents, lastSearchTerms, performSearch]);

            // æœç´¢çµæœ - ä½¿ç”¨æœ€å¾Œæœç´¢çš„è©æ¢
            const searchResults = useMemo(() => {
                const searchTeam = lastSearchTerms
                    .map(char => char ? fastConvertAlias(char) : '')
                    .filter(char => char);
                
                // è‡³å°‘éœ€è¦3å€‹è§’è‰²æ‰é–‹å§‹æœç´¢
                if (searchTeam.length < 3) {
                    return [];
                }

                // æ ¹æ“šè¼¸å…¥çš„è§’è‰²æ•¸é‡æ±ºå®šæœ€ä½åŒ¹é…è¦æ±‚
                const requiredMatchCount = searchTeam.length === 4 ? 4 : 3;

                // é è™•ç†æ‰€æœ‰è¨˜éŒ„çš„å°æ‰‹é™£å®¹ - é¿å…é‡è¤‡è¨ˆç®—
                const processedRecords = records.map(record => {
                    const recordOpponents = record.opponentTeam
                        .filter(char => char)
                        .map(fastConvertAlias);
                    return { ...record, processedOpponents: recordOpponents };
                });

                const matchingRecords = processedRecords.filter(record => {
                    const matchCount = searchTeam.filter(char => 
                        record.processedOpponents.includes(char)
                    ).length;
                    
                    // æ ¹æ“šè¼¸å…¥è§’è‰²æ•¸é‡èª¿æ•´åŒ¹é…è¦æ±‚
                    // 4å€‹è§’è‰²è¼¸å…¥æ™‚ï¼šåªè¦å®Œå…¨åŒ¹é…(4/4)
                    // 3å€‹è§’è‰²è¼¸å…¥æ™‚ï¼šè¦3å€‹ä»¥ä¸ŠåŒ¹é…(3/4æˆ–4/4)
                    return matchCount >= requiredMatchCount;
                }).map(record => {
                    const matchCount = searchTeam.filter(char => 
                        record.processedOpponents.includes(char)
                    ).length;
                    
                    return {
                        ...record,
                        matchCount,
                        matchLevel: matchCount === 4 ? 'å®Œå…¨åŒ¹é…' : matchCount === 3 ? 'é«˜åº¦åŒ¹é…' : 'éƒ¨åˆ†åŒ¹é…'
                    };
                }).sort((a, b) => {
                    // å…ˆæŒ‰åŒ¹é…åº¦æ’åºï¼Œå†æŒ‰æ—¥æœŸæ’åº
                    if (a.matchCount !== b.matchCount) {
                        return b.matchCount - a.matchCount;
                    }
                    return b.id - a.id;
                });

                return matchingRecords;
            }, [lastSearchTerms, records, fastConvertAlias]);

            // è‡ªå‹•é¡¯ç¤ºæœç´¢çµæœ
            useEffect(() => {
                if (lastSearchTerms.filter(c => c).length >= 3 && searchResults.length > 0) {
                    setShowSearchResults(true);
                } else if (lastSearchTerms.filter(c => c).length < 3) {
                    setShowSearchResults(false);
                }
            }, [lastSearchTerms, searchResults.length]);

            // æ ¹æ“šæ’åºæ–¹å¼è™•ç†è¨˜éŒ„
            const sortedRecords = useMemo(() => {
                const recordsToSort = showSearchResults ? searchResults : records;
                const recordsCopy = [...recordsToSort];
                
                if (sortBy === 'opponentId') {
                    return recordsCopy.sort((a, b) => {
                        const nameA = (a.opponentName || '').toLowerCase();
                        const nameB = (b.opponentName || '').toLowerCase();
                        
                        // æœ‰åå­—çš„å„ªå…ˆ
                        if (nameA && !nameB) return -1;
                        if (!nameA && nameB) return 1;
            
                        // éƒ½æœ‰åå­—æˆ–éƒ½æ²’åå­—æ™‚ï¼ŒæŒ‰å­—æ¯æ’åº
                        if (nameA !== nameB) {
                        return nameA.localeCompare(nameB);
                        }

                        // åå­—ç›¸åŒæ™‚ï¼ŒæŒ‰å‰µå»ºæ™‚é–“æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                        return b.id - a.id;
                    });
                } else {
                    // é è¨­æŒ‰å‰µå»ºæ™‚é–“æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                    return recordsCopy.sort((a, b) => b.id - a.id);
                }
            }, [records, searchResults, showSearchResults, sortBy]);

            // è¨ˆç®—æœ€å¸¸è¦‹çš„ç´€éŒ„è€…
            const mainRecorder = useMemo(() => {
                if (records.length === 0) return 'æˆ‘æ–¹';
                
                const recorderCount = {};
                records.forEach(record => {
                    const recorder = record.recorder || 'æœªçŸ¥';
                    recorderCount[recorder] = (recorderCount[recorder] || 0) + 1;
                });
                
                // æ‰¾å‡ºæœ€å¸¸è¦‹çš„ç´€éŒ„è€…
                let maxCount = 0;
                let mostCommonRecorder = 'æˆ‘æ–¹';
                for (const [recorder, count] of Object.entries(recorderCount)) {
                    if (count > maxCount) {
                        maxCount = count;
                        mostCommonRecorder = recorder;
                    }
                }
                
                return mostCommonRecorder;
            }, [records]);

            return (
                <div className="bg-white rounded-lg shadow-lg p-4">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-lg font-semibold flex items-center gap-2">
                            æ­·å²ç´€éŒ„ ({showSearchResults ? `${searchResults.length}/${records.length}` : records.length} ç­†)
                        </h2>
                        <div className="flex gap-2 items-center">
                            <div className="flex items-center gap-2">
                                <label className="text-sm text-gray-600">æ’åºï¼š</label>
                                <select
                                    value={sortBy}
                                    onChange={(e) => onSortChange(e.target.value)}
                                    className="text-xs border rounded px-2 py-1 bg-white"
                                >
                                    <option value="date">æ—¥æœŸ</option>
                                    <option value="opponentId">å°æ‰‹åç¨±</option>
                                </select>
                            </div>
                            <button
                                onClick={onResetData}
                                className="px-3 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600"
                            >
                                é‡ç½®è³‡æ–™
                            </button>
                            <input
                                type="file"
                                accept=".json"
                                onChange={onImportData}
                                className="hidden"
                                id="importFile"
                            />
                            <label
                                htmlFor="importFile"
                                className="px-3 py-1 text-xs bg-gray-500 text-white rounded cursor-pointer hover:bg-gray-600"
                            >
                                å°å…¥è³‡æ–™
                            </label>
                        </div>
                    </div>

                    {/* æœç´¢åŠŸèƒ½å€ */}
                    <div className="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <div className="flex items-center justify-between mb-3">
                            <h3 className="text-sm font-semibold text-blue-800 flex items-center gap-2">
                                <IconComponents.Target size={16} className="text-blue-600" />
                                å°æ‰‹é™£å®¹æœç´¢
                                {isSearching && (
                                    <span className="text-xs text-blue-600 animate-pulse flex items-center gap-1">
                                        <div className="animate-spin rounded-full h-3 w-3 border-b-2 border-blue-600"></div>
                                        æœç´¢ä¸­...
                                    </span>
                                )}
                            </h3>
                            <div className="flex gap-2">
                                <button
                                    onClick={() => {
                                        setSearchOpponents(['', '', '', '']);
                                        setLastSearchTerms(['', '', '', '']);
                                        setShowSearchResults(false);
                                        setIsSearching(false);
                                    }}
                                    className="px-3 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600"
                                >
                                    æ¸…ç©º
                                </button>
                                <button
                                    onClick={performSearch}
                                    disabled={searchOpponents.filter(c => c.trim()).length < 3 || isSearching}
                                    className={`px-3 py-1 text-xs rounded transition-colors flex items-center gap-1 ${
                                        searchOpponents.filter(c => c.trim()).length >= 3 && !isSearching
                                            ? 'bg-blue-500 text-white hover:bg-blue-600' 
                                            : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                    }`}
                                >
                                    <IconComponents.Target size={12} />
                                    ç«‹å³æœç´¢
                                </button>
                                <button
                                    onClick={() => setShowSearchResults(!showSearchResults)}
                                    disabled={searchResults.length === 0}
                                    className={`px-3 py-1 text-xs rounded transition-colors ${
                                        showSearchResults 
                                            ? 'bg-green-500 text-white hover:bg-green-600' 
                                            : searchResults.length > 0
                                            ? 'bg-green-500 text-white hover:bg-green-600'
                                            : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                    }`}
                                >
                                    {showSearchResults ? 'é¡¯ç¤ºå…¨éƒ¨' : `æœç´¢çµæœ (${searchResults.length})`}
                                </button>
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-4 gap-2 mb-3">
                            {searchOpponents.map((char, idx) => (
                                <div key={idx} className="relative">
                                    <input
                                        type="text"
                                        placeholder={`å°æ‰‹${idx + 1}`}
                                        value={char}
                                        onChange={(e) => {
                                            const cleanValue = SecurityUtils.cleanInput(e.target.value);
                                            const newSearchOpponents = [...searchOpponents];
                                            newSearchOpponents[idx] = cleanValue;
                                            setSearchOpponents(newSearchOpponents);
                                        }}
                                        onBlur={() => handleInputBlur(idx)}
                                        onKeyPress={(e) => {
                                            if (e.key === 'Enter') {
                                                e.target.blur(); // è§¸ç™¼å¤±ç„¦äº‹ä»¶
                                            }
                                        }}
                                        className={`w-full text-sm border rounded px-2 py-1 focus:ring-1 focus:ring-blue-500 transition-colors ${
                                            isSearching ? 'bg-blue-50' : ''
                                        }`}
                                        list={`search-opponent-${idx}-options`}
                                        maxLength="20"
                                        disabled={isSearching}
                                    />
                                    <datalist id={`search-opponent-${idx}-options`}>
                                        {characterOptions.map(option => (
                                            <option key={option} value={option} />
                                        ))}
                                    </datalist>
                                </div>
                            ))}
                        </div>
                        
                        {/* æœç´¢æç¤º */}
                        <div className="flex items-center justify-between mb-2">
                            <div className="text-xs text-gray-600">
                                ğŸ’¡ <strong>ä½¿ç”¨æ–¹å¼ï¼š</strong>
                                {searchOpponents.filter(c => c.trim()).length < 3 ? (
                                    <span>è‡³å°‘è¼¸å…¥ 3 å€‹è§’è‰²ï¼Œç„¶å¾Œé»æ“Šã€Œç«‹å³æœç´¢ã€æˆ–åˆ‡æ›åˆ°å…¶ä»–æ¬„ä½è‡ªå‹•æœç´¢</span>
                                ) : searchOpponents.filter(c => c.trim()).length === 4 ? (
                                    <span>å·²è¼¸å…¥ 4 å€‹è§’è‰²ï¼Œå°‡åªé¡¯ç¤ºå®Œå…¨åŒ¹é…(4/4)çš„è¨˜éŒ„</span>
                                ) : (
                                    <span>å·²è¼¸å…¥ {searchOpponents.filter(c => c.trim()).length} å€‹è§’è‰²ï¼Œå°‡é¡¯ç¤ºé«˜åº¦åŒ¹é…(3/4)å’Œå®Œå…¨åŒ¹é…(4/4)çš„è¨˜éŒ„</span>
                                )}
                            </div>
                            
                            {/* å¿«é€Ÿé–‹å§‹è¨˜éŒ„æŒ‰éˆ• */}
                            {lastSearchTerms.filter(c => c).length >= 3 && (
                                <button
                                    type="button"
                                    onClick={() => {
                                        console.log('å¿«é€Ÿè¨˜éŒ„æŒ‰éˆ•è¢«é»æ“Š');
                                        
                                        try {
                                            // å–å¾—æœå°‹çš„å°æ‰‹çµ„åˆ
                                            const searchTeam = lastSearchTerms
                                                .map(char => char ? fastConvertAlias(SecurityUtils.cleanInput(char)) : '')
                                                .filter(char => char);
                                            
                                            if (searchTeam.length === 0) {
                                                alert('âŒ ç„¡æ³•å–å¾—æœå°‹çµ„åˆï¼Œè«‹é‡æ–°æœå°‹');
                                                return;
                                            }
                                            
                                            // ç¢ºä¿æœ‰4å€‹ä½ç½®
                                            const opponentTeam = [
                                                searchTeam[0] || '',
                                                searchTeam[1] || '',
                                                searchTeam[2] || '',
                                                searchTeam[3] || ''
                                            ];
                                            
                                            // ä½¿ç”¨å‚³å…¥çš„ props å‡½æ•¸
                                            onSetFormData(prev => ({
                                                ...prev,
                                                opponentTeam: opponentTeam
                                            }));
                                            
                                            // è·³è½‰åˆ°è¨˜éŒ„é é¢
                                            onSetCurrentView('record');
                                            
                                        } catch (error) {
                                            console.error('å¿«é€Ÿè¨˜éŒ„åŠŸèƒ½éŒ¯èª¤:', error);
                                            alert('âŒ æ“ä½œå¤±æ•—ï¼Œè«‹é‡è©¦');
                                        }
                                    }}
                                    className="px-3 py-1 bg-green-500 text-white rounded text-xs hover:bg-green-600 flex items-center gap-1 transition-colors"
                                >
                                    <IconComponents.Plus size={12} />
                                    å¿«é€Ÿé–‹å§‹è¨˜éŒ„
                                </button>
                            )}
                        </div>
                        
                        {/* æœç´¢çµæœæ¦‚è¦ */}
                        {lastSearchTerms.filter(c => c).length >= 3 && !isSearching && (
                            <div className="text-sm">
                                {searchResults.length > 0 ? (
                                    <div className="flex flex-wrap gap-2 items-center">
                                        <span className="text-blue-700 font-medium">
                                            æ‰¾åˆ° {searchResults.length} ç­†åŒ¹é…è¨˜éŒ„ï¼š
                                        </span>
                                        {searchResults.slice(0, 3).map((result, idx) => (
                                            <div key={idx} className={`px-2 py-1 rounded text-xs ${
                                                result.matchLevel === 'å®Œå…¨åŒ¹é…' ? 'bg-green-200 text-green-800' :
                                                result.matchLevel === 'é«˜åº¦åŒ¹é…' ? 'bg-blue-200 text-blue-800' :
                                                'bg-gray-200 text-gray-800'
                                            }`}>
                                                {result.matchCount}/4 åŒ¹é… - {result.result === 'å‹' ? 'ğŸ†' : 'ğŸ’”'} 
                                                {result.opponentName && <span className="ml-1">vs {SecurityUtils.sanitizeHtml(result.opponentName)}</span>}
                                            </div>
                                        ))}
                                        {searchResults.length > 3 && (
                                            <span className="text-gray-500 text-xs">...ç­‰{searchResults.length}ç­†</span>
                                        )}
                                        <div className="text-xs text-gray-500 mt-1">
                                            æœç´¢æ¢ä»¶: {lastSearchTerms.filter(c => c).join(' + ')}
                                            {lastSearchTerms.filter(c => c).length === 4 && 
                                                <span className="text-blue-600 ml-2">(åƒ…å®Œå…¨åŒ¹é…)</span>
                                            }
                                        </div>
                                    </div>
                                ) : (
                                    <div className="text-gray-600">
                                        {lastSearchTerms.filter(c => c).length === 4 ? (
                                            <span>ç„¡å®Œå…¨åŒ¹é…è¨˜éŒ„ï¼ˆæœç´¢æ¢ä»¶: {lastSearchTerms.filter(c => c).join(' + ')}ï¼‰</span>
                                        ) : (
                                            <span>ç„¡åŒ¹é…è¨˜éŒ„ï¼ˆæœç´¢æ¢ä»¶: {lastSearchTerms.filter(c => c).join(' + ')}ï¼‰</span>
                                        )}
                                        <div className="text-xs text-gray-500 mt-1">
                                            ğŸ’¡ å˜—è©¦æ¸›å°‘è§’è‰²æ•¸é‡æˆ–æª¢æŸ¥è§’è‰²åç¨±æ˜¯å¦æ­£ç¢º
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* æ¨è–¦åŠŸèƒ½ */}
                        {showSearchResults && searchResults.length > 0 && (
                            <div className="mt-3 pt-3 border-t border-blue-200">
                                <h4 className="text-sm font-medium text-blue-800 mb-2 flex items-center gap-1">
                                    <IconComponents.Trophy size={14} className="text-yellow-500" />
                                    æ¨è–¦æˆ‘æ–¹é™£å®¹ï¼ˆåŸºæ–¼æ­·å²å‹å ´è¨˜éŒ„ï¼‰
                                    {lastSearchTerms.filter(c => c).length === 4 && 
                                        <span className="text-xs text-blue-600">(å®Œå…¨åŒ¹é…)</span>
                                    }
                                </h4>
                                <div className="grid grid-cols-1 gap-2">
                                    {/* å‹å ´è¨˜éŒ„çš„æˆ‘æ–¹é™£å®¹ */}
                                    {searchResults
                                        .filter(record => record.result === 'å‹')
                                        .slice(0, 3)
                                        .map((record, idx) => (
                                            <div key={idx} className="bg-green-50 border border-green-200 rounded p-2">
                                                <div className="flex items-center justify-between">
                                                    <div className="flex items-center gap-2">
                                                        <div className="flex flex-wrap gap-1">
                                                            {record.myTeam.filter(char => char).map((char, charIdx) => (
                                                                <span key={charIdx} className="bg-green-200 text-green-800 px-1 py-0.5 rounded text-xs">
                                                                    {SecurityUtils.sanitizeHtml(char)}
                                                                </span>
                                                            ))}
                                                        </div>
                                                        <div className="text-xs text-green-700">
                                                            ({record.matchCount}/4 åŒ¹é… - {record.date})
                                                            {record.opponentName && (
                                                                <span className="ml-1">vs {SecurityUtils.sanitizeHtml(record.opponentName)}</span>
                                                            )}
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center gap-1">
                                                        <span className="text-green-600 font-bold text-sm">å‹ ğŸ†</span>
                                                        {record.notes && (
                                                            <span className="text-xs text-gray-500 max-w-24 truncate" title={SecurityUtils.sanitizeHtml(record.notes)}>
                                                                ({SecurityUtils.sanitizeHtml(record.notes)})
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        ))
                                    }
                                    
                                    {/* å¦‚æœæ²’æœ‰å‹å ´è¨˜éŒ„ */}
                                    {searchResults.filter(record => record.result === 'å‹').length === 0 && (
                                        <div className="bg-yellow-50 border border-yellow-200 rounded p-2 text-center">
                                            <div className="text-sm text-yellow-700">
                                                {lastSearchTerms.filter(c => c).length === 4 ? (
                                                    <span>ğŸ¤” å°æ–¼æ­¤å®Œå…¨åŒ¹é…é™£å®¹å°šç„¡å‹å ´è¨˜éŒ„ï¼Œå»ºè­°åƒè€ƒå¤±æ•—ç¶“é©—æˆ–å˜—è©¦é€šç”¨ååˆ¶ç­–ç•¥</span>
                                                ) : (
                                                    <span>ğŸ¤” å°æ–¼æ­¤é™£å®¹å°šç„¡å‹å ´è¨˜éŒ„ï¼Œå»ºè­°åƒè€ƒå¤±æ•—ç¶“é©—æˆ–ä½¿ç”¨é€šç”¨ååˆ¶ç­–ç•¥</span>
                                                )}
                                            </div>
                                            {searchResults.filter(record => record.result === 'è¼¸').length > 0 && (
                                                <div className="text-xs text-yellow-600 mt-1">
                                                    æœ‰ {searchResults.filter(record => record.result === 'è¼¸').length} ç­†å¤±æ•—è¨˜éŒ„ï¼Œå¯åƒè€ƒé¿å…ç›¸åŒé™£å®¹
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}


                    </div>
                    
                    {records.length === 0 ? (
                        <div className="text-center py-8 text-gray-500">
                            <IconComponents.Shield size={48} className="mx-auto mb-4 text-gray-300" />
                            <p>å°šç„¡å°æˆ°ç´€éŒ„</p>
                            <p className="text-sm mt-2">æ‚¨çš„æ•¸æ“šå°‡å­˜å„²åœ¨æœ¬æ©Ÿç€è¦½å™¨ä¸­</p>
                        </div>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="w-full text-xs">
                                <thead>
                                    <tr className="border-b bg-gray-50">
                                        <th className="text-left py-2 px-2 text-sm font-semibold">æ—¥æœŸ</th>
                                        <th className="text-left py-2 px-2 text-sm font-semibold">å°æ‰‹åç¨±</th>
                                        <th className="text-left py-2 px-2 text-sm font-semibold">å°æ‰‹é™£å®¹</th>
                                        <th className="text-left py-2 px-2 text-sm font-semibold">
                                            æˆ‘æ–¹é™£å®¹ ({SecurityUtils.sanitizeHtml(mainRecorder)})
                                        </th>
                                        <th className="text-left py-2 px-2 text-sm font-semibold">çµæœ</th>
                                        <th className="text-left py-2 px-2 text-sm font-semibold">æ’ä½</th>
                                        <th className="text-left py-2 px-2 text-sm font-semibold">å‚™è¨»</th>
                                        <th className="text-left py-2 px-2 text-sm font-semibold">ä¸Šå‚³ç‹€æ…‹</th>
                                        <th className="text-left py-2 px-2 text-sm font-semibold">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {sortedRecords.map((record) => (
                                        <tr key={record.id} className={`border-b hover:bg-gray-50 ${
                                            showSearchResults && record.matchLevel === 'å®Œå…¨åŒ¹é…' ? 'bg-green-50' :
                                            showSearchResults && record.matchLevel === 'é«˜åº¦åŒ¹é…' ? 'bg-blue-50' : ''
                                        }`}>
                                            <td className="py-2 px-2 text-sm">
                                                {record.date ? new Date(record.date + 'T00:00:00').toLocaleDateString('zh-TW', { month: 'numeric', day: 'numeric' }).replace('/', '/') : 'æœªçŸ¥'}
                                                {/* åœ¨æœç´¢æ¨¡å¼ä¸‹é¡¯ç¤ºåŒ¹é…åº¦ */}
                                                {showSearchResults && record.matchLevel && (
                                                    <div className={`text-xs mt-1 ${
                                                        record.matchLevel === 'å®Œå…¨åŒ¹é…' ? 'text-green-600' :
                                                        record.matchLevel === 'é«˜åº¦åŒ¹é…' ? 'text-blue-600' :
                                                        'text-gray-600'
                                                    }`}>
                                                        {record.matchCount}/4 {record.matchLevel}
                                                    </div>
                                                )}
                                            </td>
                                            {/* å°æ‰‹åç¨±æ¬„ä½ - æ ¹æ“šå‹è² çµæœèª¿æ•´é¡è‰² */}
                                            <td className="py-2 px-2 text-sm">
                                                {record.opponentName ? (
                                                    <div className={`font-bold ${
                                                        record.result === 'å‹' ? 'text-black' : 'text-purple-600'
                                                    }`}>
                                                        {SecurityUtils.sanitizeHtml(record.opponentName)}
                                                    </div>
                                                ) : (
                                                    <span className="text-gray-400">-</span>
                                                )}
                                            </td>
                                            <td className="py-2 px-2">
                                                <div className="flex flex-wrap gap-1">
                                                    {record.opponentTeam.map((char, idx) => {
                                                        const isMatched = showSearchResults && lastSearchTerms.some(searchChar => 
                                                            fastConvertAlias(SecurityUtils.cleanInput(searchChar)) === fastConvertAlias(char)
                                                        );
                                                        return char && (
                                                            <span key={idx} className={`px-1 py-0.5 rounded text-xs ${
                                                                isMatched 
                                                                    ? 'bg-yellow-200 text-yellow-900 border border-yellow-400 font-bold'
                                                                    : 'bg-red-100 text-red-800'
                                                            }`}>
                                                                {SecurityUtils.sanitizeHtml(char)}
                                                            </span>
                                                        );
                                                    })}
                                                </div>
                                            </td>
                                            <td className="py-2 px-2">
                                                <div className="flex flex-wrap gap-1 items-center">
                                                    {record.myTeam.map((char, idx) => char && (
                                                        <span key={idx} className="bg-blue-100 text-blue-800 px-1 py-0.5 rounded text-xs">
                                                            {SecurityUtils.sanitizeHtml(char)}
                                                        </span>
                                                    ))}
                                                    {/* å¦‚æœç´€éŒ„è€…ä¸æ˜¯ä¸»è¦ç´€éŒ„è€…ï¼Œé¡¯ç¤ºåœ¨æ‹¬è™Ÿä¸­ */}
                                                    {record.recorder && record.recorder !== mainRecorder && (
                                                        <span className="text-gray-500 text-xs ml-1">
                                                            ({SecurityUtils.sanitizeHtml(record.recorder)})
                                                        </span>
                                                    )}
                                                </div>
                                            </td>
                                            <td className="py-2 px-2 text-center">
                                                <span className="text-lg" title={record.result === 'å‹' ? 'å‹åˆ©' : 'å¤±æ•—'}>
                                                    {record.result === 'å‹' ? 'ğŸ†' : 'ğŸ’”'}
                                                </span>
                                            </td>
                                            <td className="py-2 px-2">
                                                <span className="flex items-center gap-1 text-xs">
                                                    {Utils.getRankIcon(record.rank)}
                                                    {SecurityUtils.sanitizeHtml(record.rank)}
                                                </span>
                                            </td>
                                            <td className="py-2 px-2 max-w-32 truncate text-xs notes-cell" title={SecurityUtils.sanitizeHtml(record.notes)}>
                                                {SecurityUtils.sanitizeHtml(record.notes)}
                                                {record.notes && record.notes.length > 15 && (
                                                    <div className="tooltip">
                                                        {SecurityUtils.sanitizeHtml(record.notes)}
                                                    </div>
                                                )}
                                            </td>
                                            <td className="py-2 px-2 text-center">
                                                {communitySettings.enabled ? (
                                                    record.uploaded ? (
                                                        <div className="flex items-center justify-center gap-1">
                                                            <span className="text-lg" title={`ä¸Šå‚³å®Œæˆ (${record.uploadedAt ? new Date(record.uploadedAt).toLocaleDateString('zh-TW') : ''})`}>âœ…</span>
                                                            <span className="text-xs text-gray-500">å·²ä¸Šå‚³</span>
                                                        </div>
                                                    ) : (
                                                        <button
                                                            onClick={() => onUploadRecord(record)}
                                                            className="flex items-center justify-center gap-1 px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600"
                                                            title="ä¸Šå‚³åˆ°æ‚¨çš„ç§äººGoogle Sheets"
                                                        >
                                                            <span>â³</span>
                                                            <span>ä¸Šå‚³</span>
                                                        </button>
                                                    )
                                                ) : (
                                                    <span className="text-xs text-gray-400">æœªå•Ÿç”¨</span>
                                                )}
                                            </td>
                                            <td className="py-2 px-2">
                                                <div className="flex gap-1">
                                                    {record.result === 'å‹' && record.opponentTeam.filter(c => c).length >= 3 && (
                                                        <button
                                                            onClick={() => onAddToCounter(record)}
                                                            className="px-1 py-1 bg-green-100 text-green-700 rounded text-xs hover:bg-green-200 border border-green-300 flex items-center gap-1"
                                                            title="å°‡æ­¤å‹å ´åŠ å…¥ååˆ¶ç­–ç•¥"
                                                        >
                                                            <IconComponents.Target size={12} />
                                                            ç­–ç•¥
                                                        </button>
                                                    )}
                                                    <button
                                                        onClick={() => onDeleteRecord(record.id)}
                                                        className="p-1 text-gray-400 hover:text-red-500 hover:bg-gray-100 rounded transition-colors"
                                                        title="åˆªé™¤æ­¤è¨˜éŒ„"
                                                    >
                                                        <IconComponents.Trash size={14} />
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                    
                    {/* æ‰¹é‡åˆªé™¤å·¥å…·æ¬„ */}
                    {records.length > 0 && (
                        <div className="mt-4 pt-4 border-t border-gray-200">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-4">
                                    <div className="flex items-center gap-2">
                                        <label className="text-sm font-medium text-gray-700">æ‰¹é‡åˆªé™¤ï¼š</label>
                                        <input
                                            type="date"
                                            className="px-3 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            onChange={(e) => {
                                                const selectedDate = e.target.value;
                                                if (selectedDate) {
                                                    const recordsToDelete = records.filter(record => {
                                                        const recordDate = new Date(record.date + 'T00:00:00');
                                                        const cutoffDate = new Date(selectedDate + 'T00:00:00');
                                                        return recordDate < cutoffDate;
                                                    });
                                                    if (recordsToDelete.length > 0) {
                                                        const uploadedCount = recordsToDelete.filter(r => r.uploaded).length;
                                                        const notUploadedCount = recordsToDelete.length - uploadedCount;
                                                        e.target.nextElementSibling.textContent = `å°‡åˆªé™¤ ${recordsToDelete.length} ç­†è¨˜éŒ„ï¼ˆ${uploadedCount} ç­†å·²ä¸Šå‚³ï¼Œ${notUploadedCount} ç­†æœªä¸Šå‚³ï¼‰`;
                                                    } else {
                                                        e.target.nextElementSibling.textContent = 'æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„';
                                                    }
                                                } else {
                                                    e.target.nextElementSibling.textContent = '';
                                                }
                                            }}
                                        />
                                        <span className="text-sm text-gray-600 ml-2"></span>
                                    </div>
                                    <button
                                        onClick={() => {
                                            const dateInput = document.querySelector('input[type="date"]');
                                            if (dateInput && dateInput.value) {
                                                onDeleteBatchByDate(dateInput.value);
                                                dateInput.value = '';
                                                dateInput.nextElementSibling.textContent = '';
                                            } else {
                                                alert('è«‹å…ˆé¸æ“‡æ—¥æœŸ');
                                            }
                                        }}
                                        className="px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600 transition-colors flex items-center gap-1"
                                    >
                                        <IconComponents.Trash size={14} />
                                        æ‰¹é‡åˆªé™¤
                                    </button>
                                </div>
                                <div className="text-sm text-gray-500">
                                    å…± {records.length} ç­†è¨˜éŒ„
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        });

        // ==================== ä¸»æ‡‰ç”¨çµ„ä»¶ ====================
        const App = () => {
            // å…è²¬è²æ˜ç‹€æ…‹
            const [disclaimerAccepted, setDisclaimerAccepted] = useState(false);
            
            // ç‹€æ…‹å®šç¾©
            const [currentView, setCurrentView] = useState('record');
            const [battleRecords, setBattleRecords] = useState([]);
            const [uploadProgress, setUploadProgress] = useState({ current: 0, total: 0, isUploading: false });
            const [sortBy, setSortBy] = useState('date'); // æ–°å¢æ’åºç‹€æ…‹ï¼š'date' æˆ– 'opponentId'
            
            // è§’è‰²åˆ¥ç¨±è³‡æ–™åº« æ­¤æ®µè«‹AIå”åŠ©æ™‚ä¸è¦æ›´æ”¹
            const [characterAliases, setCharacterAliases] = useState([
                { name: 'æ°´ç´', aliases: ['æ°´ç´'] },
                { name: 'è“‹å…’', aliases: ['è“‹å…’', 'æš—è€é ­'] },
                { name: 'æš—é£›', aliases: ['æš—é£›', 'æš—é£›åŠ'] },
                { name: 'AOI', aliases: ['aoi', 'Aoi', 'AOI'] },
                { name: '124', aliases: ['124', 'å…‰å¥³ä¸»', 'å…‰ä¼Š'] },
                { name: 'LLB', aliases: ['llb', 'LLB'] },
                { name: 'æ°´æ‹³', aliases: ['æ°´æ‹³', 'éœ²æ¯”'] },
                { name: 'è¡€å¡', aliases: ['è¡€å¡'] },
                { name: 'å…‰é­', aliases: ['å…‰é­'] },
                { name: 'å…‰é¦¬', aliases: ['å…‰é¦¬', 'å…‰å¯¶é¦¬', 'å…‰å¯¶'] },
                { name: 'æ°´å¶', aliases: ['æ°´å¶'] },
                { name: 'æœ±éŸ³', aliases: ['æœ±éŸ³', 'æœ±èŒµ'] },
                { name: 'HKD', aliases: ['hkd', 'HKD'] },
                { name: 'æ³³è˜¿', aliases: ['æ³³è˜¿', 'æ°´è'] },
                { name: 'æ°´é¦¬', aliases: ['æ°´é¦¬', 'æ°´å¯¶é¦¬'] },
                { name: 'å…‰è˜¿', aliases: ['å…‰è˜¿'] },
                { name: 'æ–°æ˜¥', aliases: ['æ–°æ˜¥'] },
                { name: 'å…‰å¤§å¥¶', aliases: ['å…‰å¤§å¥¶'] },
                { name: 'è‰è“', aliases: ['è‰è“', 'ç•°è®Šä½¿å¾’'] },
                { name: 'æš—é¾', aliases: ['æš—é¾'] },
                { name: 'è‰¾è‰å¡', aliases: ['è‰¾è‰å¡', 'æ„›è‰å¡', 'æ‰€é•·'] },
                { name: 'å…‰é­', aliases: ['å…‰é­'] },
                { name: 'ä½¿å¾’', aliases: ['ä½¿å¾’'] },
                { name: 'é¦™è•‰', aliases: ['é¦™è•‰'] },
                { name: 'å…”å¥³éƒ', aliases: ['å…”å¥³', 'å…”å¥³éƒ'] },
                { name: 'å’ªåš•', aliases: ['å’ªåš•', 'miru'] },
                { name: 'ç«è²“', aliases: ['ç«è²“', 'çœ¼ç½©'] },
                { name: 'ä¼Šå¨ƒ', aliases: ['ä¼Šå¨ƒ', 'eva'] },
                { name: 'æœ¨é¯¨é­š', aliases: ['æœ¨ç“œ', 'æœ¨é¯¨é­š'] },
                { name: 'å…‰å¥¶', aliases: ['å…‰å¥¶', 'æŸ¯å¦®çµ²', 'è–„å°¼æ–¯', 'å¾©æ´»å¥¶'] },
                { name: 'æš—ç›¾', aliases: ['æš—ç›¾'] },
                { name: 'å…‰ç¸½', aliases: ['å…‰ç¸½'] },
                { name: 'è–èª•', aliases: ['è–èª•', 'æ°´è–èª•'] },
                { name: 'æ‹‰å¨œ', aliases: ['æ‹‰å¨œ'] },
                { name: 'å…‰ç‹—', aliases: ['å…‰ç‹—'] },
                { name: 'å…‰ç‹™', aliases: ['å…‰ç‹™'] },
                { name: 'æ²³åŒ—', aliases: ['æ²³åŒ—'] },
                { name: 'èµ¤é¬¼', aliases: ['èµ¤é¬¼'] },
                { name: 'é—†å¨˜', aliases: ['é—†å¨˜', 'ç‰ˆå¨˜', 'æ¿å¨˜'] },
                { name: 'æœ¨åˆº', aliases: ['æœ¨åˆº'] },
                { name: 'æš—æ‹³', aliases: ['æš—æ‹³'] },
                { name: 'æœ¨ä¸²', aliases: ['æœ¨ä¸²', 'èè‰æ–¯ç‰¹'] },
                { name: 'æœ¨é£›', aliases: ['æœ¨é£›'] },
                { name: 'ç«å¶', aliases: ['ç«å¶', 'å¶åƒ', 'ç«å¶åƒ'] },
                { name: 'ç‚¸å½ˆ', aliases: ['ç‚¸å½ˆ', 'å¥³å…’'] },
                { name: 'æ°´å¥¶', aliases: ['æ°´å¥¶', 'æ°´ç›¾å¥¶', 'æ°´ç¸½ç†'] },
                // æ–°è§’è‰²å‚™åŸŸ - æ–¹ä¾¿å¾ŒçºŒæ·»åŠ 
                { name: 'æš—é­”ç‹', aliases: ['æš—é­”ç‹', 'æŒ‰æ‘©ç‹'] },
                { name: 'æœ¨å¥¶', aliases: ['æœ¨å¥¶', 'ç´…èŒ¶'] },
                { name: 'æ°´ç›¾', aliases: ['æ°´ç›¾', 'å°æ°´ç›¾'] },
                { name: 'æ±äº‘', aliases: ['æ±äº‘', 'æ±é›²'] },
                { name: 'å…‰åŸƒ', aliases: ['å…‰åŸƒ', 'å…‰å”‰'] },
                { name: 'å¤©å®®', aliases: ['å…‰ç‹¼', 'å¤©å®®'] },
                { name: 'è²“ç¥­', aliases: ['è²“å¨˜', 'è²“ç¥­'] },
                { name: 'å°ç¸½ç†', aliases: ['å°ç¸½ç†', 'åˆ©å¸Œ', 'å°å…¬ä¸»'] },
                { name: 'æ–°è§’è‰²', aliases: ['æ–°è§’è‰²'] },
                { name: 'æš—ç†Š', aliases: ['æš—ç†Š'] }
            ]);

            const [formData, setFormData] = useState({
                opponentTeam: ['', '', '', ''],
                myTeam: ['', '', '', ''],
                result: 'å‹', // é è¨­å‹åˆ©
                opponentName: '', // æ–°å¢å°æ‰‹åç¨±æ¬„ä½
                notes: '',
                rank: '',
                date: new Date().toISOString().split('T')[0],
                recorder: 'ç©å®¶1'
            });

            const [teamSuggestions, setTeamSuggestions] = useState([]);
            const [counterSuggestions, setCounterSuggestions] = useState([]);
            
            const [counterDatabase, setCounterDatabase] = useState({
                'å…‰é­,è“‹å…’,å…‰ç‹™,è¡€å¡': [{ combo: ['æ°´æ‹³', 'æ°´é¦¬', 'æ°´å¶', 'LLB'], notes: 'æ°´ç³»å£“åˆ¶' }],
                'æ²³åŒ—,èµ¤é¬¼,é—†å¨˜,æ°´ç´': [{ combo: ['å…‰é­', 'æš—é£›', 'è“‹å…’', 'æ°´ç´'], notes: 'å…‰é­é«”ç³»' }]
            });

            const [communitySettings, setCommunitySettings] = useState({
                enabled: false,
                apiUrl: '',
                lastSync: null
            });

            // å¸¸æ•¸å®šç¾©ï¼ˆæ›´æ–°è§’è‰²åç¨±ï¼‰
            const commonCombos = useMemo(() => [
                { combo: ['å…‰é­', 'æš—é£›', 'è“‹å…’', 'æ°´ç´'], winRate: 0.75 },
                { combo: ['è“‹å…’', 'æ°´ç´', 'AOI', 'å…‰é¦¬'], winRate: 0.72 },
                { combo: ['å…”å¥³éƒ', 'æš—é£›', 'è¡€å¡', 'æ°´ç´'], winRate: 0.68 },
                { combo: ['è“‹å…’', 'æš—é£›', 'æ°´ç´', 'è¡€å¡'], winRate: 0.70 },
                { combo: ['124', 'è“‹å…’', 'AOI', 'æ°´ç´'], winRate: 0.74 },
                { combo: ['æ°´æ‹³', 'æ°´é¦¬', 'æ°´ç´', 'LLB'], winRate: 0.73 },
                { combo: ['å…‰é­', 'è“‹å…’', 'HKD', 'å…‰é¦¬'], winRate: 0.69 },
                { combo: ['è“‹å…’', '124', 'ä¼Šå¨ƒ', 'æ³³è˜¿'], winRate: 0.67 },
                { combo: ['å…‰é­', 'è“‹å…’', 'å…‰ç‹™', 'æœ¨åˆº'], winRate: 0.71, name: 'å…‰é­æ ¸çˆ†' },
                { combo: ['æ²³åŒ—', 'èµ¤é¬¼', 'é—†å¨˜', 'æ°´ç´'], winRate: 0.69, name: 'æ²³åŒ—åœ‹å®¶éšŠ' },
            ], []);

            const characterOptions = useMemo(() => {
                // æ”¶é›†æ‰€æœ‰è§’è‰²åç¨±å’Œåˆ¥ç¨±
                const allOptions = [];
                characterAliases.forEach(char => {
                    // æ·»åŠ æ­£å¼åç¨±
                    allOptions.push(char.name);
                    // æ·»åŠ æ‰€æœ‰åˆ¥ç¨±
                    char.aliases.forEach(alias => {
                        if (alias && alias !== char.name) {
                            allOptions.push(alias);
                        }
                    });
                });
                // å»é‡ä¸¦æ’åº
                return [...new Set(allOptions)].sort();
            }, [characterAliases]);

            // çµ±è¨ˆè³‡æ–™
            const stats = useMemo(() => {
                const total = battleRecords.length;
                const wins = battleRecords.filter(r => r.result === 'å‹').length;
                const winRate = total > 0 ? (wins / total * 100).toFixed(1) : 0;
                return { total, wins, winRate };
            }, [battleRecords]);

            // æ ¸å¿ƒå‡½æ•¸
            const convertAlias = useCallback((input) => {
                return Utils.convertAlias(input, characterAliases);
            }, [characterAliases]);

            const getTeamSuggestions = useCallback((team) => {
                if (team.filter(x => x).length >= 2) {
                    const convertedTeam = team.map(convertAlias);
                    const inputCount = convertedTeam.filter(char => char).length; // ç”¨æˆ¶å¯¦éš›è¼¸å…¥çš„è§’è‰²æ•¸é‡
                    const allSuggestions = [];
                    
                    // 1. é è¨­çµ„åˆå»ºè­° - é™åˆ¶æœ€å¤š2å€‹
                    const defaultSuggestions = commonCombos.filter(combo => 
                        convertedTeam.some(char => char && combo.combo.includes(char))
                    ).map(combo => ({ ...combo, source: 'default' }))
                    .slice(0, 2); // é™åˆ¶æœ€å¤š2å€‹é è¨­æ¨è–¦
                    
                    // 2. è¿‘æœŸ80ç­†è³‡æ–™å»ºè­° - æ ¹æ“šè¼¸å…¥æ•¸é‡èª¿æ•´åŒ¹é…è¦æ±‚
                    const recentRecords = battleRecords.slice(-80);
                    const historySuggestions = {};
                    
                    // æ ¹æ“šç”¨æˆ¶è¼¸å…¥æ•¸é‡æ±ºå®šæœ€ä½åŒ¹é…è¦æ±‚
                    let requiredMatchCount = 2; // é»˜èªè‡³å°‘2å€‹åŒ¹é…
                    if (inputCount >= 4) {
                        requiredMatchCount = 4; // 4å€‹è§’è‰²æ™‚è¦æ±‚å®Œå…¨åŒ¹é…
                    } else if (inputCount >= 3) {
                        requiredMatchCount = 3; // 3å€‹è§’è‰²æ™‚è¦æ±‚è‡³å°‘3å€‹åŒ¹é…
                    }
                    
                    recentRecords.forEach(record => {
                        const recordOpponent = record.opponentTeam.filter(char => char).map(convertAlias);
                        const matchCount = convertedTeam.filter(char => char && recordOpponent.includes(char)).length;
                        
                        // ä½¿ç”¨å‹•æ…‹çš„åŒ¹é…è¦æ±‚
                        if (matchCount >= requiredMatchCount && recordOpponent.length >= 3) {
                            // æ”¹ç”¨å®Œæ•´çµ„åˆä½œç‚ºkeyï¼Œä¸æ’åºï¼Œä¿æŒåŸå§‹é †åº
                            const comboKey = recordOpponent.join(',');
                            
                            if (!historySuggestions[comboKey]) {
                                historySuggestions[comboKey] = {
                                    combo: recordOpponent,
                                    count: 0,
                                    matchCount: matchCount,
                                    source: 'history'
                                };
                            }
                            
                            historySuggestions[comboKey].count += 1;
                        }
                    });
                    
                    // è½‰æ›æ­·å²å»ºè­°ç‚ºæ¨™æº–æ ¼å¼ï¼ŒæŒ‰åŒ¹é…åº¦å’Œå‡ºç¾æ¬¡æ•¸æ’åºï¼Œé™åˆ¶æœ€å¤š4å€‹
                    const historyArray = Object.values(historySuggestions)
                        .filter(suggestion => suggestion.count >= 1) // è‡³å°‘å‡ºç¾1æ¬¡å°±é¡¯ç¤º
                        .map(suggestion => ({
                            combo: suggestion.combo,
                            winRate: suggestion.count / recentRecords.length, // ç”¨æ–¼æ’åºçš„é »ç‡æ¯”ä¾‹
                            count: suggestion.count, // å¯¦éš›å‡ºç¾æ¬¡æ•¸
                            matchCount: suggestion.matchCount, // åŒ¹é…çš„è§’è‰²æ•¸é‡
                            source: 'history'
                        }))
                        .sort((a, b) => {
                            // å…ˆæŒ‰åŒ¹é…åº¦æ’åºï¼Œå†æŒ‰å‡ºç¾æ¬¡æ•¸æ’åº
                            if (a.matchCount !== b.matchCount) {
                                return b.matchCount - a.matchCount;
                            }
                            return b.count - a.count;
                        })
                        .slice(0, 4); // é™åˆ¶æœ€å¤š4å€‹æ­·å²çµ„åˆ
                    
                    // åˆä½µå»ºè­°ï¼Œæ­·å²æ•¸æ“šå„ªå…ˆ
                    allSuggestions.push(...historyArray, ...defaultSuggestions);
                    
                    // å»é‡ï¼šä½†é€™æ¬¡ç”¨æ›´ç²¾ç¢ºçš„é‚è¼¯
                    const uniqueSuggestions = [];
                    const seenCombos = new Set();
                    
                    for (const suggestion of allSuggestions) {
                        // å°æ–¼å»é‡ï¼Œé‚„æ˜¯è¦æ’åºæ¯”è¼ƒ
                        const comboKey = suggestion.combo.slice().sort().join(',');
                        if (!seenCombos.has(comboKey)) {
                            seenCombos.add(comboKey);
                            uniqueSuggestions.push(suggestion);
                        }
                    }
                    
                    // æœ€çµ‚é™åˆ¶ï¼šæœ€å¤š6å€‹å»ºè­°ï¼ˆ4å€‹æ­·å² + 2å€‹é è¨­ï¼‰
                    setTeamSuggestions(uniqueSuggestions.slice(0, 6));
                } else {
                    setTeamSuggestions([]);
                }
            }, [commonCombos, convertAlias, battleRecords]);

            const getCounterSuggestions = useCallback((opponentTeam) => {
                const fullOpponent = opponentTeam.filter(char => char).map(convertAlias);
                if (fullOpponent.length >= 3) {
                    const opponentKey = fullOpponent.sort().join(',');
                    const exactCounter = counterDatabase[opponentKey];
                    
                    let suggestions = [];
                    
                    if (exactCounter) {
                        suggestions = exactCounter.map(strategy => ({
                            ...strategy,
                            matchLevel: 'å®Œå…¨åŒ¹é…',
                            confidence: 0.95
                        }));
                    }

                    const threeCharMatches = battleRecords
                        .filter(record => {
                            if (record.result !== 'å‹') return false;
                            const recordOpponent = record.opponentTeam.filter(char => char).map(convertAlias);
                            const matchCount = fullOpponent.filter(char => recordOpponent.includes(char)).length;
                            return matchCount >= 3 && recordOpponent.length >= 3;
                        })
                        .slice(-68);

                    if (threeCharMatches.length > 0) {
                        const historySuggestions = threeCharMatches.map(record => {
                            const recordOpponent = record.opponentTeam.filter(char => char).map(convertAlias);
                            const matchCount = fullOpponent.filter(char => recordOpponent.includes(char)).length;
                            
                            const notesPart = record.notes ? ` - ${record.notes}` : '';
                            const opponentNamePart = record.opponentName ? `vs ${record.opponentName}` : '';
                            const combinedNotes = opponentNamePart + notesPart || 'æ­·å²å‹å ´';
                            
                            if (matchCount === 4) {
                                return {
                                    combo: record.myTeam,
                                    notes: `${matchCount}/4è§’è‰²åŒ¹é… - ${combinedNotes}`,
                                    matchLevel: 'å®Œå…¨åŒ¹é…',
                                    confidence: 0.95
                                };
                            } else {
                                return {
                                    combo: record.myTeam,
                                    notes: `${matchCount}/4è§’è‰²åŒ¹é… - ${combinedNotes}`,
                                    matchLevel: 'é«˜åº¦åŒ¹é…',
                                    confidence: 0.70
                                };
                            }
                        })
                        .sort((a, b) => b.confidence - a.confidence)
                        .slice(0, 2);

                        suggestions = [...suggestions, ...historySuggestions];
                    }

                    // å¦‚æœæ²’æœ‰ä»»ä½•åŒ¹é…æˆ–å»ºè­°è¼ƒå°‘ï¼Œæ·»åŠ é€šç”¨å»ºè­°
                    if (suggestions.length < 3) {
                        const generalSuggestions = [
                            { combo: ['æ°´ç´', 'æ°´é¦¬', 'å…‰é¦¬', 'æ°´å¶'], notes: 'æ°´å¶è‚‰éšŠ', matchLevel: 'é€šç”¨å»ºè­°', confidence: 0.55 },
                            { combo: ['æ²³åŒ—', 'èµ¤é¬¼', 'é—†å¨˜', 'æš—æ‹³'], notes: 'æ²³åŒ—åœ‹å®¶éšŠ', matchLevel: 'é€šç”¨å»ºè­°', confidence: 0.52 },
                            { combo: ['å…‰é­', 'è“‹å…’', 'å…‰ç‹™', 'æœ¨åˆº'], notes: 'å…‰é­æ ¸çˆ†', matchLevel: 'é€šç”¨å»ºè­°', confidence: 0.52 }
                        ];
                        suggestions = [...suggestions, ...generalSuggestions.slice(0, 3 - suggestions.length)];
                    }

                    setCounterSuggestions(suggestions);
                } else {
                    setCounterSuggestions([]);
                }
            }, [convertAlias, counterDatabase, battleRecords]);

            // å–®æ¬¡ä¸Šå‚³å‡½æ•¸
            const uploadToCommunity = useCallback(async (record) => {
                if (!communitySettings.enabled || !communitySettings.apiUrl) {
                    console.log('Google SheetsåŒæ­¥æœªå•Ÿç”¨æˆ–æœªé…ç½®');
                    return false;
                }

                // é©—è­‰URL
                if (!SecurityUtils.validateGoogleSheetsUrl(communitySettings.apiUrl)) {
                    alert('âŒ ä¸æ­£ç¢ºçš„API URLï¼Œè«‹æª¢æŸ¥æ‚¨çš„Google Sheetsè¨­å®š');
                    return false;
                }

                if (record.uploaded) {
                    console.log('è¨˜éŒ„å·²ä¸Šå‚³ï¼Œè·³é');
                    return true;
                }

                try {
                    console.log('æ­£åœ¨ä¸Šå‚³è³‡æ–™åˆ°Google Sheets:', record);
                    
                    // æ¸…ç†è¨˜éŒ„æ•¸æ“š - ä¸Šå‚³æ™‚é€²è¡Œæœ€çµ‚çš„æ¸…ç†
                    const sanitizedRecord = {
                        ...record,
                        recorder: SecurityUtils.cleanInput(record.recorder),
                        notes: SecurityUtils.cleanInput(record.notes, true),
                        opponentName: SecurityUtils.cleanInput(record.opponentName, true),
                        opponentTeam: record.opponentTeam.map(SecurityUtils.cleanInput),
                        myTeam: record.myTeam.map(SecurityUtils.cleanInput),
                        result: record.result === 'å‹' ? 'è´' : record.result
                    };
                    
                    // å˜—è©¦ä¸Šå‚³åˆ°Google Sheets
                    await fetch(communitySettings.apiUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(sanitizedRecord)
                    });

                    // ç”±æ–¼no-corsç„¡æ³•æª¢æŸ¥éŸ¿æ‡‰ç‹€æ…‹ï¼Œæˆ‘å€‘å‡è¨­è«‹æ±‚å·²ç™¼é€æˆåŠŸ
                    const currentTime = new Date().toISOString();
                    
                    // ç«‹å³æ›´æ–°æœ¬åœ°ç‹€æ…‹
                    setBattleRecords(prevRecords => {
                        console.log('æ›´æ–°è¨˜éŒ„ç‹€æ…‹, ID:', record.id);
                        return prevRecords.map(r => {
                            if (r.id === record.id) {
                                console.log('æ‰¾åˆ°åŒ¹é…è¨˜éŒ„ï¼Œæ›´æ–°ä¸Šå‚³ç‹€æ…‹');
                                return { ...r, uploaded: true, uploadedAt: currentTime };
                            }
                            return r;
                        });
                    });

                    setCommunitySettings(prev => ({
                        ...prev,
                        lastSync: currentTime
                    }));
                    
                    console.log('âœ… è¨˜éŒ„å·²æ¨™è¨˜ç‚ºä¸Šå‚³å®Œæˆ');
                    return true;
                    
                } catch (error) {
                    console.error('ä¸Šå‚³å¤±æ•—:', error);
                    // å³ä½¿ç™¼ç”ŸéŒ¯èª¤ï¼Œå¦‚æœæ˜¯ç¶²è·¯å•é¡Œä½†è«‹æ±‚å¯èƒ½å·²ç™¼é€ï¼Œä»æ¨™è¨˜ç‚ºå·²ä¸Šå‚³
                    const currentTime = new Date().toISOString();
                    setBattleRecords(prevRecords => 
                        prevRecords.map(r => 
                            r.id === record.id 
                                ? { ...r, uploaded: true, uploadedAt: currentTime }
                                : r
                        )
                    );
                    setCommunitySettings(prev => ({
                        ...prev,
                        lastSync: currentTime
                    }));
                    return true; // æ”¹ç‚ºè¿”å›trueï¼Œé¿å…æ‰¹é‡ä¸Šå‚³ä¸­æ–·
                }
            }, [communitySettings]);

            // æ‰¹é‡ä¸Šå‚³å‡½æ•¸
            const uploadAllToCommunity = useCallback(async () => {
                if (!communitySettings.enabled || !communitySettings.apiUrl) {
                    alert('è«‹å…ˆé…ç½®Google SheetsåŒæ­¥åŠŸèƒ½');
                    return;
                }

                // é©—è­‰URL
                if (!SecurityUtils.validateGoogleSheetsUrl(communitySettings.apiUrl)) {
                    alert('âŒ æª¢æ¸¬åˆ°ä¸æ­£ç¢ºçš„API URLï¼Œè«‹é‡æ–°é…ç½®');
                    return;
                }

                if (battleRecords.length === 0) {
                    alert('æ²’æœ‰è¨˜éŒ„å¯ä»¥ä¸Šå‚³');
                    return;
                }

                const unUploadedRecords = battleRecords.filter(record => !record.uploaded);
                
                if (unUploadedRecords.length === 0) {
                    alert('ğŸ‰ æ‰€æœ‰è¨˜éŒ„éƒ½å·²ç¶“ä¸Šå‚³å®Œæˆï¼');
                    return;
                }

                const recordSummary = unUploadedRecords.slice(0, 5).map((record, index) => 
                    `${index + 1}. ${SecurityUtils.sanitizeInput(record.recorder)} - ${record.date} (${record.result})`
                ).join('\n');
                
                const extraCount = unUploadedRecords.length > 5 ? `\n...ç­‰å…±${unUploadedRecords.length}ç­†` : '';
                const confirmMessage = `æº–å‚™æ‰¹é‡ä¸Šå‚³ ${unUploadedRecords.length} ç­†è¨˜éŒ„åˆ°æ‚¨çš„ç§äººGoogle Sheetsï¼š\n\n${recordSummary}${extraCount}\n\nç¢ºå®šè¦é–‹å§‹ä¸Šå‚³å—ï¼Ÿ`;

                if (!confirm(confirmMessage)) {
                    return;
                }

                setUploadProgress({ current: 0, total: unUploadedRecords.length, isUploading: true });
                
                let successCount = 0;
                let errorCount = 0;
                
                for (let i = 0; i < unUploadedRecords.length; i++) {
                    const record = unUploadedRecords[i];
                    
                    setUploadProgress(prev => ({ ...prev, current: i + 1 }));
                    
                    try {
                        const success = await uploadToCommunity(record);
                        if (success) {
                            successCount++;
                        } else {
                            errorCount++;
                        }
                        
                        if (i < unUploadedRecords.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 800));
                        }
                    } catch (error) {
                        console.error('æ‰¹æ¬¡ä¸Šå‚³å¤±æ•—:', record.id, error);
                        errorCount++;
                    }
                }

                setUploadProgress({ current: 0, total: 0, isUploading: false });

                alert(`æ‰¹é‡ä¸Šå‚³å®Œæˆï¼\n\nâœ… æˆåŠŸä¸Šå‚³ï¼š${successCount} ç­†\nâŒ å¤±æ•—/è·³éï¼š${errorCount} ç­†\nğŸ“‹ ç¸½è™•ç†ï¼š${successCount + errorCount} ç­†\n\nè«‹åˆ°æ‚¨çš„ç§äººGoogle Sheetsæª¢æŸ¥ä¸Šå‚³çµæœ`);
            }, [communitySettings, battleRecords, uploadToCommunity]);

            // äº‹ä»¶è™•ç†å‡½æ•¸
            const handleInputChange = useCallback((field, value, index = null) => {
                if (index !== null) {
                    const newArray = [...formData[field]];
                    newArray[index] = SecurityUtils.cleanInput(value);
                    setFormData(prev => ({ ...prev, [field]: newArray }));
                    
                    if (field === 'opponentTeam') {
                        getTeamSuggestions(newArray);
                        getCounterSuggestions(newArray);
                    }
                } else {
                    // å°æ–¼å‚™è¨»å’Œå°æ‰‹åç¨±æ¬„ä½ï¼Œå…è¨±ç©ºç™½ï¼Œå…¶ä»–æ¬„ä½æ¸…ç†
                    let cleanValue;
                    if (field === 'notes' || field === 'opponentName') {
                        cleanValue = SecurityUtils.cleanInput(value, true);
                        // å°æ‰‹åç¨±é™åˆ¶16å€‹å­—ç¬¦
                        if (field === 'opponentName' && cleanValue.length > 16) {
                            cleanValue = cleanValue.substring(0, 16);
                        }
                    } else {
                        cleanValue = SecurityUtils.cleanInput(value);
                    }
                    setFormData(prev => ({ ...prev, [field]: cleanValue }));
                }
            }, [formData, getTeamSuggestions, getCounterSuggestions]);

            const applySuggestion = useCallback((suggestion, isOpponent = true) => {
                const field = isOpponent ? 'opponentTeam' : 'myTeam';
                const combo = suggestion.combo || suggestion;
                const sanitizedCombo = combo.map(SecurityUtils.sanitizeInput);
                setFormData(prev => ({ ...prev, [field]: sanitizedCombo }));
                if (isOpponent) {
                    getCounterSuggestions(sanitizedCombo);
                }
            }, [getCounterSuggestions]);

            const handleSubmit = useCallback(() => {
                if (!formData.result || !formData.rank) {
                    alert('è«‹å¡«å¯«å®Œæ•´çš„å‹è² çµæœå’Œæ’ä½ä¿¡æ¯');
                    return;
                }

                const newRecord = {
                    id: Date.now(),
                    opponentTeam: formData.opponentTeam.map(char => convertAlias(SecurityUtils.cleanInput(char))),
                    myTeam: formData.myTeam.map(char => convertAlias(SecurityUtils.cleanInput(char))),
                    result: SecurityUtils.cleanInput(formData.result),
                    opponentName: SecurityUtils.cleanInput(formData.opponentName, true).substring(0, 16), // é™åˆ¶16å­—ç¬¦
                    notes: SecurityUtils.cleanInput(formData.notes, true), // ä¿å­˜æ™‚å…è¨±ç©ºç™½
                    rank: SecurityUtils.cleanInput(formData.rank),
                    date: SecurityUtils.cleanInput(formData.date),
                    recorder: SecurityUtils.cleanInput(formData.recorder),
                    uploaded: false,
                    uploadedAt: null
                };
                
                setBattleRecords(prev => [...prev, newRecord]);
                
                // ä¿æŒè¨˜éŒ„è€…å’Œæ’ä½
                const lastRank = formData.rank;
                const lastRecorder = formData.recorder;
                
                setFormData({
                    opponentTeam: ['', '', '', ''],
                    myTeam: ['', '', '', ''],
                    result: 'å‹', // é‡ç½®ç‚ºé è¨­å‹åˆ©
                    opponentName: '', // é‡ç½®å°æ‰‹åç¨±
                    notes: '',
                    rank: lastRank,
                    date: new Date().toISOString().split('T')[0],
                    recorder: lastRecorder
                });
                
                setTeamSuggestions([]);
                setCounterSuggestions([]);
                
                alert('âœ… ç´€éŒ„å·²ä¿å­˜ï¼');
            }, [formData, convertAlias]);

            const handleUploadSingle = useCallback(() => {
                if (!formData.result || !formData.rank) {
                    alert('è«‹å…ˆå¡«å¯«å®Œæ•´è³‡è¨Šä¸¦ä¿å­˜ç´€éŒ„');
                    return;
                }
                const record = {
                    opponentTeam: formData.opponentTeam.map(char => convertAlias(SecurityUtils.cleanInput(char))),
                    myTeam: formData.myTeam.map(char => convertAlias(SecurityUtils.cleanInput(char))),
                    result: SecurityUtils.cleanInput(formData.result),
                    opponentName: SecurityUtils.cleanInput(formData.opponentName, true).substring(0, 16),
                    notes: SecurityUtils.cleanInput(formData.notes, true),
                    rank: SecurityUtils.cleanInput(formData.rank),
                    date: SecurityUtils.cleanInput(formData.date),
                    recorder: SecurityUtils.cleanInput(formData.recorder),
                    uploaded: false,
                    uploadedAt: null
                };
                uploadToCommunity(record);
            }, [formData, convertAlias, uploadToCommunity]);

            const addToCounterDatabase = useCallback((record) => {
                const opponentTeam = record.opponentTeam.filter(char => char).map(convertAlias);
                const myTeam = record.myTeam.filter(char => char);
                
                if (opponentTeam.length < 3) {
                    alert('å°æ‰‹é™£å®¹è§’è‰²æ•¸é‡ä¸è¶³');
                    return;
                }

                const key = opponentTeam.sort().join(',');
                
                let shouldAdd = true;
                if (counterDatabase[key]) {
                    shouldAdd = confirm(`å·²å­˜åœ¨é‡å°ã€Œ${opponentTeam.join('+')}ã€çš„ååˆ¶ç­–ç•¥ï¼Œæ˜¯å¦è¦†è“‹ï¼Ÿ`);
                }

                if (shouldAdd) {
                    const strategy = {
                        combo: myTeam,
                        notes: record.notes ? `${SecurityUtils.cleanInput(record.notes, true)} (ä¾†è‡ªæ­·å²)` : `${record.date} å‹å ´ç­–ç•¥`
                    };

                    setCounterDatabase(prev => ({
                        ...prev,
                        [key]: [strategy]
                    }));

                    alert(`âœ… å·²å°‡å‹å ´ç­–ç•¥åŠ å…¥ååˆ¶è³‡æ–™åº«ï¼\nå°æ‰‹ï¼š${opponentTeam.join('+')}\nååˆ¶ï¼š${myTeam.join('+')}`);
                }
            }, [convertAlias, counterDatabase]);

            const deleteRecord = useCallback((recordId) => {
                if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œä¸å¯å¾©åŸï¼')) {
                    setBattleRecords(prev => prev.filter(record => record.id !== recordId));
                    alert('âœ… è¨˜éŒ„å·²åˆªé™¤ï¼');
                }
            }, []);

            // æ–°å¢ï¼šæŒ‰æ—¥æœŸæ‰¹é‡åˆªé™¤è¨˜éŒ„
            const deleteBatchByDate = useCallback((beforeDate) => {
                if (!beforeDate) {
                    alert('è«‹é¸æ“‡æ—¥æœŸ');
                    return;
                }

                // éæ¿¾å‡ºè¦åˆªé™¤çš„è¨˜éŒ„
                const recordsToDelete = battleRecords.filter(record => {
                    const recordDate = new Date(record.date + 'T00:00:00');
                    const cutoffDate = new Date(beforeDate + 'T00:00:00');
                    return recordDate < cutoffDate;
                });

                if (recordsToDelete.length === 0) {
                    alert('ğŸ“… æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„');
                    return;
                }

                // çµ±è¨ˆä¿¡æ¯
                const uploadedCount = recordsToDelete.filter(r => r.uploaded).length;
                const notUploadedCount = recordsToDelete.length - uploadedCount;
                
                // é¡¯ç¤ºè©³ç´°ç¢ºèªä¿¡æ¯
                const confirmMessage = `âš ï¸ æº–å‚™åˆªé™¤ ${beforeDate} ä¹‹å‰çš„æ‰€æœ‰å°æˆ°è¨˜éŒ„ï¼š

ğŸ“Š åˆªé™¤çµ±è¨ˆï¼š
â€¢ ç¸½è¨ˆï¼š${recordsToDelete.length} ç­†è¨˜éŒ„
â€¢ å·²ä¸Šå‚³ï¼š${uploadedCount} ç­†
â€¢ æœªä¸Šå‚³ï¼š${notUploadedCount} ç­†

ğŸ“‹ æœ€è¿‘å¹¾ç­†è¨˜éŒ„é è¦½ï¼š
${recordsToDelete.slice(0, 5).map((record, index) => 
    `${index + 1}. ${record.date} - ${SecurityUtils.sanitizeInput(record.recorder)} (${record.result}) ${record.uploaded ? 'âœ…' : 'â³'}`
).join('\n')}${recordsToDelete.length > 5 ? `\n...ç­‰å…±${recordsToDelete.length}ç­†` : ''}

âš ï¸ æ­¤æ“ä½œå°‡æ°¸ä¹…åˆªé™¤é€™äº›è¨˜éŒ„ï¼Œç„¡æ³•å¾©åŸï¼
å»ºè­°åœ¨åˆªé™¤å‰å…ˆé€²è¡Œå®Œæ•´å‚™ä»½ã€‚

ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ`;

                if (!confirm(confirmMessage)) {
                    return;
                }

                // äºŒæ¬¡ç¢ºèª
                if (!confirm(`ğŸ”´ æœ€å¾Œç¢ºèªï¼šæ‚¨å³å°‡åˆªé™¤ ${recordsToDelete.length} ç­†è¨˜éŒ„ï¼ˆåŒ…å« ${uploadedCount} ç­†å·²ä¸Šå‚³è¨˜éŒ„ï¼‰\n\næ­¤æ“ä½œä¸å¯å¾©åŸï¼Œç¢ºå®šç¹¼çºŒå—ï¼Ÿ`)) {
                    return;
                }

                // åŸ·è¡Œåˆªé™¤
                setBattleRecords(prev => {
                    const recordIdsToDelete = new Set(recordsToDelete.map(r => r.id));
                    const newRecords = prev.filter(record => !recordIdsToDelete.has(record.id));
                    
                    // åœ¨ç‹€æ…‹æ›´æ–°å¾Œé¡¯ç¤ºå®Œæˆè¨Šæ¯
                    setTimeout(() => {
                        alert(`âœ… æ‰¹é‡åˆªé™¤å®Œæˆï¼\n\nğŸ“Š åˆªé™¤çµ±è¨ˆï¼š\nâ€¢ ç¸½è¨ˆï¼š${recordsToDelete.length} ç­†\nâ€¢ å·²ä¸Šå‚³ï¼š${uploadedCount} ç­†\nâ€¢ æœªä¸Šå‚³ï¼š${notUploadedCount} ç­†\n\nå‰©é¤˜è¨˜éŒ„ï¼š${newRecords.length} ç­†`);
                    }, 0);
                    
                    return newRecords;
                });
            }, [battleRecords]);

            const resetData = useCallback(() => {
                if (confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œä¸å¯å¾©åŸï¼')) {
                    // æ¸…ç†localStorage
                    const keysToRemove = [
                        'arkrecode_dataVersion', 'arkrecode_battleRecords', 
                        'arkrecode_characterAliases', 'arkrecode_counterDatabase', 
                        'arkrecode_communitySettings', 'arkrecode_disclaimer_accepted',
                        'arkrecode_formData'
                    ];
                    
                    keysToRemove.forEach(key => {
                        try {
                            localStorage.removeItem(key);
                        } catch (error) {
                            console.error('æ¸…ç†localStorageå¤±æ•—:', error);
                        }
                    });
                    
                    setBattleRecords([]);
                    setCounterDatabase({});
                    setCommunitySettings({ enabled: false, apiUrl: '', lastSync: null });
                    alert('è³‡æ–™å·²é‡ç½®ï¼');
                }
            }, []);

            const importData = useCallback((event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                // æª¢æŸ¥æ–‡ä»¶å¤§å°ï¼ˆæœ€å¤§10MBï¼‰
                if (file.size > 10 * 1024 * 1024) {
                    alert('âŒ æª”æ¡ˆå¤ªå¤§ï¼Œè«‹é¸æ“‡å°æ–¼10MBçš„æª”æ¡ˆ');
                    event.target.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // é©—è­‰å°å…¥çš„æ•¸æ“š
                        if (data.battleRecords && Array.isArray(data.battleRecords)) {
                            const sanitizedRecords = data.battleRecords.map(record => ({
                                ...record,
                                recorder: SecurityUtils.cleanInput(record.recorder || ''),
                                notes: SecurityUtils.cleanInput(record.notes || '', true),
                                opponentName: SecurityUtils.cleanInput(record.opponentName || '', true).substring(0, 16),
                                opponentTeam: (record.opponentTeam || []).map(SecurityUtils.cleanInput),
                                myTeam: (record.myTeam || []).map(SecurityUtils.cleanInput),
                                // ç°¡å–®è½‰æ›ï¼šè´ -> å‹
                                result: record.result === 'è´' ? 'å‹' : record.result
                            }));
                            setBattleRecords(sanitizedRecords);
                        }
                        
                        if (data.characterAliases && Array.isArray(data.characterAliases)) {
                            const sanitizedAliases = data.characterAliases.map(alias => ({
                                name: SecurityUtils.cleanInput(alias.name || ''),
                                aliases: (alias.aliases || []).map(SecurityUtils.cleanInput)
                            }));
                            setCharacterAliases(sanitizedAliases);
                        }
                        
                        if (data.counterDatabase && typeof data.counterDatabase === 'object') {
                            setCounterDatabase(data.counterDatabase);
                        }
                        
                        if (data.communitySettings && typeof data.communitySettings === 'object') {
                            // é©—è­‰Google Sheets URL
                            if (data.communitySettings.apiUrl && !SecurityUtils.validateGoogleSheetsUrl(data.communitySettings.apiUrl)) {
                                alert('âš ï¸ å°å…¥çš„Google Sheets URLä¸æ­£ç¢ºï¼Œå·²æ¸…é™¤è©²è¨­å®š');
                                setCommunitySettings({ ...data.communitySettings, apiUrl: '' });
                            } else {
                                setCommunitySettings(data.communitySettings);
                            }
                        }
                        
                        alert('âœ… è³‡æ–™å·²å°å…¥ï¼');
                    } catch (error) {
                        console.error('å°å…¥è³‡æ–™éŒ¯èª¤:', error);
                        alert('âŒ å°å…¥å¤±æ•—ï¼šæ–‡ä»¶æ ¼å¼éŒ¯èª¤');
                    }
                };
                reader.onerror = () => {
                    alert('âŒ æª”æ¡ˆè®€å–å¤±æ•—');
                };
                reader.readAsText(file);
                event.target.value = '';
            }, []);

            // æª¢æŸ¥å…è²¬è²æ˜æ¥å—ç‹€æ…‹
            useEffect(() => {
                const accepted = localStorage.getItem('arkrecode_disclaimer_accepted');
                if (accepted === 'true') {
                    setDisclaimerAccepted(true);
                }
                
                // æª¢æŸ¥ç€è¦½å™¨å­˜å„²æ”¯æ´
                if (!SecurityUtils.checkStorageSupport()) {
                    alert('âš ï¸ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´æœ¬åœ°å­˜å„²ï¼Œå»ºè­°ä½¿ç”¨ç¾ä»£ç€è¦½å™¨ä»¥ç¢ºä¿æœ€ä½³é«”é©—');
                }
            }, []);

            // æ¥å—å…è²¬è²æ˜
            const handleAcceptDisclaimer = useCallback(() => {
                localStorage.setItem('arkrecode_disclaimer_accepted', 'true');
                setDisclaimerAccepted(true);
                alert('âœ… æ­¡è¿ä½¿ç”¨ ArkRecode v2.5.3ï¼æ‚¨çš„è³‡æ–™å°‡å­˜å„²åœ¨æœ¬æ©Ÿç€è¦½å™¨ä¸­ã€‚');
            }, []);

            // æ‹’çµ•å…è²¬è²æ˜
            const handleDeclineDisclaimer = useCallback(() => {
                alert('æ„Ÿè¬æ‚¨çš„é—œæ³¨ï¼Œç‚ºäº†æ‚¨çš„å®‰å…¨ï¼Œè«‹åœ¨å……åˆ†äº†è§£é¢¨éšªå¾Œå†ä½¿ç”¨æœ¬å·¥å…·ã€‚');
            }, []);

            // è³‡æ–™æŒä¹…åŒ–
            useEffect(() => {
                if (!disclaimerAccepted) return;
                
                try {
                    const savedRecords = localStorage.getItem('arkrecode_battleRecords');
                    const savedAliases = localStorage.getItem('arkrecode_characterAliases');
                    const savedCounters = localStorage.getItem('arkrecode_counterDatabase');
                    const savedCommunitySettings = localStorage.getItem('arkrecode_communitySettings');
                    const savedFormData = localStorage.getItem('arkrecode_formData');
                    const dataVersion = localStorage.getItem('arkrecode_dataVersion');
                    const hasVisitedBefore = localStorage.getItem('arkrecode_hasVisited');
                    
                    if (savedRecords) {
                        try {
                            const records = SecurityUtils.deobfuscateData(savedRecords);
                            if (records && Array.isArray(records)) {
                                const updatedRecords = records.map(record => ({
                                    ...record,
                                    uploaded: record.uploaded !== undefined ? record.uploaded : false,
                                    uploadedAt: record.uploadedAt || null,
                                    // ç°¡å–®è½‰æ›ï¼šè´ -> å‹
                                    result: record.result === 'è´' ? 'å‹' : record.result
                                }));
                                
                                setBattleRecords(updatedRecords);
                                console.log(`è¼‰å…¥ ${updatedRecords.length} ç­†å°æˆ°ç´€éŒ„`);
                            }
                            
                            if (dataVersion !== '2.5.3') {
                                console.log(`ç‰ˆæœ¬å¾ ${dataVersion || 'èˆŠç‰ˆ'} å‡ç´šåˆ° 2.5.3`);
                                localStorage.setItem('arkrecode_dataVersion', '2.5.3');
                            }
                            
                        } catch (parseError) {
                            console.error('è§£æå„²å­˜è³‡æ–™å¤±æ•—:', parseError);
                            if (hasVisitedBefore && confirm('âš ï¸ åµæ¸¬åˆ°å„²å­˜è³‡æ–™å¯èƒ½æå£ï¼\næ˜¯å¦è¦é‡ç½®ç‚ºé è¨­è³‡æ–™ï¼Ÿ\n\né»æ“Šã€Œç¢ºå®šã€é‡ç½®ï¼Œã€Œå–æ¶ˆã€ä¿æŒç©ºç™½è³‡æ–™')) {
                                setBattleRecords([
                                    {
                                        id: Date.now() - 3000,
                                        recorder: 'æ¸¬è©¦',
                                        date: '2025-08-01',
                                        opponentTeam: ['å…‰é­', 'è“‹å…’', 'å…‰ç‹™', 'è¡€å¡'],
                                        myTeam: ['æ°´æ‹³', 'æ°´é¦¬', 'æ°´ç´', 'LLB'],
                                        result: 'å‹',
                                        rank: 'æŒ‘æˆ°è€…',
                                        notes: 'æ¸¬è©¦è¨˜éŒ„',
                                        opponentName: 'æ¸¬è©¦å°æ‰‹',
                                        uploaded: false,
                                        uploadedAt: null
                                    }
                                ]);
                            }
                        }
                    } else {
                        if (!hasVisitedBefore) {
                            console.log('ğŸ‘‹ æ­¡è¿é¦–æ¬¡ä½¿ç”¨ ArkRecode v2.5.3ï¼');
                            setBattleRecords([]);
                            localStorage.setItem('arkrecode_hasVisited', 'true');
                        }
                        localStorage.setItem('arkrecode_dataVersion', '2.5.3');
                    }
                    
                    if (savedAliases) {
                        try {
                            const aliases = SecurityUtils.deobfuscateData(savedAliases);
                            if (aliases && Array.isArray(aliases)) {
                                setCharacterAliases(aliases);
                            }
                        } catch (error) {
                            console.warn('è§’è‰²åˆ¥ç¨±è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼');
                        }
                    }
                    
                    if (savedCounters) {
                        try {
                            const counters = SecurityUtils.deobfuscateData(savedCounters);
                            if (counters && typeof counters === 'object') {
                                setCounterDatabase(counters);
                            }
                        } catch (error) {
                            console.warn('ååˆ¶ç­–ç•¥è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼');
                        }
                    }

                    if (savedCommunitySettings) {
                        try {
                            const settings = SecurityUtils.deobfuscateData(savedCommunitySettings);
                            if (settings && typeof settings === 'object') {
                                // é©—è­‰Google Sheets URL
                                if (settings.apiUrl && !SecurityUtils.validateGoogleSheetsUrl(settings.apiUrl)) {
                                    console.warn('æª¢æ¸¬åˆ°ä¸æ­£ç¢ºçš„Google Sheets URLï¼Œå·²æ¸…é™¤');
                                    setCommunitySettings({ ...settings, apiUrl: '', enabled: false });
                                } else {
                                    setCommunitySettings(settings);
                                }
                            }
                        } catch (error) {
                            console.warn('ç¤¾ç¾¤è¨­å®šè¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼');
                        }
                    }

                    // è¼‰å…¥ä¿å­˜çš„è¡¨å–®æ•¸æ“šï¼ˆè¨˜éŒ„è€…å’Œæ’ä½ï¼‰
                    if (savedFormData) {
                        try {
                            const formDataSaved = SecurityUtils.deobfuscateData(savedFormData);
                            if (formDataSaved && typeof formDataSaved === 'object') {
                                setFormData(prev => ({
                                    ...prev,
                                    recorder: SecurityUtils.cleanInput(formDataSaved.recorder || prev.recorder),
                                    rank: SecurityUtils.cleanInput(formDataSaved.rank || prev.rank)
                                }));
                            }
                        } catch (error) {
                            console.warn('è¡¨å–®è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼');
                        }
                    }
                    
                    if (!hasVisitedBefore) {
                        localStorage.setItem('arkrecode_hasVisited', 'true');
                    }
                    
                } catch (error) {
                    console.error('æ•´é«”è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
                    alert('âš ï¸ è³‡æ–™è¼‰å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œå¯èƒ½éœ€è¦é‡ç½®æ‡‰ç”¨ç¨‹å¼');
                }
            }, [disclaimerAccepted]);

            // è‡ªå‹•ä¿å­˜
            useEffect(() => {
                if (!disclaimerAccepted) return;
                
                try {
                    const obfuscatedData = SecurityUtils.obfuscateData(battleRecords);
                    localStorage.setItem('arkrecode_battleRecords', obfuscatedData);
                } catch (error) {
                    console.error('ä¿å­˜å°æˆ°è¨˜éŒ„å¤±æ•—:', error);
                }
            }, [battleRecords, disclaimerAccepted]);

            useEffect(() => {
                if (!disclaimerAccepted) return;
                
                try {
                    const obfuscatedData = SecurityUtils.obfuscateData(characterAliases);
                    localStorage.setItem('arkrecode_characterAliases', obfuscatedData);
                } catch (error) {
                    console.error('ä¿å­˜è§’è‰²åˆ¥ç¨±å¤±æ•—:', error);
                }
            }, [characterAliases, disclaimerAccepted]);
            
            useEffect(() => {
                if (!disclaimerAccepted) return;
                
                try {
                    const obfuscatedData = SecurityUtils.obfuscateData(counterDatabase);
                    localStorage.setItem('arkrecode_counterDatabase', obfuscatedData);
                } catch (error) {
                    console.error('ä¿å­˜ååˆ¶è³‡æ–™åº«å¤±æ•—:', error);
                }
            }, [counterDatabase, disclaimerAccepted]);

            useEffect(() => {
                if (!disclaimerAccepted) return;
                
                try {
                    const obfuscatedData = SecurityUtils.obfuscateData(communitySettings);
                    localStorage.setItem('arkrecode_communitySettings', obfuscatedData);
                } catch (error) {
                    console.error('ä¿å­˜ç¤¾ç¾¤è¨­å®šå¤±æ•—:', error);
                }
            }, [communitySettings, disclaimerAccepted]);

            // ä¿å­˜è¡¨å–®æ•¸æ“šï¼ˆè¨˜éŒ„è€…å’Œæ’ä½ï¼‰
            useEffect(() => {
                if (!disclaimerAccepted) return;
                
                try {
                    const formDataToSave = {
                        recorder: formData.recorder,
                        rank: formData.rank
                    };
                    const obfuscatedData = SecurityUtils.obfuscateData(formDataToSave);
                    localStorage.setItem('arkrecode_formData', obfuscatedData);
                } catch (error) {
                    console.error('ä¿å­˜è¡¨å–®è³‡æ–™å¤±æ•—:', error);
                }
            }, [formData.recorder, formData.rank, disclaimerAccepted]);

            // å¦‚æœå°šæœªæ¥å—å…è²¬è²æ˜ï¼Œé¡¯ç¤ºå…è²¬è²æ˜å°è©±æ¡†
            if (!disclaimerAccepted) {
                return (
                    <DisclaimerModal 
                        onAccept={handleAcceptDisclaimer}
                        onDecline={handleDeclineDisclaimer}
                    />
                );
            }

            // æ¸²æŸ“ä¸»æ‡‰ç”¨
            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-2">
                    <div className="max-w-6xl mx-auto">
                        {/* æ¨™é¡Œåˆ— */}
                        <div className="bg-white rounded-lg shadow-lg mb-4 p-3">
                            <div className="flex flex-wrap gap-3 items-center justify-between">
                                <h1 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                                    <IconComponents.Trophy className="text-yellow-500" size={24} />
                                    ArkRecode å°æˆ°ç´€éŒ„å™¨ v2.5.3
                                </h1>
                                <div className="flex gap-1">
                                    <button
                                        onClick={() => setCurrentView('record')}
                                        className={`px-3 py-1 rounded text-sm flex items-center gap-1 ${
                                            currentView === 'record' ? 'bg-blue-500 text-white' : 'bg-gray-200'
                                        }`}
                                    >
                                        <IconComponents.Plus size={14} />
                                        ç´€éŒ„
                                    </button>
                                    <button
                                        onClick={() => setCurrentView('history')}
                                        className={`px-3 py-1 rounded text-sm flex items-center gap-1 ${
                                            currentView === 'history' ? 'bg-blue-500 text-white' : 'bg-gray-200'
                                        }`}
                                    >
                                        <IconComponents.FileText size={14} />
                                        æ­·å²
                                    </button>
                                    <button
                                        onClick={() => setCurrentView('settings')}
                                        className={`px-3 py-1 rounded text-sm flex items-center gap-1 ${
                                            currentView === 'settings' ? 'bg-blue-500 text-white' : 'bg-gray-200'
                                        }`}
                                    >
                                        <IconComponents.Settings size={14} />
                                        è¨­å®š
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* æ‰¹é‡ä¸Šå‚³é€²åº¦æ¢ */}
                        {uploadProgress.isUploading && (
                            <div className="bg-white rounded-lg shadow p-4 mb-4">
                                <div className="flex justify-between items-center mb-2">
                                    <span className="text-sm font-medium">æ‰¹é‡ä¸Šå‚³é€²åº¦</span>
                                    <span className="text-sm text-gray-600">
                                        {uploadProgress.current} / {uploadProgress.total}
                                    </span>
                                </div>
                                <div className="upload-progress">
                                    <div 
                                        className="upload-progress-bar" 
                                        style={{ 
                                            width: `${(uploadProgress.current / uploadProgress.total) * 100}%` 
                                        }}
                                    ></div>
                                </div>
                                <div className="text-xs text-gray-500 mt-1">
                                    æ­£åœ¨ä¸Šå‚³ç¬¬ {uploadProgress.current} ç­†è¨˜éŒ„...
                                </div>
                            </div>
                        )}

                        {/* ä¸»è¦å…§å®¹å€ */}
                        {currentView === 'record' && (
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
                                <BattleForm
                                    formData={formData}
                                    onInputChange={handleInputChange}
                                    onSubmit={handleSubmit}
                                    characterOptions={characterOptions}
                                    teamSuggestions={teamSuggestions}
                                    counterSuggestions={counterSuggestions}
                                    onApplySuggestion={applySuggestion}
                                    onUploadSingle={handleUploadSingle}
                                    communitySettings={communitySettings}
                                />

                                <div className="space-y-4">
                                    <StatsComponents.StatsDashboard
                                        stats={stats}
                                        onExportData={() => Utils.exportData({
                                            battleRecords,
                                            characterAliases,
                                            counterDatabase,
                                            communitySettings
                                        })}
                                        onBatchUpload={uploadAllToCommunity}
                                        communitySettings={communitySettings}
                                        battleRecords={battleRecords}
                                    />
                                </div>
                            </div>
                        )}

                        {currentView === 'history' && (
                            <HistoryTable
                                records={battleRecords}
                                onAddToCounter={addToCounterDatabase}
                                onUploadRecord={uploadToCommunity}
                                onDeleteRecord={deleteRecord}
                                onDeleteBatchByDate={deleteBatchByDate}
                                onResetData={resetData}
                                onImportData={importData}
                                communitySettings={communitySettings}
                                sortBy={sortBy}
                                onSortChange={setSortBy}
                                characterOptions={characterOptions}
                                convertAlias={convertAlias}
                                // æ–°å¢é€™å…©è¡Œ
                                onSetFormData={setFormData}
                                onSetCurrentView={setCurrentView}
                            />
                        )}

                        {currentView === 'settings' && (
                            <div className="space-y-4">
                                {/* Google Sheets åŒæ­¥è¨­å®š */}
                                <div className="bg-white rounded-lg shadow-lg p-4">
                                    <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <IconComponents.Shield className="text-purple-500" size={20} />
                                        Google Sheets åŒæ­¥
                                    </h2>
                                    
                                    <div className="space-y-4">
                                        <div className="p-4 bg-purple-50 rounded-lg">
                                            <h3 className="font-medium text-purple-800 mb-2">ğŸ›¡ï¸ åŠŸèƒ½ç‰¹è‰²</h3>
                                            <div className="text-sm text-purple-700 space-y-2">
                                                <div>ğŸ”’ <strong>URLé©—è­‰</strong>ï¼šåªå…è¨±GoogleåŸŸå</div>
                                                <div>ğŸ§¹ <strong>è³‡æ–™æ¸…ç†</strong>ï¼šä¸Šå‚³å‰è‡ªå‹•æ¸…ç†æ‰€æœ‰è¼¸å…¥</div>
                                                <div>ğŸ” <strong>ç§äººåŒæ­¥</strong>ï¼šæ¯å€‹ç”¨æˆ¶ä½¿ç”¨ç¨ç«‹çš„API URL</div>
                                                <div>âš¡ <strong>ä¸€éµæ‰¹é‡</strong>ï¼šå„ªåŒ–çš„æ‰¹é‡ä¸Šå‚³é«”é©—</div>
                                            </div>
                                        </div>

                                        <div className="border rounded-lg p-4">
                                            <div className="flex items-center gap-3 mb-3">
                                                <label className="flex items-center cursor-pointer">
                                                    <input
                                                        type="checkbox"
                                                        checked={communitySettings.enabled}
                                                        onChange={(e) => setCommunitySettings(prev => ({
                                                            ...prev,
                                                            enabled: e.target.checked
                                                        }))}
                                                        className="mr-2"
                                                    />
                                                    <span className="font-medium">å•Ÿç”¨Google SheetsåŒæ­¥</span>
                                                </label>
                                            </div>

                                            {communitySettings.enabled && (
                                                <div className="space-y-3">
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                                            æ‚¨çš„ç§äººGoogle Apps Script URL:
                                                        </label>
                                                        <input
                                                            type="url"
                                                            value={communitySettings.apiUrl}
                                                            onChange={(e) => {
                                                                const url = SecurityUtils.cleanInput(e.target.value);
                                                                if (url && !SecurityUtils.validateGoogleSheetsUrl(url)) {
                                                                    alert('âš ï¸ è«‹è¼¸å…¥æœ‰æ•ˆçš„Google Apps Script URL');
                                                                    return;
                                                                }
                                                                setCommunitySettings(prev => ({
                                                                    ...prev,
                                                                    apiUrl: url
                                                                }));
                                                            }}
                                                            placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec"
                                                            className="w-full text-sm border rounded px-3 py-2 focus:ring-1 focus:ring-purple-500"
                                                        />
                                                        <div className="text-xs text-gray-500 mt-1">
                                                            ç³»çµ±æœƒè‡ªå‹•é©—è­‰URL
                                                        </div>
                                                    </div>

                                                    <div className="flex gap-2">
                                                        <button
                                                            onClick={() => {
                                                                if (!communitySettings.apiUrl) {
                                                                    alert('è«‹å…ˆè¼¸å…¥API URL');
                                                                    return;
                                                                }
                                                                
                                                                if (!SecurityUtils.validateGoogleSheetsUrl(communitySettings.apiUrl)) {
                                                                    alert('âŒ URLé©—è­‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ‚¨çš„Google Sheetsè¨­å®š');
                                                                    return;
                                                                }
                                                                
                                                                const testRecord = {
                                                                    recorder: 'æ¸¬è©¦ç”¨æˆ¶',
                                                                    date: new Date().toLocaleDateString('zh-TW'),
                                                                    opponentTeam: ['æ¸¬è©¦è§’è‰²1', 'æ¸¬è©¦è§’è‰²2', '', ''],
                                                                    myTeam: ['æ¸¬è©¦è§’è‰²3', 'æ¸¬è©¦è§’è‰²4', '', ''],
                                                                    result: 'å‹',
                                                                    rank: 'æ¸¬è©¦æ’ä½',
                                                                    opponentName: 'æ¸¬è©¦å°æ‰‹',
                                                                    notes: `v2.5.3æ¸¬è©¦ - ${new Date().toLocaleString('zh-TW')}`
                                                                };
                                                                uploadToCommunity(testRecord);
                                                                alert('æ¸¬è©¦ä¸Šå‚³å®Œæˆï¼è«‹åˆ°æ‚¨çš„ç§äººGoogle Sheetsç¢ºèª');
                                                            }}
                                                            className="px-3 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600"
                                                        >
                                                            æ¸¬è©¦é€£æ¥
                                                        </button>
                                                        
                                                        <button
                                                            onClick={() => window.open('https://docs.google.com/', '_blank')}
                                                            className="px-3 py-1 text-xs bg-green-500 text-white rounded hover:bg-green-600"
                                                        >
                                                            é–‹å•ŸGoogle Sheets
                                                        </button>
                                                        
                                                        <button
                                                            onClick={() => {
                                                                alert('æé†’ï¼š\n\n1. åªèˆ‡ä¿¡ä»»çš„äººåˆ†äº«æ‚¨çš„Google Sheets\n2. å®šæœŸæª¢æŸ¥è³‡æ–™æ˜¯å¦æ­£ç¢º\n3. å¦‚ç™¼ç¾ç•°å¸¸è«‹ç«‹å³åœç”¨åŒæ­¥\n4. å»ºè­°ä½¿ç”¨å°ˆç”¨çš„Googleå¸³æˆ¶');
                                                            }}
                                                            className="px-3 py-1 text-xs bg-yellow-500 text-white rounded hover:bg-yellow-600"
                                                        >
                                                            ä½¿ç”¨æé†’
                                                        </button>
                                                    </div>

                                                    {communitySettings.lastSync && (
                                                        <div className="text-xs text-gray-500">
                                                            æœ€å¾ŒåŒæ­¥: {new Date(communitySettings.lastSync).toLocaleString('zh-TW', { 
                                                                month: 'numeric', 
                                                                day: 'numeric', 
                                                                hour: '2-digit', 
                                                                minute: '2-digit' 
                                                            })}
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                {/* è³‡æ–™å‚™ä»½èˆ‡åŒ¯å…¥ */}
                                <div className="bg-white rounded-lg shadow-lg p-4">
                                    <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <IconComponents.Shield className="text-blue-500" size={20} />
                                        è³‡æ–™ç®¡ç†
                                    </h2>
                                    
                                    <div className="space-y-4">
                                        <div className="p-4 bg-blue-50 rounded-lg">
                                            <h3 className="font-medium text-blue-800 mb-2">âœ… è³‡æ–™ä¿è­·</h3>
                                            <div className="text-sm text-blue-700 space-y-1">
                                                <div>ğŸ” è³‡æ–™å·²åŠ å¯†æ··æ·†å­˜å„²åœ¨ç€è¦½å™¨ä¸­</div>
                                                <div>ğŸ›¡ï¸ åŒ¯å…¥æ™‚è‡ªå‹•æ¸…ç†æƒ¡æ„å…§å®¹</div>
                                                <div>ğŸ·ï¸ å‚™ä»½åŒ…å«é©—è­‰æ¨™è¨˜</div>
                                                <div>ğŸ“„ å»ºè­°å®šæœŸå‚™ä»½é‡è¦è³‡æ–™</div>
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-1 gap-2">
                                            <button
                                                onClick={() => Utils.exportData({
                                                    battleRecords,
                                                    characterAliases,
                                                    counterDatabase,
                                                    communitySettings
                                                })}
                                                disabled={battleRecords.length === 0}
                                                className={`px-4 py-2 rounded text-sm flex items-center justify-center gap-2 ${
                                                    battleRecords.length === 0
                                                        ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                                        : 'bg-blue-500 text-white hover:bg-blue-600'
                                                }`}
                                            >
                                                <IconComponents.Shield size={16} />
                                                å®Œæ•´å‚™ä»½ (JSON)
                                            </button>
                                            
                                            <button
                                                onClick={() => Utils.exportToCSV(battleRecords)}
                                                disabled={battleRecords.length === 0}
                                                className={`px-4 py-2 rounded text-sm flex items-center justify-center gap-2 ${
                                                    battleRecords.length === 0
                                                        ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                                        : 'bg-green-500 text-white hover:bg-green-600'
                                                }`}
                                            >
                                                <IconComponents.Upload size={16} />
                                                åŒ¯å‡ºCSV
                                            </button>
                                        </div>
                                        
                                        <div className="p-3 bg-yellow-50 rounded-lg">
                                            <div className="text-sm text-yellow-700">
                                                <strong>åŒ¯å…¥èªªæ˜ï¼š</strong><br />
                                                â€¢ åƒ…æ¥å—10MBä»¥ä¸‹çš„JSONæª”æ¡ˆ<br />
                                                â€¢ è‡ªå‹•é©—è­‰å’Œæ¸…ç†å°å…¥è³‡æ–™<br />
                                                â€¢ ä¸æ­£ç¢ºçš„Google Sheets URLæœƒè¢«ç§»é™¤<br />
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* ååˆ¶ç­–ç•¥ç®¡ç† */}
                                <div className="bg-white rounded-lg shadow-lg p-4">
                                    <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <IconComponents.Target className="text-purple-500" size={20} />
                                        ğŸ¯ ååˆ¶ç­–ç•¥ç®¡ç†
                                    </h2>
                                    
                                    <div className="space-y-4">
                                        <div className="p-4 bg-purple-50 rounded-lg">
                                            <h3 className="font-medium text-purple-800 mb-2">ğŸ›¡ï¸ ç­–ç•¥è³‡æ–™åº«</h3>
                                            <div className="text-sm text-purple-700 space-y-1">
                                                <div>ğŸ“š ç›®å‰å…±æœ‰ {Object.keys(counterDatabase).length} çµ„ç­–ç•¥</div>
                                                <div>ğŸ¯ <strong>åŒ¹é…å„ªå…ˆç´šï¼š</strong></div>
                                                <ol className="ml-4 space-y-1 text-xs">
                                                    <li>1ï¸âƒ£ <strong>å®Œå…¨åŒ¹é…</strong> - 4å€‹è§’è‰²å®Œå…¨ç›¸åŒï¼ˆæœ€æº–ç¢ºï¼‰</li>
                                                    <li>2ï¸âƒ£ <strong>é«˜åº¦åŒ¹é…</strong> - 3å€‹è§’è‰²ç›¸åŒï¼ˆé«˜å¯ä¿¡åº¦ï¼‰</li>
                                                    <li>3ï¸âƒ£ <strong>é€šç”¨å»ºè­°</strong> - è¬èƒ½çµ„åˆï¼ˆä¿åº•æ–¹æ¡ˆï¼‰</li>
                                                </ol>
                                            </div>
                                        </div>

                                        {/* æ‰‹å‹•æ–°å¢ååˆ¶ç­–ç•¥ */}
                                        <div className="border-2 border-dashed border-blue-300 rounded-lg p-4 bg-blue-50">
                                            <h4 className="font-medium text-blue-800 mb-3 flex items-center gap-2">
                                                <IconComponents.Shield size={16} />
                                                æ–°å¢ååˆ¶ç­–ç•¥
                                            </h4>
                                            
                                            <div className="space-y-3">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">å°æ‰‹é™£å®¹:</label>
                                                    <div className="grid grid-cols-4 gap-2">
                                                        {[0, 1, 2, 3].map((idx) => (
                                                            <input
                                                                key={idx}
                                                                type="text"
                                                                placeholder={`å°æ‰‹${idx + 1}`}
                                                                className="text-sm border rounded px-2 py-1 focus:ring-1 focus:ring-blue-500"
                                                                list={`manual-opponent-${idx}-options`}
                                                                id={`manualOpponent${idx}`}
                                                                maxLength="20"
                                                                onChange={(e) => {
                                                                    e.target.value = SecurityUtils.cleanInput(e.target.value);
                                                                }}
                                                            />
                                                        ))}
                                                        {[0, 1, 2, 3].map((idx) => (
                                                            <datalist key={idx} id={`manual-opponent-${idx}-options`}>
                                                                {characterOptions.map(option => (
                                                                    <option key={option} value={option} />
                                                                ))}
                                                            </datalist>
                                                        ))}
                                                    </div>
                                                </div>

                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">ååˆ¶é™£å®¹:</label>
                                                    <div className="grid grid-cols-4 gap-2">
                                                        {[0, 1, 2, 3].map((idx) => (
                                                            <input
                                                                key={idx}
                                                                type="text"
                                                                placeholder={`ååˆ¶${idx + 1}`}
                                                                className="text-sm border rounded px-2 py-1 focus:ring-1 focus:ring-blue-500"
                                                                list={`manual-counter-${idx}-options`}
                                                                id={`manualCounter${idx}`}
                                                                maxLength="20"
                                                                onChange={(e) => {
                                                                    e.target.value = SecurityUtils.cleanInput(e.target.value);
                                                                }}
                                                            />
                                                        ))}
                                                        {[0, 1, 2, 3].map((idx) => (
                                                            <datalist key={idx} id={`manual-counter-${idx}-options`}>
                                                                {characterOptions.map(option => (
                                                                    <option key={option} value={option} />
                                                                ))}
                                                            </datalist>
                                                        ))}
                                                    </div>
                                                </div>

                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">ç­–ç•¥å‚™è¨»:</label>
                                                    <input
                                                        type="text"
                                                        placeholder="ç­–ç•¥èªªæ˜ã€ä½¿ç”¨å¿ƒå¾—ç­‰..."
                                                        className="w-full text-sm border rounded px-2 py-1 focus:ring-1 focus:ring-blue-500"
                                                        id="manualNotes"
                                                        maxLength="200"
                                                        onChange={(e) => {
                                                            e.target.value = SecurityUtils.cleanInput(e.target.value, true);
                                                        }}
                                                    />
                                                </div>

                                                <button
                                                    onClick={() => {
                                                        // å–å¾—è¼¸å…¥çš„å°æ‰‹é™£å®¹
                                                        const opponentTeam = [0, 1, 2, 3].map(i => {
                                                            const element = document.getElementById(`manualOpponent${i}`);
                                                            return convertAlias(SecurityUtils.cleanInput(element.value.trim()));
                                                        }).filter(char => char);

                                                        // å–å¾—è¼¸å…¥çš„ååˆ¶é™£å®¹
                                                        const counterTeam = [0, 1, 2, 3].map(i => {
                                                            const element = document.getElementById(`manualCounter${i}`);
                                                            return convertAlias(SecurityUtils.cleanInput(element.value.trim()));
                                                        }).filter(char => char);

                                                        // å–å¾—ç­–ç•¥å‚™è¨»
                                                        const notes = SecurityUtils.cleanInput(document.getElementById('manualNotes').value.trim(), true);

                                                        // é©—è­‰è¼¸å…¥
                                                        if (opponentTeam.length < 3) {
                                                            alert('è«‹è‡³å°‘è¼¸å…¥3å€‹å°æ‰‹è§’è‰²');
                                                            return;
                                                        }

                                                        if (counterTeam.length < 3) {
                                                            alert('è«‹è‡³å°‘è¼¸å…¥3å€‹ååˆ¶è§’è‰²');
                                                            return;
                                                        }

                                                        // ç”Ÿæˆç­–ç•¥éµå€¼
                                                        const key = opponentTeam.sort().join(',');

                                                        // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
                                                        if (counterDatabase[key]) {
                                                            if (!confirm(`å·²å­˜åœ¨é‡å°ã€Œ${opponentTeam.join('+')}ã€çš„ååˆ¶ç­–ç•¥ï¼Œæ˜¯å¦è¦†è“‹ï¼Ÿ`)) {
                                                                return;
                                                            }
                                                        }

                                                        // æ·»åŠ åˆ°ååˆ¶è³‡æ–™åº«
                                                        const strategy = {
                                                            combo: counterTeam,
                                                            notes: notes || 'æ‰‹å‹•æ–°å¢ç­–ç•¥'
                                                        };

                                                        setCounterDatabase(prev => ({
                                                            ...prev,
                                                            [key]: [strategy]
                                                        }));

                                                        // æ¸…ç©ºè¼¸å…¥æ¬„ä½
                                                        [0, 1, 2, 3].forEach(i => {
                                                            document.getElementById(`manualOpponent${i}`).value = '';
                                                            document.getElementById(`manualCounter${i}`).value = '';
                                                        });
                                                        document.getElementById('manualNotes').value = '';

                                                        alert(`âœ… ååˆ¶ç­–ç•¥å·²æ–°å¢ï¼\nå°æ‰‹ï¼š${opponentTeam.join('+')}\nååˆ¶ï¼š${counterTeam.join('+')}`);
                                                    }}
                                                    className="w-full bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 font-medium flex items-center justify-center gap-2"
                                                >
                                                    <IconComponents.Shield size={16} />
                                                    æ–°å¢ç­–ç•¥
                                                </button>
                                            </div>
                                        </div>

                                        {/* ç¾æœ‰ç­–ç•¥åˆ—è¡¨ */}
                                        <div>
                                            <h4 className="font-medium text-gray-800 mb-2 flex items-center gap-2">
                                                <IconComponents.Shield size={16} className="text-green-500" />
                                                ç­–ç•¥åˆ—è¡¨:
                                            </h4>
                                            <div className="space-y-3 max-h-64 overflow-y-auto">
                                                {Object.entries(counterDatabase).map(([key, strategies], idx) => (
                                                    <div key={idx} className="border rounded-lg p-3 bg-gray-50">
                                                        <div className="flex justify-between items-start mb-2">
                                                            <div className="flex-1">
                                                                <div className="text-sm font-medium text-gray-700 mb-1">
                                                                    å°æ‰‹é™£å®¹: {key.split(',').join(' + ')}
                                                                </div>
                                                                {strategies.map((strategy, strategyIdx) => (
                                                                    <div key={strategyIdx} className="text-xs text-gray-600 mb-1">
                                                                        ååˆ¶: {strategy.combo.filter(c => c).join(' + ')}
                                                                        {strategy.notes && (
                                                                            <span className="text-purple-600 ml-2">
                                                                                ({SecurityUtils.sanitizeHtml(strategy.notes)})
                                                                            </span>
                                                                        )}
                                                                    </div>
                                                                ))}
                                                            </div>
                                                            <button
                                                                onClick={() => {
                                                                    if (confirm(`ç¢ºå®šè¦åˆªé™¤é‡å°ã€Œ${key.split(',').join('+')}ã€çš„ååˆ¶ç­–ç•¥å—ï¼Ÿ`)) {
                                                                        const newDatabase = { ...counterDatabase };
                                                                        delete newDatabase[key];
                                                                        setCounterDatabase(newDatabase);
                                                                    }
                                                                }}
                                                                className="text-red-500 hover:text-red-700 text-xs ml-2"
                                                            >
                                                                åˆªé™¤
                                                            </button>
                                                        </div>
                                                    </div>
                                                ))}

                                                {Object.keys(counterDatabase).length === 0 && (
                                                    <div className="text-center py-8 text-gray-500">
                                                        <IconComponents.Shield size={48} className="mx-auto mb-4 text-gray-300" />
                                                        <p className="mb-2">ğŸ” é‚„æ²’æœ‰ä»»ä½•ååˆ¶ç­–ç•¥</p>
                                                        <p className="text-sm">å¯ä»¥é€éä¸Šæ–¹è¡¨å–®æ‰‹å‹•æ–°å¢ï¼Œæˆ–åœ¨æ­·å²ç´€éŒ„ä¸­é»æ“Šã€ŒğŸ¯ç­–ç•¥ã€æŒ‰éˆ•</p>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* è§’è‰²åˆ¥ç¨±è¨­å®š */}
                                <div className="bg-white rounded-lg shadow-lg p-4">
                                    <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <IconComponents.Shield className="text-indigo-500" size={20} />
                                        è§’è‰²åˆ¥ç¨±è¨­å®š
                                    </h2>
                                    
                                    <div className="mb-4 p-3 bg-indigo-50 rounded-lg">
                                        <div className="text-sm text-indigo-700">
                                            <strong>ä¿è­·ï¼š</strong> æ‰€æœ‰è§’è‰²åç¨±å’Œåˆ¥ç¨±æœƒè‡ªå‹•æ¸…ç†ï¼Œé˜²æ­¢XSSæ”»æ“Š
                                        </div>
                                    </div>
                                    
                                    <div className="space-y-3 max-h-96 overflow-y-auto">
                                        {characterAliases.map((character, idx) => (
                                            <div key={idx} className="border rounded-lg p-3">
                                                <div className="flex gap-3 items-center mb-2">
                                                    <label className="text-sm font-medium text-gray-700 w-16">æ­£å¼åç¨±:</label>
                                                    <input
                                                        type="text"
                                                        placeholder="è§’è‰²æ­£å¼åç¨±"
                                                        value={character.name}
                                                        onChange={(e) => {
                                                            const cleanName = SecurityUtils.cleanInput(e.target.value);
                                                            const newAliases = [...characterAliases];
                                                            newAliases[idx].name = cleanName;
                                                            setCharacterAliases(newAliases);
                                                        }}
                                                        className="flex-1 text-sm border rounded px-2 py-1"
                                                        maxLength="30"
                                                    />
                                                    <button
                                                        onClick={() => {
                                                            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è§’è‰²å—ï¼Ÿ')) {
                                                                const newAliases = [...characterAliases];
                                                                newAliases.splice(idx, 1);
                                                                setCharacterAliases(newAliases);
                                                            }
                                                        }}
                                                        className="text-red-500 hover:text-red-700 text-sm"
                                                    >
                                                        åˆªé™¤
                                                    </button>
                                                </div>
                                                
                                                <div>
                                                    <label className="text-sm font-medium text-gray-700 block mb-1">åˆ¥ç¨±/ç°¡ç¨±:</label>
                                                    <div className="flex flex-wrap gap-1">
                                                        {character.aliases.map((alias, aliasIdx) => (
                                                            <div key={aliasIdx} className="flex items-center gap-1">
                                                                <input
                                                                    type="text"
                                                                    value={alias}
                                                                    onChange={(e) => {
                                                                        const cleanAlias = SecurityUtils.cleanInput(e.target.value);
                                                                        const newAliases = [...characterAliases];
                                                                        newAliases[idx].aliases[aliasIdx] = cleanAlias;
                                                                        setCharacterAliases(newAliases);
                                                                    }}
                                                                    className="border rounded px-1 py-0.5 text-xs w-16"
                                                                    placeholder="åˆ¥ç¨±"
                                                                    maxLength="20"
                                                                />
                                                                <button
                                                                    onClick={() => {
                                                                        const newAliases = [...characterAliases];
                                                                        newAliases[idx].aliases.splice(aliasIdx, 1);
                                                                        setCharacterAliases(newAliases);
                                                                    }}
                                                                    className="text-red-500 hover:text-red-700 text-xs"
                                                                    title="åˆªé™¤æ­¤åˆ¥ç¨±"
                                                                >
                                                                    Ã—
                                                                </button>
                                                            </div>
                                                        ))}
                                                        <button
                                                            onClick={() => {
                                                                const newAliases = [...characterAliases];
                                                                newAliases[idx].aliases.push('');
                                                                setCharacterAliases(newAliases);
                                                            }}
                                                            className="bg-gray-100 hover:bg-gray-200 px-2 py-0.5 rounded text-xs"
                                                        >
                                                            + åˆ¥ç¨±
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                        
                                        <button
                                            onClick={() => setCharacterAliases([...characterAliases, { name: '', aliases: [''] }])}
                                            className="w-full border-2 border-dashed border-gray-300 rounded-lg py-3 text-gray-500 hover:border-gray-400 text-sm flex items-center justify-center gap-2"
                                        >
                                            <IconComponents.Shield size={16} />
                                            æ–°å¢è§’è‰²
                                        </button>
                                    </div>
                                </div>

                                {/* ç›¸é—œå·¥å…· */}
                                <div className="bg-white rounded-lg shadow-lg p-4 mb-4">
                                    <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <IconComponents.FileText className="text-blue-500" size={20} />
                                        ç›¸é—œå·¥å…·
                                    </h2>
                                    
                                    <div className="space-y-3">
                                        <div className="p-4 bg-blue-50 rounded-lg">
                                            <h3 className="font-medium text-blue-800 mb-2">ğŸ” è§’è‰²è³‡æ–™åº«</h3>
                                            <div className="text-sm text-blue-700 space-y-2">
                                                <p>å®Œæ•´çš„è§’è‰²æŸ¥è©¢ç³»çµ±ï¼ŒåŒ…å«:</p>
                                                <ul className="ml-4 space-y-1 text-xs">
                                                    <li>â€¢ ä¸­è‹±æ–‡è§’è‰²åç¨±å°ç…§</li>
                                                    <li>â€¢ å±¬æ€§ã€è·æ¥­åˆ†é¡ç¯©é¸</li>
                                                    <li>â€¢ è§’è‰²æš±ç¨±æœå°‹åŠŸèƒ½</li>
                                                    <li>â€¢ æœªä¾†å°‡æ•´åˆTAGåŸ¹é¤Šç³»çµ±</li>
                                                </ul>
                                            </div>
                                            <div className="mt-3">
                                                <a 
                                                    href="character-db.html"
                                                    className="inline-flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm"
                                                >
                                                    <IconComponents.FileText size={16} />
                                                    å‰å¾€è§’è‰²è³‡æ–™åº«
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* ç‰ˆæœ¬èªªæ˜ */}
                                <div className="bg-white rounded-lg shadow-lg p-4">
                                    <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <IconComponents.Shield className="text-green-500" size={20} />
                                        v2.5.3 æ›´æ–°èªªæ˜
                                    </h2>
                                    
                                    <div className="space-y-3">
                                        <div className="p-3 bg-green-50 rounded-lg">
                                            <h4 className="font-medium text-green-800 mb-2">ğŸ”§ v2.5.3 æ–°åŠŸèƒ½èˆ‡å„ªåŒ–</h4>
                                            <ul className="text-sm text-green-700 space-y-1">
                                                <li>â€¢ <strong>åŠ å¿«æœå°‹å¾Œç´€éŒ„æ­¥é©Ÿ</strong>ï¼šå„ªåŒ–æœç´¢åŠŸèƒ½ï¼Œæå‡è¨˜éŒ„æ•ˆç‡</li>
                                                <li>â€¢ <strong>è§’è‰²è³‡æ–™åº«é€£çµ</strong>ï¼šæ–°å¢ç›¸é—œå·¥å…·å€å¡Šï¼Œå¿«é€Ÿé€£çµè§’è‰²è³‡æ–™åº«</li>
                                                <li>â€¢ <strong>æ—¥æœŸæ‰¹æ¬¡åˆªé™¤</strong>ï¼šå¾—ä»¥é¸æ“‡æ—¥æœŸæ‰¹æ¬¡åˆªé™¤è©²æ—¥æœŸå‰(ä¸å«)ä¹‹ç´€éŒ„</li>
                                                <li>â€¢ <strong>æ­·å²æœç´¢æ–°åŠŸèƒ½</strong>ï¼šè¼¸å…¥å°æ‰‹é™£å®¹å¿«é€Ÿæ‰¾åˆ°ç›¸é—œè¨˜éŒ„å’Œæˆ‘æ–¹å‹å ´ç­–ç•¥</li>
                                                <li>â€¢ <strong>åŒ¹é…ç³»çµ±</strong>ï¼šè‡ªå‹•é¡¯ç¤ºå®Œå…¨/é«˜åº¦åŒ¹é…è¨˜éŒ„ï¼Œé«˜äº®åŒ¹é…è§’è‰²</li>
                                                <li>â€¢ <strong>åˆ¥åç·©å­˜ç³»çµ±</strong>ï¼šé è¨ˆç®—è§’è‰²åˆ¥åè½‰æ›ï¼Œå¤§å¹…æå‡æœç´¢é€Ÿåº¦</li>
                                                <li>â€¢ <strong>å‹å ´ç­–ç•¥æ¨è–¦</strong>ï¼šåŸºæ–¼æ­·å²å‹å ´è¨˜éŒ„æ¨è–¦æœ€é©æˆ‘æ–¹é™£å®¹</li>
                                                <li>â€¢ <strong>è¦–è¦ºåŒ–å¢å¼·</strong>ï¼šæœç´¢æ¨¡å¼ä¸‹ä¸åŒåŒ¹é…ç­‰ç´šç”¨ä¸åŒèƒŒæ™¯è‰²å€åˆ†</li>
                                            </ul>
                                        </div>
                                        
                                        <div className="p-3 bg-purple-50 rounded-lg">
                                            <h4 className="font-medium text-purple-800 mb-2">ğŸ¯ æŒçºŒåŠŸèƒ½ï¼šé€Ÿåº¦è¨ˆç®—å™¨ & æ­·å²æœç´¢</h4>
                                            <ul className="text-sm text-purple-700 space-y-1">
                                                <li>â€¢ <strong>é€Ÿåº¦è¨ˆç®—</strong>ï¼šæ ¹æ“šæˆ‘æ–¹åƒè€ƒæ•¸æ“šè¨ˆç®—å°æ‰‹è§’è‰²é€Ÿåº¦</li>
                                                <li>â€¢ <strong>å¯é¸åŠŸèƒ½</strong>ï¼šåœ¨è¨˜éŒ„é é¢é»æ“Šã€Œé€Ÿåº¦è¨ˆç®—å™¨ã€æŒ‰éˆ•é–‹å•Ÿ</li>
                                                <li>â€¢ <strong>ç²¾ç¢ºè¨ˆç®—</strong>ï¼šæ”¯æ´å·²çŸ¥éš¨æ©Ÿå€¼çš„ç²¾ç¢ºé€Ÿåº¦è¨ˆç®—</li>
                                                <li>â€¢ <strong>ç¯„åœä¼°ç®—</strong>ï¼šæœªçŸ¥éš¨æ©Ÿå€¼æ™‚æä¾›é€Ÿåº¦ç¯„åœä¼°ç®—</li>
                                                <li>â€¢ <strong>æ­·å²æœç´¢æ–°åŠŸèƒ½</strong>ï¼šè¼¸å…¥3-4å€‹å°æ‰‹è§’è‰²ï¼Œç«‹å³æ‰¾åˆ°ç›¸é—œæ­·å²è¨˜éŒ„</li>
                                                <li>â€¢ <strong>æ™ºèƒ½åŒ¹é…</strong>ï¼šè‡ªå‹•é¡¯ç¤ºå®Œå…¨/é«˜åº¦åŒ¹é…è¨˜éŒ„ï¼Œé«˜äº®åŒ¹é…è§’è‰²</li>
                                                <li>â€¢ <strong>å‹å ´ç­–ç•¥æ¨è–¦</strong>ï¼šåŸºæ–¼æ­·å²å‹å ´è¨˜éŒ„æ¨è–¦æœ€é©æˆ‘æ–¹é™£å®¹</li>
                                            </ul>
                                        </div>
                                        
                                        <div className="p-3 bg-blue-50 rounded-lg">
                                            <h4 className="font-medium text-blue-800 mb-2">ğŸ›¡ï¸ å®‰å…¨é˜²è­·</h4>
                                            <ul className="text-sm text-blue-700 space-y-1">
                                                <li>â€¢ <strong>XSSé˜²è­·</strong>ï¼šæ‰€æœ‰è¼¸å…¥è‡ªå‹•æ¸…ç†HTMLæ¨™ç±¤å’Œè…³æœ¬</li>
                                                <li>â€¢ <strong>è³‡æ–™æ··æ·†</strong>ï¼šæœ¬åœ°å­˜å„²æ•¸æ“šæ¡ç”¨Base64ç·¨ç¢¼</li>
                                                <li>â€¢ <strong>URLé©—è­‰</strong>ï¼šGoogle SheetsåŒæ­¥åƒ…å…è¨±å®˜æ–¹åŸŸå</li>
                                            </ul>
                                        </div>
                                        
                                        <div className="p-3 bg-yellow-50 rounded-lg">
                                            <h4 className="font-medium text-yellow-800 mb-2">ğŸ“ æŠ€è¡“è³‡è¨Š</h4>
                                            <div className="text-sm text-yellow-700 space-y-1">
                                                <div>â€¢ <strong>ç‰ˆæœ¬</strong>ï¼šv2.5.3</div>
                                                <div>â€¢ <strong>ç™¼å¸ƒæ—¥æœŸ</strong>ï¼š{new Date().toLocaleDateString('zh-TW')}</div>
                                                <div>â€¢ <strong>å®‰å…¨ç­‰ç´š</strong>ï¼šé«˜åº¦ ğŸ›¡ï¸</div>
                                                <div>â€¢ <strong>é©ç”¨ç’°å¢ƒ</strong>ï¼šé›¢ç·šä½¿ç”¨ï¼Œç§äººéƒ¨ç½²</div>
                                                <div>â€¢ <strong>é–‹ç™¼è€…</strong>ï¼šzzas</div>
                                                <div>â€¢ <strong>ä¸»è¦æ”¹é€²</strong>ï¼šåŠ å¿«æœå°‹å¾Œç´€éŒ„æ­¥é©Ÿï¼Œæ–°å¢è§’è‰²è³‡æ–™åº«é€£çµ</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        <div className="mt-4 text-center text-xs text-gray-500">
                            ArkRecode å°æˆ°ç´€éŒ„å™¨ v2.5.3 | é›¢ç·šä½¿ç”¨ | æ­·å²æœç´¢åŠŸèƒ½ + ç­–ç•¥æ¨è–¦
                        </div>
                    </div>
                </div>
            );
        };

        // åˆå§‹åŒ–æ‡‰ç”¨
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
