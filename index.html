<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArkRecode 對戰紀錄器 v2.5.3</title>
    
    <!-- 內容安全政策 -->
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'self'; 
                   script-src 'self' https://unpkg.com https://cdn.tailwindcss.com 'unsafe-inline' 'unsafe-eval'; 
                   connect-src 'self' https://script.google.com https://script.googleapis.com;
                   style-src 'self' https://cdn.tailwindcss.com 'unsafe-inline';">
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel Standalone for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* 自訂義Lucide圖標 */
        .lucide-icon {
            display: inline-block;
            width: 1em;
            height: 1em;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        /* 備註欄位tooltip樣式 */
        .notes-cell {
            position: relative;
            cursor: help;
        }
        
        .notes-cell .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1f2937;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 1000;
            max-width: 200px;
            white-space: pre-wrap;
            word-wrap: break-word;
            text-align: center;
        }
        
        .notes-cell .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #1f2937;
        }
        
        .notes-cell:hover .tooltip {
            opacity: 1;
            visibility: visible;
        }
        
        /* 作者信息樣式 */
        .author-info {
            position: fixed;
            bottom: 4px;
            right: 4px;
            font-size: 8px;
            color: #9ca3af;
            opacity: 0.3;
            z-index: 10;
        }

        /* 批量上傳進度條 */
        .upload-progress {
            width: 100%;
            height: 4px;
            background-color: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .upload-progress-bar {
            height: 100%;
            background-color: #3b82f6;
            transition: width 0.3s ease;
        }

        /* 免責聲明樣式 */
        .disclaimer-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .disclaimer-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 24px;
            margin: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        
        .disclaimer-content h2 {
            color: #dc2626;
            border-bottom: 2px solid #fecaca;
            padding-bottom: 8px;
            margin-bottom: 16px;
        }
        
        .disclaimer-section {
            margin-bottom: 20px;
            padding: 12px;
            border-left: 4px solid #3b82f6;
            background-color: #f8fafc;
        }
        
        .warning-section {
            border-left-color: #f59e0b;
            background-color: #fffbeb;
        }
        
        .danger-section {
            border-left-color: #dc2626;
            background-color: #fef2f2;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <!-- 作者資訊 -->
    <div class="author-info">by zzas | v2.5.3</div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useCallback } = React;

        // ==================== 工具函數 ====================
        const SecurityUtils = {
            // 基本輸入清理 - 用於實時輸入，備註欄位允許空白
            cleanInput: (input, allowSpaces = false) => {
                if (typeof input !== 'string') return input;
                let cleaned = input
                    .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '') // 移除腳本
                    .replace(/<[^>]*>/g, ''); // 移除HTML標籤
                
                if (!allowSpaces) {
                    cleaned = cleaned.trim();
                } else {
                    // 備註欄位：允許空白但限制連續空白最多1個
                    cleaned = cleaned.replace(/\s{2,}/g, ' ');
                }
                
                return cleaned;
            },

            // XSS防護：清理用戶輸入 - 用於存儲和顯示
            sanitizeInput: (input) => {
                if (typeof input !== 'string') return input;
                return input
                    .replace(/&/g, '&amp;')  // 必須先處理 & 符號
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#x27;')
                    .replace(/\//g, '&#x2F;')
                    .trim();
            },

            // 清理HTML內容 - 用於顯示
            sanitizeHtml: (html) => {
                if (typeof html !== 'string') return html;
                return html
                    .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
                    // 解碼常用的HTML實體
                    .replace(/&#x2F;/g, '/')
                    .replace(/&#x27;/g, "'")
                    .replace(/&quot;/g, '"')
                    .replace(/&lt;/g, '<')
                    .replace(/&gt;/g, '>')
                    .replace(/&amp;/g, '&');
            },

            // 驗證Google Sheets URL
            validateGoogleSheetsUrl: (url) => {
                if (!url || typeof url !== 'string') return false;
                
                try {
                    const urlObj = new URL(url);
                    const allowedHosts = [
                        'script.google.com',
                        'script.googleapis.com'
                    ];
                    
                    return allowedHosts.some(host => 
                        urlObj.hostname === host || urlObj.hostname.endsWith('.' + host)
                    );
                } catch {
                    return false;
                }
            },

            // 數據混淆（基礎保護）
            obfuscateData: (data) => {
                try {
                    return btoa(JSON.stringify(data));
                } catch {
                    return JSON.stringify(data);
                }
            },

            deobfuscateData: (data) => {
                try {
                    return JSON.parse(atob(data));
                } catch {
                    try {
                        return JSON.parse(data);
                    } catch {
                        return null;
                    }
                }
            },

            // 檢查瀏覽器存儲支援
            checkStorageSupport: () => {
                try {
                    const testKey = '__storage_test__';
                    localStorage.setItem(testKey, 'test');
                    localStorage.removeItem(testKey);
                    return true;
                } catch {
                    return false;
                }
            }
        };

        // ==================== 免責聲明組件 ====================
        const DisclaimerModal = ({ onAccept, onDecline }) => {
            return (
                <div className="disclaimer-modal">
                    <div className="disclaimer-content">
                        <h2 className="text-xl font-bold text-red-600 mb-4">
                            ⚠️ 使用條款與免責聲明
                        </h2>
                        
                        <div className="disclaimer-section danger-section">
                            <h3 className="font-semibold text-red-700 mb-2">🚨 重要提醒</h3>
                            <ul className="text-sm text-red-600 space-y-1">
                                <li>• 此工具為<strong>離線應用程式</strong>，數據僅存儲在您的瀏覽器本地</li>
                                <li>• Google Sheets同步功能需要您<strong>自行配置API</strong>，不會與他人共享</li>
                                <li>• 請<strong>定期備份</strong>您的對戰記錄，避免數據丟失</li>
                                <li>• 建議在<strong>私人設備</strong>上使用，避免在公用電腦操作</li>
                            </ul>
                        </div>

                        <div className="disclaimer-section warning-section">
                            <h3 className="font-semibold text-amber-700 mb-2">📋 資料處理說明</h3>
                            <ul className="text-sm text-amber-600 space-y-1">
                                <li>• 您的對戰記錄、角色設定等數據僅存於本機瀏覽器</li>
                                <li>• Google Sheets同步為<strong>可選功能</strong>，由您完全控制</li>
                                <li>• 我們<strong>不收集、不存儲、不傳輸</strong>您的任何個人資料</li>
                                <li>• 清除瀏覽器數據將<strong>永久刪除</strong>所有記錄</li>
                            </ul>
                        </div>

                        <div className="disclaimer-section">
                            <h3 className="font-semibold text-blue-700 mb-2">⚖️ 法律免責條款</h3>
                            <div className="text-sm text-gray-600 space-y-2">
                                <p>使用本工具表示您同意以下條款：</p>
                                <ul className="space-y-1 ml-4">
                                    <li>1. 本工具按<strong>「現狀」</strong>提供，不提供任何形式的保證</li>
                                    <li>2. 開發者不對使用本工具造成的<strong>任何損失</strong>承擔責任</li>
                                    <li>3. 用戶應<strong>自行評估</strong>使用風險並採取適當防護措施</li>
                                    <li>4. 對於<strong>第三方服務</strong>（如Google Sheets）的安全性，開發者不承擔責任</li>
                                    <li>5. 本免責聲明受<strong>中華民國法律</strong>管轄</li>
                                </ul>
                            </div>
                        </div>

                        <div className="disclaimer-section">
                            <h3 className="font-semibold text-green-700 mb-2">✅ 建議</h3>
                            <ul className="text-sm text-green-600 space-y-1">
                                <li>• 定期使用「完整備份」功能匯出資料</li>
                                <li>• 僅在信任的網路環境下使用Google Sheets同步</li>
                                <li>• 如發現異常行為，請立即停止使用並清除資料</li>
                                <li>• 建議使用最新版本的現代瀏覽器</li>
                            </ul>
                        </div>

                        <div className="disclaimer-section">
                            <h3 className="font-semibold text-purple-700 mb-2">📞 聯絡資訊</h3>
                            <div className="text-sm text-gray-600">
                                <p>如有問題或建議，歡迎回饋：</p>
                                <ul className="mt-2 space-y-1">
                                    <li>• 開發者：zzas</li>
                                    <li>• 版本：v2.5.3</li>
                                    <li>• 更新日期：{new Date().toLocaleDateString('zh-TW')}</li>
                                </ul>
                            </div>
                        </div>

                        <div className="mt-6 flex gap-4 justify-end">
                            <button
                                onClick={onDecline}
                                className="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors"
                            >
                                不同意，離開
                            </button>
                            <button
                                onClick={onAccept}
                                className="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-semibold"
                            >
                                我已閱讀並同意上述條款
                            </button>
                        </div>
                        
                        <div className="mt-4 text-xs text-gray-500 text-center">
                            點擊「我已閱讀並同意上述條款」即表示您已充分理解並接受所有使用條款與風險
                        </div>
                    </div>
                </div>
            );
        };

        // ==================== 圖標組件 ====================
        const IconComponents = {
            Plus: ({ size = 16, className = "" }) => (
                <svg className={`lucide-icon ${className}`} width={size} height={size} viewBox="0 0 24 24">
                    <path d="M5 12h14M12 5v14"/>
                </svg>
            ),
            Settings: ({ size = 16, className = "" }) => (
                <svg className={`lucide-icon ${className}`} width={size} height={size} viewBox="0 0 24 24">
                    <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                    <circle cx="12" cy="12" r="3"/>
                </svg>
            ),
            Trophy: ({ size = 16, className = "" }) => (
                <svg className={`lucide-icon ${className}`} width={size} height={size} viewBox="0 0 24 24">
                    <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/>
                    <path d="M6 9h12"/>
                    <path d="M19 9v10a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V9"/>
                    <path d="m9 22 3-3 3 3"/>
                    <path d="M9 12h6"/>
                    <path d="M9 15h6"/>
                </svg>
            ),
            FileText: ({ size = 16, className = "" }) => (
                <svg className={`lucide-icon ${className}`} width={size} height={size} viewBox="0 0 24 24">
                    <path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/>
                    <path d="M14 2v4a2 2 0 0 0 2 2h4"/>
                    <path d="M10 9H8"/>
                    <path d="M16 13H8"/>
                    <path d="M16 17H8"/>
                </svg>
            ),
            Upload: ({ size = 16, className = "" }) => (
                <svg className={`lucide-icon ${className}`} width={size} height={size} viewBox="0 0 24 24">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7,10 12,5 17,10"/>
                    <line x1="12" x2="12" y1="5" y2="15"/>
                </svg>
            ),
            Download: ({ size = 16, className = "" }) => (
                <svg className={`lucide-icon ${className}`} width={size} height={size} viewBox="0 0 24 24">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7,10 12,15 17,10"/>
                    <line x1="12" x2="12" y1="15" y2="3"/>
                </svg>
            ),
            Target: ({ size = 16, className = "" }) => (
                <svg className={`lucide-icon ${className}`} width={size} height={size} viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10"/>
                    <circle cx="12" cy="12" r="6"/>
                    <circle cx="12" cy="12" r="2"/>
                </svg>
            ),
            Shield: ({ size = 16, className = "" }) => (
                <svg className={`lucide-icon ${className}`} width={size} height={size} viewBox="0 0 24 24">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                </svg>
            ),
            Calculator: ({ size = 16, className = "" }) => (
                <svg className={`lucide-icon ${className}`} width={size} height={size} viewBox="0 0 24 24">
                    <rect width="16" height="20" x="4" y="2" rx="2"/>
                    <line x1="8" x2="16" y1="6" y2="6"/>
                    <line x1="16" x2="16" y1="14" y2="18"/>
                    <path d="m16 10-4 4-4-4"/>
                </svg>
            ),
            Trash: ({ size = 16, className = "" }) => (
                <svg className={`lucide-icon ${className}`} width={size} height={size} viewBox="0 0 24 24">
                    <path d="M3 6h18"/>
                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                </svg>
            )
        };

        // ==================== 速度計算器組件 ====================
        const SpeedCalculator = React.memo(({ isVisible, onClose }) => {
            const [inputs, setInputs] = useState({
                ally: { speed: "", random: "", initial: "" },
                opponent1: { random: "", initial: "" },
                opponent2: { random: "", initial: "" },
                opponent3: { random: "", initial: "" }
            });
            const [results, setResults] = useState([]);

            const handleInputChange = useCallback((character, field, value) => {
                const cleanValue = SecurityUtils.cleanInput(value);
                setInputs((prev) => ({
                    ...prev,
                    [character]: { ...prev[character], [field]: cleanValue },
                }));
            }, []);

            const calculateOpponentSpeeds = useCallback(() => {
                const { ally, ...opponents } = inputs;
                
                // 檢查基本必填欄位
                if (!ally.speed || !ally.initial) {
                    alert('請填寫我方的速度和初始行動值！');
                    return;
                }
                
                const allySpeed = parseFloat(ally.speed);
                const allyInitial = parseFloat(ally.initial);
                const allyRandom = ally.random === "" ? null : parseFloat(ally.random);
                
                if (isNaN(allySpeed) || isNaN(allyInitial)) {
                    alert('請確認我方數據填寫正確！');
                    return;
                }

                // 計算我方的速度比例範圍
                let allySpeedRatioMin, allySpeedRatioMax;
                
                if (allyRandom !== null) {
                    // 我方隨機值已知，精確計算
                    const allyActualInitial = allyInitial - allyRandom;
                    const allySpeedRatio = allySpeed / allyActualInitial;
                    allySpeedRatioMin = allySpeedRatioMax = allySpeedRatio;
                } else {
                    // 我方隨機值未知，假設0-5範圍
                    const allyActualInitialMin = allyInitial - 5; // 隨機值最大為5
                    const allyActualInitialMax = allyInitial - 0; // 隨機值最小為0
                    allySpeedRatioMin = allySpeed / allyActualInitialMax;
                    allySpeedRatioMax = allySpeed / allyActualInitialMin;
                }

                if (!isFinite(allySpeedRatioMin) || !isFinite(allySpeedRatioMax)) {
                    alert('計算出現錯誤，請檢查我方數據！');
                    return;
                }

                const opponentSpeeds = Object.entries(opponents).map(
                    ([character, data]) => {
                        const opponentInitial = parseFloat(data.initial);
                        if (isNaN(opponentInitial) || !data.initial) {
                            return {
                                character,
                                speedMin: null,
                                speedMax: null,
                                random: data.random,
                                initial: data.initial,
                                position: character.replace('opponent', ''),
                            };
                        }

                        const opponentRandom = data.random === "" ? null : parseFloat(data.random);
                        let speedMin, speedMax;
                        
                        if (opponentRandom !== null) {
                            // 對手隨機值已知
                            const opponentActualInitial = opponentInitial - opponentRandom;
                            speedMin = Math.round(opponentActualInitial * allySpeedRatioMin);
                            speedMax = Math.round(opponentActualInitial * allySpeedRatioMax);
                        } else {
                            // 對手隨機值未知，假設0-5範圍
                            const opponentActualInitialMin = opponentInitial - 5;
                            const opponentActualInitialMax = opponentInitial - 0;
                            speedMin = Math.round(opponentActualInitialMin * allySpeedRatioMin);
                            speedMax = Math.round(opponentActualInitialMax * allySpeedRatioMax);
                        }
                        
                        // 確保最小值不大於最大值
                        if (speedMin > speedMax) {
                            [speedMin, speedMax] = [speedMax, speedMin];
                        }

                        return {
                            character,
                            speedMin,
                            speedMax,
                            random: data.random,
                            initial: data.initial,
                            position: character.replace('opponent', ''),
                        };
                    }
                );

                setResults(opponentSpeeds);
            }, [inputs]);

            const clearInputs = useCallback(() => {
                setInputs({
                    ally: { speed: "", random: "", initial: "" },
                    opponent1: { random: "", initial: "" },
                    opponent2: { random: "", initial: "" },
                    opponent3: { random: "", initial: "" }
                });
                setResults([]);
            }, []);

            if (!isVisible) return null;

            return (
                <div className="bg-white rounded-lg shadow-lg p-4 mt-4 border-2 border-purple-200">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-lg font-semibold flex items-center gap-2">
                            <IconComponents.Calculator size={20} className="text-purple-500" />
                            速度計算器
                        </h3>
                        <div className="flex gap-2">
                            <button
                                onClick={clearInputs}
                                className="px-3 py-1 text-sm bg-gray-500 text-white rounded hover:bg-gray-600"
                            >
                                清空
                            </button>
                            <button
                                onClick={onClose}
                                className="px-3 py-1 text-sm bg-red-500 text-white rounded hover:bg-red-600"
                            >
                                關閉
                            </button>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-4 gap-4">
                        {/* 我方參考數據 */}
                        <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
                            <h4 className="font-medium text-blue-800 mb-3 text-center">我方參考數據</h4>
                            <div className="space-y-2">
                                <input
                                    type="number"
                                    placeholder="速度 *"
                                    value={inputs.ally.speed}
                                    onChange={(e) => handleInputChange("ally", "speed", e.target.value)}
                                    className="w-full text-sm border rounded px-2 py-1 focus:ring-1 focus:ring-blue-500"
                                />
                                <input
                                    type="number"
                                    placeholder="隨機值 (可選)"
                                    value={inputs.ally.random}
                                    onChange={(e) => handleInputChange("ally", "random", e.target.value)}
                                    className="w-full text-sm border rounded px-2 py-1 focus:ring-1 focus:ring-blue-500"
                                />
                                <input
                                    type="number"
                                    placeholder="初始行動值 *"
                                    value={inputs.ally.initial}
                                    onChange={(e) => handleInputChange("ally", "initial", e.target.value)}
                                    className="w-full text-sm border rounded px-2 py-1 focus:ring-1 focus:ring-blue-500"
                                />
                            </div>
                        </div>

                        {/* 對手數據 - 改為3個 */}
                        {["opponent1", "opponent2", "opponent3"].map((opponent, index) => (
                            <div key={opponent} className="bg-pink-50 rounded-lg p-4 border border-pink-200">
                                <h4 className="font-medium text-pink-800 mb-3 text-center">對手{index + 1}</h4>
                                <div className="space-y-2">
                                    <input
                                        type="number"
                                        placeholder="隨機值 (可選)"
                                        value={inputs[opponent].random}
                                        onChange={(e) => handleInputChange(opponent, "random", e.target.value)}
                                        className="w-full text-sm border rounded px-2 py-1 focus:ring-1 focus:ring-pink-500"
                                    />
                                    <input
                                        type="number"
                                        placeholder="初始行動值"
                                        value={inputs[opponent].initial}
                                        onChange={(e) => handleInputChange(opponent, "initial", e.target.value)}
                                        className="w-full text-sm border rounded px-2 py-1 focus:ring-1 focus:ring-pink-500"
                                    />
                                </div>

                                {/* 計算結果直接顯示在輸入欄位下方 */}
                                {results.length > 0 && (
                                    <div className="mt-3 pt-3 border-t border-pink-200">
                                        {(() => {
                                            const result = results.find(r => r.character === opponent);
                                            if (!result) return null;
                                            
                                            return (
                                                <div>
                                                    <div className="bg-blue-100 text-blue-800 rounded p-2 text-center font-bold text-sm">
                                                        速度: {result.speedMin === null
                                                            ? "無法計算"
                                                            : result.speedMin === result.speedMax
                                                            ? result.speedMin
                                                            : `${result.speedMin} - ${result.speedMax}`}
                                                    </div>
                                                </div>
                                            );
                                        })()}
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>

                    <div className="mt-4 text-center">
                        <button
                            onClick={calculateOpponentSpeeds}
                            className="px-6 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 font-medium"
                        >
                            計算對手速度
                        </button>
                    </div>

                    {/* 計算結果說明 - 移到計算按鈕下方 */}
                    {results.length > 0 && (
                        <div className="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded text-sm">
                            <div className="font-medium text-yellow-800 mb-2">💡 計算說明：</div>
                            <ul className="text-yellow-700 space-y-1 text-xs">
                                <li>• <strong>精確計算</strong>：我方和對手隨機值都已知時，顯示確切速度</li>
                                <li>• <strong>範圍計算</strong>：隨機值未知時，假設隨機值範圍0-5進行估算</li>
                                <li>• <strong>我方未知</strong>：我方隨機值未填時，計算範圍會更大但更保險</li>
                                <li>• <strong>僅供參考</strong>：此功能不保存數據，專注輔助實戰決策</li>
                                <li>• <strong>必填欄位</strong>：我方速度和初始行動值為必填項</li>
                            </ul>
                        </div>
                    )}
                </div>
            );
        });

        // ==================== 工具函數 ====================
        const Utils = {
            convertAlias: (input, characterAliases) => {
                if (!input) return input;
                
                // 先清理輸入
                const cleanInput = SecurityUtils.sanitizeInput(input);
                
                for (const character of characterAliases) {
                    if (character.name.toLowerCase() === cleanInput.toLowerCase()) {
                        return character.name;
                    }
                    for (const alias of character.aliases) {
                        if (alias.toLowerCase() === cleanInput.toLowerCase()) {
                            return character.name;
                        }
                    }
                }
                return cleanInput;
            },

            getRankIcon: (rank) => {
                const icons = {
                    '金牌': '⭐',
                    '大師': '💎',
                    '挑戰者': '👑',
                    '優勝者': '🏆',
                    '前100': '🥇'
                };
                return icons[rank] || '🎮';
            },

            exportToCSV: (battleRecords) => {
                try {
                    if (!battleRecords || battleRecords.length === 0) {
                        alert('目前沒有紀錄可以匯出');
                        return;
                    }

                    const headers = ['紀錄者', '日期', '對手名稱', '對手陣容', '我方陣容', '勝負', '排位', '備註'];
                    const csvData = battleRecords.map((record) => [
                        SecurityUtils.cleanInput(record.recorder || '未知用戶'),
                        SecurityUtils.cleanInput(record.date || '未知日期'),
                        SecurityUtils.cleanInput(record.opponentName || ''),
                        (record.opponentTeam || []).filter(x => x).map(SecurityUtils.cleanInput).join(' + ') || '無',
                        (record.myTeam || []).filter(x => x).map(SecurityUtils.cleanInput).join(' + ') || '無',
                        SecurityUtils.cleanInput(record.result || '未知'),
                        SecurityUtils.cleanInput(record.rank || '未知'),
                        SecurityUtils.cleanInput(record.notes || '')
                    ]);
                    
                    const csvContent = [headers, ...csvData]
                        .map(row => row.map(cell => `"${cell.replace(/"/g, '""')}"`).join(','))
                        .join('\n');
                    
                    const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `ArkRecode對戰紀錄_${new Date().toISOString().split('T')[0]}.csv`;
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    alert('✅ CSV文件已下載！');
                    
                } catch (error) {
                    console.error('CSV匯出錯誤:', error);
                    alert('❌ 匯出失敗：' + error.message);
                }
            },

            exportData: (data) => {
                try {
                    const exportData = {
                        ...data,
                        exportDate: new Date().toISOString(),
                        version: '2.5.3',
                        security: {
                            sanitized: true,
                            exported_by: 'ArkRecode_v2.5.3'
                        }
                    };
                    
                    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `ArkRecode_完整備份_${new Date().toISOString().split('T')[0]}.json`;
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    alert('✅ 完整備份已下載！');
                } catch (error) {
                    console.error('備份匯出錯誤:', error);
                    alert('❌ 備份失敗：' + error.message);
                }
            }
        };

        // ==================== 表單組件 ====================
        const FormComponents = {
            TeamInput: React.memo(({ label, team, onChange, characterOptions, placeholder }) => (
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">{label}</label>
                    <div className="grid grid-cols-4 gap-2">
                        {team.map((char, idx) => (
                            <div key={idx} className="relative">
                                <input
                                    type="text"
                                    placeholder={`${placeholder}${idx + 1}`}
                                    value={char}
                                    onChange={(e) => {
                                        const cleanValue = SecurityUtils.cleanInput(e.target.value);
                                        onChange(cleanValue, idx);
                                    }}
                                    className="w-full text-sm border rounded px-2 py-1 focus:ring-1 focus:ring-blue-500"
                                    list={`${placeholder}-${idx}-options`}
                                    maxLength="50"
                                />
                                <datalist id={`${placeholder}-${idx}-options`}>
                                    {characterOptions.map(option => (
                                        <option key={option} value={option} />
                                    ))}
                                </datalist>
                            </div>
                        ))}
                    </div>
                </div>
            )),

            ResultSelector: React.memo(({ result, onChange }) => (
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">勝負結果</label>
                    <div className="flex gap-2">
                        <label className="flex items-center cursor-pointer">
                            <input
                                type="radio"
                                name="result"
                                value="勝"
                                checked={result === '勝'}
                                onChange={(e) => onChange(SecurityUtils.cleanInput(e.target.value))}
                                className="sr-only"
                            />
                            <div className={`px-3 py-1 text-sm border-2 rounded font-medium transition-all flex items-center gap-1 ${
                                result === '勝' 
                                    ? 'bg-green-500 text-white border-green-500' 
                                    : 'bg-white text-green-600 border-green-300 hover:bg-green-50'
                            }`}>
                                🏆 勝利
                            </div>
                        </label>
                        <label className="flex items-center cursor-pointer">
                            <input
                                type="radio"
                                name="result"
                                value="輸"
                                checked={result === '輸'}
                                onChange={(e) => onChange(SecurityUtils.cleanInput(e.target.value))}
                                className="sr-only"
                            />
                            <div className={`px-3 py-1 text-sm border-2 rounded font-medium transition-all flex items-center gap-1 ${
                                result === '輸' 
                                    ? 'bg-red-500 text-white border-red-500' 
                                    : 'bg-white text-red-600 border-red-300 hover:bg-red-50'
                            }`}>
                                💔 失敗
                            </div>
                        </label>
                    </div>
                </div>
            )),

            RankSelector: React.memo(({ rank, onChange }) => (
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">排位等級</label>
                    <select
                        value={rank}
                        onChange={(e) => onChange(SecurityUtils.cleanInput(e.target.value))}
                        className="w-32 text-sm border rounded px-2 py-1 focus:ring-1 focus:ring-blue-500"
                    >
                        <option value="">選擇排位</option>
                        <option value="金牌">⭐ 金牌</option>
                        <option value="大師">💎 大師</option>
                        <option value="挑戰者">👑 挑戰者</option>
                        <option value="優勝者">🏆 優勝者</option>
                        <option value="前100">🥇 前100</option>
                    </select>
                </div>
            ))
        };

        // ==================== 建議組件 ====================
        const SuggestionComponents = {
            TeamSuggestions: React.memo(({ suggestions, onApply, title, bgColor }) => {
                if (suggestions.length === 0) return null;
                
                return (
                    <div className={`mt-2 p-2 ${bgColor} rounded text-xs`}>
                        <div className="font-medium mb-1">{title}:</div>
                        <div className="flex flex-wrap gap-1">
                            {suggestions.map((suggestion, idx) => (
                                <button
                                    key={idx}
                                    type="button"
                                    onClick={() => onApply(suggestion)}
                                    className="px-2 py-1 bg-yellow-200 text-yellow-800 rounded hover:bg-yellow-300 text-xs"
                                >
                                    {suggestion.name ? `${SecurityUtils.sanitizeHtml(suggestion.name)}: ` : ''}
                                    {suggestion.combo.join('+')}
                                    {suggestion.source === 'history' ? (
                                        <span> ({suggestion.count}次
                                        {suggestion.matchCount && suggestion.matchCount > 2 && (
                                            <span>·{suggestion.matchCount}/4匹配</span>
                                        )}) 📊</span>
                                    ) : (
                                        <span> ({(suggestion.winRate * 100).toFixed(0)}%)</span>
                                    )}
                                </button>
                            ))}
                        </div>
                        
                        {/* 說明文字 */}
                        <div className="mt-2 text-xs text-gray-600">
                            📊 = 近期數據 (出現次數·匹配度) | 預設組合 (推薦勝率)
                        </div>
                    </div>
                );
            }),

            CounterSuggestions: React.memo(({ suggestions, onApply }) => {
                if (suggestions.length === 0) return null;
                
                // 去重複組合 - 針對反制推薦也做去重
                const uniqueSuggestions = [];
                const seenCombos = new Set();
                
                for (const suggestion of suggestions) {
                    const combo = suggestion.combo || suggestion;
                    const comboKey = combo.slice().sort().join(',');
                    if (!seenCombos.has(comboKey)) {
                        seenCombos.add(comboKey);
                        uniqueSuggestions.push(suggestion);
                    }
                }
                
                return (
                    <div className="mt-2 p-2 bg-green-50 rounded text-xs">
                        <div className="font-medium mb-1">推薦反制:</div>
                        <div className="space-y-1">
                            {uniqueSuggestions.map((suggestion, idx) => (
                                <div key={idx} className="flex items-center gap-2">
                                    <button
                                        type="button"
                                        onClick={() => onApply(suggestion.combo || suggestion)}
                                        className={`px-2 py-1 rounded hover:opacity-80 text-xs flex items-center gap-1 ${
                                            suggestion.matchLevel === '完全匹配' ? 'bg-green-200 text-green-800' :
                                            suggestion.matchLevel === '高度匹配' ? 'bg-blue-200 text-blue-800' :
                                            'bg-gray-200 text-gray-800'
                                        }`}
                                    >
                                        {(suggestion.combo || suggestion).join('+')}
                                        {suggestion.confidence && suggestion.confidence >= 0.75 && (
                                            <span className="text-xs">⭐</span>
                                        )}
                                    </button>
                                    <div className="flex flex-col">
                                        {suggestion.notes && (
                                            <span className="text-gray-600 text-xs">
                                                ({SecurityUtils.sanitizeHtml(suggestion.notes)})
                                            </span>
                                        )}
                                        {suggestion.matchLevel && (
                                            <span className={`text-xs font-medium ${
                                                suggestion.matchLevel === '完全匹配' ? 'text-green-600' :
                                                suggestion.matchLevel === '高度匹配' ? 'text-blue-600' :
                                                'text-gray-600'
                                            }`}>
                                                {SecurityUtils.sanitizeHtml(suggestion.matchLevel)}
                                                {suggestion.confidence && suggestion.confidence < 1 && (
                                                    <span className="ml-1">({(suggestion.confidence * 100).toFixed(0)}%)</span>
                                                )}
                                            </span>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                        
                        <div className="mt-2 pt-2 border-t border-green-200">
                            <div className="text-xs text-green-700">
                                <div className="flex items-center gap-2 mb-1">
                                    <span className="w-3 h-3 bg-green-200 rounded"></span>
                                    <span>完全匹配 (4/4角色)</span>
                                    <span className="w-3 h-3 bg-blue-200 rounded ml-2"></span>
                                    <span>高度匹配 (3/4角色)</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <span className="w-3 h-3 bg-gray-200 rounded"></span>
                                    <span>通用建議</span>
                                    <span className="ml-2">⭐ = 高信心度</span>
                                    <span className="ml-2">📊 = 近期數據(次數)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            })
        };

        // ==================== 統計組件 ====================
        const StatsComponents = {
            StatsDashboard: React.memo(({ stats, onExportData, onBatchUpload, communitySettings, battleRecords }) => (
                <div className="bg-white rounded-lg shadow p-4">
                    <h3 className="text-sm font-semibold mb-3">統計資料</h3>
                    <div className="space-y-2 text-sm">
                        <div className="flex justify-between">
                            <span className="text-gray-600">總場次</span>
                            <span className="font-bold text-blue-600">{stats.total}</span>
                        </div>
                        <div className="flex justify-between">
                            <span className="text-gray-600">勝場</span>
                            <span className="font-bold text-green-600">{stats.wins}</span>
                        </div>
                        <div className="flex justify-between">
                            <span className="text-gray-600">勝率</span>
                            <span className="font-bold text-purple-600">{stats.winRate}%</span>
                        </div>
                    </div>
                    
                    <div className="mt-3 pt-3 border-t">
                        <div className="text-xs text-gray-500 mb-2 flex items-center gap-1">
                            <div className="w-2 h-2 rounded-full bg-green-500"></div>
                            資料已自動保存
                        </div>
                        
                        {communitySettings.enabled && (
                            <div className="text-xs text-purple-600 mb-2 flex items-center gap-1">
                                <div className="w-2 h-2 rounded-full bg-purple-500"></div>
                                Google Sheets同步已啟用
                                {communitySettings.lastSync && (
                                    <span className="text-gray-500">
                                        (最後同步: {new Date(communitySettings.lastSync).toLocaleString('zh-TW', { 
                                            month: 'numeric', 
                                            day: 'numeric', 
                                            hour: '2-digit', 
                                            minute: '2-digit' 
                                        })})
                                    </span>
                                )}
                            </div>
                        )}
                        
                        <div className="space-y-2">
                            <button
                                onClick={onExportData}
                                disabled={battleRecords.length === 0}
                                className={`w-full py-2 px-3 rounded text-sm flex items-center justify-center gap-2 transition-all ${
                                    battleRecords.length === 0
                                        ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                        : 'bg-blue-500 text-white hover:bg-blue-600'
                                }`}
                            >
                                <IconComponents.Download size={14} />
                                完整備份
                            </button>

                            {communitySettings.enabled && (
                                <button
                                    onClick={onBatchUpload}
                                    disabled={battleRecords.length === 0}
                                    className={`w-full py-1 px-2 rounded text-xs flex items-center justify-center gap-1 ${
                                        battleRecords.length === 0
                                            ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                            : 'bg-purple-500 text-white hover:bg-purple-600'
                                    }`}
                                    title={`批量上傳到您的私人Google Sheets (共${battleRecords.filter(r => !r.uploaded).length}筆未上傳)`}
                                >
                                    批量上傳 ({battleRecords.filter(r => !r.uploaded).length}筆未上傳)
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            ))
        };

        // ==================== 主要表單組件 ====================
        const BattleForm = React.memo(({ 
            formData, 
            onInputChange, 
            onSubmit, 
            characterOptions, 
            teamSuggestions, 
            counterSuggestions, 
            onApplySuggestion,
            onUploadSingle,
            communitySettings 
        }) => {
            const [showSpeedCalculator, setShowSpeedCalculator] = useState(false);

            return (
                <div className="lg:col-span-2 space-y-4">
                    {/* 主要記錄表單 */}
                    <div className="bg-white rounded-lg shadow-lg p-4">
                        <div className="flex items-center gap-4 mb-4">
                            <h2 className="text-lg font-semibold">新增對戰紀錄</h2>
                            <div className="flex items-center gap-2">
                                <label className="text-sm text-gray-600">紀錄者:</label>
                                <input
                                    type="text"
                                    value={formData.recorder}
                                    onChange={(e) => onInputChange('recorder', SecurityUtils.cleanInput(e.target.value))}
                                    className="w-20 text-sm border rounded px-2 py-1"
                                    placeholder="玩家名"
                                    maxLength="20"
                                />
                            </div>
                            {/* 速度計算器開關 */}
                            <div className="ml-auto">
                                <button
                                    onClick={() => setShowSpeedCalculator(!showSpeedCalculator)}
                                    className={`px-3 py-1 text-sm rounded flex items-center gap-1 transition-colors ${
                                        showSpeedCalculator 
                                            ? 'bg-purple-500 text-white' 
                                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                    }`}
                                >
                                    <IconComponents.Calculator size={14} />
                                    {showSpeedCalculator ? '關閉計算器' : '速度計算器'}
                                </button>
                            </div>
                        </div>
                        
                        <div className="space-y-4">
                            <div>
                                <FormComponents.TeamInput
                                    label="對手陣容"
                                    team={formData.opponentTeam}
                                    onChange={(value, idx) => onInputChange('opponentTeam', value, idx)}
                                    characterOptions={characterOptions}
                                    placeholder="對手"
                                />
                                
                                <SuggestionComponents.TeamSuggestions
                                    suggestions={teamSuggestions}
                                    onApply={(suggestion) => onApplySuggestion(suggestion, true)}
                                    title="常見組合"
                                    bgColor="bg-yellow-50"
                                />
                            </div>

                            <div>
                                <FormComponents.TeamInput
                                    label="我方陣容"
                                    team={formData.myTeam}
                                    onChange={(value, idx) => onInputChange('myTeam', value, idx)}
                                    characterOptions={characterOptions}
                                    placeholder="我方"
                                />
                                
                                <SuggestionComponents.CounterSuggestions
                                    suggestions={counterSuggestions}
                                    onApply={(suggestion) => onApplySuggestion(suggestion, false)}
                                />
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <FormComponents.ResultSelector
                                    result={formData.result}
                                    onChange={(value) => onInputChange('result', value)}
                                />
                                
                                <FormComponents.RankSelector
                                    rank={formData.rank}
                                    onChange={(value) => onInputChange('rank', value)}
                                />
                            </div>

                            {/* 修改：對手名稱1/4寬度，備註3/4寬度 */}
                            <div className="grid grid-cols-4 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">對手名稱</label>
                                    <input
                                        type="text"
                                        value={formData.opponentName}
                                        onChange={(e) => onInputChange('opponentName', SecurityUtils.cleanInput(e.target.value, true))}
                                        placeholder="對手ID..."
                                        className="w-full text-sm border rounded px-2 py-1 focus:ring-1 focus:ring-blue-500"
                                        maxLength="16"
                                    />
                                    <div className="text-xs text-gray-500 mt-1">
                                        {formData.opponentName.length}/16 字元
                                    </div>
                                </div>

                                <div className="col-span-3">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">備註</label>
                                    <input
                                        type="text"
                                        value={formData.notes}
                                        onChange={(e) => onInputChange('notes', SecurityUtils.cleanInput(e.target.value, true))}
                                        placeholder="戰術要點、特殊情況等..."
                                        className="w-full text-sm border rounded px-2 py-1 focus:ring-1 focus:ring-blue-500"
                                        maxLength="200"
                                    />
                                    <div className="text-xs text-gray-500 mt-1">
                                        {formData.notes.length}/200 字元
                                    </div>
                                </div>
                            </div>

                            <button
                                type="button"
                                onClick={onSubmit}
                                className="w-full bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 font-medium"
                            >
                                保存紀錄
                            </button>

                            {communitySettings.enabled && (
                                <button
                                    type="button"
                                    onClick={onUploadSingle}
                                    className="w-full bg-purple-500 text-white py-2 px-4 rounded hover:bg-purple-600 font-medium flex items-center justify-center gap-2"
                                >
                                    📊 上傳到Google Sheets
                                </button>
                            )}
                        </div>
                    </div>

                    {/* 速度計算器 */}
                    <SpeedCalculator 
                        isVisible={showSpeedCalculator} 
                        onClose={() => setShowSpeedCalculator(false)}
                    />
                </div>
            );
        });

        // ==================== 歷史記錄表格組件 ====================  
        const HistoryTable = React.memo(({ 
            records, 
            onAddToCounter, 
            onUploadRecord,
            onDeleteRecord,
            onDeleteBatchByDate,
            onResetData,
            onImportData,
            communitySettings,
            sortBy,
            onSortChange,
            characterOptions,
            convertAlias,
            // 新增這兩個 props
            onSetFormData,
            onSetCurrentView
        }) => {
            // 搜索狀態
            const [searchOpponents, setSearchOpponents] = useState(['', '', '', '']);
            const [showSearchResults, setShowSearchResults] = useState(false);
            const [isSearching, setIsSearching] = useState(false);
            const [lastSearchTerms, setLastSearchTerms] = useState(['', '', '', '']);

            // 優化的角色別名轉換 - 使用緩存
            const aliasCache = useMemo(() => {
                const cache = new Map();
                characterOptions.forEach(option => {
                    const converted = convertAlias(option);
                    cache.set(option.toLowerCase(), converted);
                });
                return cache;
            }, [characterOptions, convertAlias]);

            // 快速角色轉換函數
            const fastConvertAlias = useCallback((input) => {
                if (!input) return input;
                const cleanInput = SecurityUtils.cleanInput(input);
                const cached = aliasCache.get(cleanInput.toLowerCase());
                return cached || convertAlias(cleanInput);
            }, [aliasCache, convertAlias]);

            // 執行搜索的函數
            const performSearch = useCallback(() => {
                setIsSearching(true);
                
                // 使用 setTimeout 讓 UI 有時間更新搜索狀態
                setTimeout(() => {
                    setLastSearchTerms([...searchOpponents]);
                    setIsSearching(false);
                    
                    // 自動顯示搜索結果（如果有結果的話）
                    const searchTeam = searchOpponents
                        .map(char => char ? fastConvertAlias(char) : '')
                        .filter(char => char);
                    
                    if (searchTeam.length >= 3) {
                        setShowSearchResults(true);
                    } else {
                        setShowSearchResults(false);
                    }
                }, 50);
            }, [searchOpponents, fastConvertAlias]);

            // 處理輸入欄失焦事件
            const handleInputBlur = useCallback((index) => {
                // 檢查當前輸入是否與上次搜索不同，且至少有3個角色
                const currentSearchTeam = searchOpponents.filter(char => char.trim()).length;
                const lastSearchTeam = lastSearchTerms.filter(char => char.trim()).length;
                
                if (currentSearchTeam >= 3 && 
                    (currentSearchTeam !== lastSearchTeam || 
                     searchOpponents.some((char, idx) => char !== lastSearchTerms[idx]))) {
                    performSearch();
                }
            }, [searchOpponents, lastSearchTerms, performSearch]);

            // 搜索結果 - 使用最後搜索的詞條
            const searchResults = useMemo(() => {
                const searchTeam = lastSearchTerms
                    .map(char => char ? fastConvertAlias(char) : '')
                    .filter(char => char);
                
                // 至少需要3個角色才開始搜索
                if (searchTeam.length < 3) {
                    return [];
                }

                // 根據輸入的角色數量決定最低匹配要求
                const requiredMatchCount = searchTeam.length === 4 ? 4 : 3;

                // 預處理所有記錄的對手陣容 - 避免重複計算
                const processedRecords = records.map(record => {
                    const recordOpponents = record.opponentTeam
                        .filter(char => char)
                        .map(fastConvertAlias);
                    return { ...record, processedOpponents: recordOpponents };
                });

                const matchingRecords = processedRecords.filter(record => {
                    const matchCount = searchTeam.filter(char => 
                        record.processedOpponents.includes(char)
                    ).length;
                    
                    // 根據輸入角色數量調整匹配要求
                    // 4個角色輸入時：只要完全匹配(4/4)
                    // 3個角色輸入時：要3個以上匹配(3/4或4/4)
                    return matchCount >= requiredMatchCount;
                }).map(record => {
                    const matchCount = searchTeam.filter(char => 
                        record.processedOpponents.includes(char)
                    ).length;
                    
                    return {
                        ...record,
                        matchCount,
                        matchLevel: matchCount === 4 ? '完全匹配' : matchCount === 3 ? '高度匹配' : '部分匹配'
                    };
                }).sort((a, b) => {
                    // 先按匹配度排序，再按日期排序
                    if (a.matchCount !== b.matchCount) {
                        return b.matchCount - a.matchCount;
                    }
                    return b.id - a.id;
                });

                return matchingRecords;
            }, [lastSearchTerms, records, fastConvertAlias]);

            // 自動顯示搜索結果
            useEffect(() => {
                if (lastSearchTerms.filter(c => c).length >= 3 && searchResults.length > 0) {
                    setShowSearchResults(true);
                } else if (lastSearchTerms.filter(c => c).length < 3) {
                    setShowSearchResults(false);
                }
            }, [lastSearchTerms, searchResults.length]);

            // 根據排序方式處理記錄
            const sortedRecords = useMemo(() => {
                const recordsToSort = showSearchResults ? searchResults : records;
                const recordsCopy = [...recordsToSort];
                
                if (sortBy === 'opponentId') {
                    return recordsCopy.sort((a, b) => {
                        const nameA = (a.opponentName || '').toLowerCase();
                        const nameB = (b.opponentName || '').toLowerCase();
                        
                        // 有名字的優先
                        if (nameA && !nameB) return -1;
                        if (!nameA && nameB) return 1;
            
                        // 都有名字或都沒名字時，按字母排序
                        if (nameA !== nameB) {
                        return nameA.localeCompare(nameB);
                        }

                        // 名字相同時，按創建時間排序（最新的在前）
                        return b.id - a.id;
                    });
                } else {
                    // 預設按創建時間排序（最新的在前）
                    return recordsCopy.sort((a, b) => b.id - a.id);
                }
            }, [records, searchResults, showSearchResults, sortBy]);

            // 計算最常見的紀錄者
            const mainRecorder = useMemo(() => {
                if (records.length === 0) return '我方';
                
                const recorderCount = {};
                records.forEach(record => {
                    const recorder = record.recorder || '未知';
                    recorderCount[recorder] = (recorderCount[recorder] || 0) + 1;
                });
                
                // 找出最常見的紀錄者
                let maxCount = 0;
                let mostCommonRecorder = '我方';
                for (const [recorder, count] of Object.entries(recorderCount)) {
                    if (count > maxCount) {
                        maxCount = count;
                        mostCommonRecorder = recorder;
                    }
                }
                
                return mostCommonRecorder;
            }, [records]);

            return (
                <div className="bg-white rounded-lg shadow-lg p-4">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-lg font-semibold flex items-center gap-2">
                            歷史紀錄 ({showSearchResults ? `${searchResults.length}/${records.length}` : records.length} 筆)
                        </h2>
                        <div className="flex gap-2 items-center">
                            <div className="flex items-center gap-2">
                                <label className="text-sm text-gray-600">排序：</label>
                                <select
                                    value={sortBy}
                                    onChange={(e) => onSortChange(e.target.value)}
                                    className="text-xs border rounded px-2 py-1 bg-white"
                                >
                                    <option value="date">日期</option>
                                    <option value="opponentId">對手名稱</option>
                                </select>
                            </div>
                            <button
                                onClick={onResetData}
                                className="px-3 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600"
                            >
                                重置資料
                            </button>
                            <input
                                type="file"
                                accept=".json"
                                onChange={onImportData}
                                className="hidden"
                                id="importFile"
                            />
                            <label
                                htmlFor="importFile"
                                className="px-3 py-1 text-xs bg-gray-500 text-white rounded cursor-pointer hover:bg-gray-600"
                            >
                                導入資料
                            </label>
                        </div>
                    </div>

                    {/* 搜索功能區 */}
                    <div className="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <div className="flex items-center justify-between mb-3">
                            <h3 className="text-sm font-semibold text-blue-800 flex items-center gap-2">
                                <IconComponents.Target size={16} className="text-blue-600" />
                                對手陣容搜索
                                {isSearching && (
                                    <span className="text-xs text-blue-600 animate-pulse flex items-center gap-1">
                                        <div className="animate-spin rounded-full h-3 w-3 border-b-2 border-blue-600"></div>
                                        搜索中...
                                    </span>
                                )}
                            </h3>
                            <div className="flex gap-2">
                                <button
                                    onClick={() => {
                                        setSearchOpponents(['', '', '', '']);
                                        setLastSearchTerms(['', '', '', '']);
                                        setShowSearchResults(false);
                                        setIsSearching(false);
                                    }}
                                    className="px-3 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600"
                                >
                                    清空
                                </button>
                                <button
                                    onClick={performSearch}
                                    disabled={searchOpponents.filter(c => c.trim()).length < 3 || isSearching}
                                    className={`px-3 py-1 text-xs rounded transition-colors flex items-center gap-1 ${
                                        searchOpponents.filter(c => c.trim()).length >= 3 && !isSearching
                                            ? 'bg-blue-500 text-white hover:bg-blue-600' 
                                            : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                    }`}
                                >
                                    <IconComponents.Target size={12} />
                                    立即搜索
                                </button>
                                <button
                                    onClick={() => setShowSearchResults(!showSearchResults)}
                                    disabled={searchResults.length === 0}
                                    className={`px-3 py-1 text-xs rounded transition-colors ${
                                        showSearchResults 
                                            ? 'bg-green-500 text-white hover:bg-green-600' 
                                            : searchResults.length > 0
                                            ? 'bg-green-500 text-white hover:bg-green-600'
                                            : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                    }`}
                                >
                                    {showSearchResults ? '顯示全部' : `搜索結果 (${searchResults.length})`}
                                </button>
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-4 gap-2 mb-3">
                            {searchOpponents.map((char, idx) => (
                                <div key={idx} className="relative">
                                    <input
                                        type="text"
                                        placeholder={`對手${idx + 1}`}
                                        value={char}
                                        onChange={(e) => {
                                            const cleanValue = SecurityUtils.cleanInput(e.target.value);
                                            const newSearchOpponents = [...searchOpponents];
                                            newSearchOpponents[idx] = cleanValue;
                                            setSearchOpponents(newSearchOpponents);
                                        }}
                                        onBlur={() => handleInputBlur(idx)}
                                        onKeyPress={(e) => {
                                            if (e.key === 'Enter') {
                                                e.target.blur(); // 觸發失焦事件
                                            }
                                        }}
                                        className={`w-full text-sm border rounded px-2 py-1 focus:ring-1 focus:ring-blue-500 transition-colors ${
                                            isSearching ? 'bg-blue-50' : ''
                                        }`}
                                        list={`search-opponent-${idx}-options`}
                                        maxLength="20"
                                        disabled={isSearching}
                                    />
                                    <datalist id={`search-opponent-${idx}-options`}>
                                        {characterOptions.map(option => (
                                            <option key={option} value={option} />
                                        ))}
                                    </datalist>
                                </div>
                            ))}
                        </div>
                        
                        {/* 搜索提示 */}
                        <div className="flex items-center justify-between mb-2">
                            <div className="text-xs text-gray-600">
                                💡 <strong>使用方式：</strong>
                                {searchOpponents.filter(c => c.trim()).length < 3 ? (
                                    <span>至少輸入 3 個角色，然後點擊「立即搜索」或切換到其他欄位自動搜索</span>
                                ) : searchOpponents.filter(c => c.trim()).length === 4 ? (
                                    <span>已輸入 4 個角色，將只顯示完全匹配(4/4)的記錄</span>
                                ) : (
                                    <span>已輸入 {searchOpponents.filter(c => c.trim()).length} 個角色，將顯示高度匹配(3/4)和完全匹配(4/4)的記錄</span>
                                )}
                            </div>
                            
                            {/* 快速開始記錄按鈕 */}
                            {lastSearchTerms.filter(c => c).length >= 3 && (
                                <button
                                    type="button"
                                    onClick={() => {
                                        console.log('快速記錄按鈕被點擊');
                                        
                                        try {
                                            // 取得搜尋的對手組合
                                            const searchTeam = lastSearchTerms
                                                .map(char => char ? fastConvertAlias(SecurityUtils.cleanInput(char)) : '')
                                                .filter(char => char);
                                            
                                            if (searchTeam.length === 0) {
                                                alert('❌ 無法取得搜尋組合，請重新搜尋');
                                                return;
                                            }
                                            
                                            // 確保有4個位置
                                            const opponentTeam = [
                                                searchTeam[0] || '',
                                                searchTeam[1] || '',
                                                searchTeam[2] || '',
                                                searchTeam[3] || ''
                                            ];
                                            
                                            // 使用傳入的 props 函數
                                            onSetFormData(prev => ({
                                                ...prev,
                                                opponentTeam: opponentTeam
                                            }));
                                            
                                            // 跳轉到記錄頁面
                                            onSetCurrentView('record');
                                            
                                        } catch (error) {
                                            console.error('快速記錄功能錯誤:', error);
                                            alert('❌ 操作失敗，請重試');
                                        }
                                    }}
                                    className="px-3 py-1 bg-green-500 text-white rounded text-xs hover:bg-green-600 flex items-center gap-1 transition-colors"
                                >
                                    <IconComponents.Plus size={12} />
                                    快速開始記錄
                                </button>
                            )}
                        </div>
                        
                        {/* 搜索結果概要 */}
                        {lastSearchTerms.filter(c => c).length >= 3 && !isSearching && (
                            <div className="text-sm">
                                {searchResults.length > 0 ? (
                                    <div className="flex flex-wrap gap-2 items-center">
                                        <span className="text-blue-700 font-medium">
                                            找到 {searchResults.length} 筆匹配記錄：
                                        </span>
                                        {searchResults.slice(0, 3).map((result, idx) => (
                                            <div key={idx} className={`px-2 py-1 rounded text-xs ${
                                                result.matchLevel === '完全匹配' ? 'bg-green-200 text-green-800' :
                                                result.matchLevel === '高度匹配' ? 'bg-blue-200 text-blue-800' :
                                                'bg-gray-200 text-gray-800'
                                            }`}>
                                                {result.matchCount}/4 匹配 - {result.result === '勝' ? '🏆' : '💔'} 
                                                {result.opponentName && <span className="ml-1">vs {SecurityUtils.sanitizeHtml(result.opponentName)}</span>}
                                            </div>
                                        ))}
                                        {searchResults.length > 3 && (
                                            <span className="text-gray-500 text-xs">...等{searchResults.length}筆</span>
                                        )}
                                        <div className="text-xs text-gray-500 mt-1">
                                            搜索條件: {lastSearchTerms.filter(c => c).join(' + ')}
                                            {lastSearchTerms.filter(c => c).length === 4 && 
                                                <span className="text-blue-600 ml-2">(僅完全匹配)</span>
                                            }
                                        </div>
                                    </div>
                                ) : (
                                    <div className="text-gray-600">
                                        {lastSearchTerms.filter(c => c).length === 4 ? (
                                            <span>無完全匹配記錄（搜索條件: {lastSearchTerms.filter(c => c).join(' + ')}）</span>
                                        ) : (
                                            <span>無匹配記錄（搜索條件: {lastSearchTerms.filter(c => c).join(' + ')}）</span>
                                        )}
                                        <div className="text-xs text-gray-500 mt-1">
                                            💡 嘗試減少角色數量或檢查角色名稱是否正確
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* 推薦功能 */}
                        {showSearchResults && searchResults.length > 0 && (
                            <div className="mt-3 pt-3 border-t border-blue-200">
                                <h4 className="text-sm font-medium text-blue-800 mb-2 flex items-center gap-1">
                                    <IconComponents.Trophy size={14} className="text-yellow-500" />
                                    推薦我方陣容（基於歷史勝場記錄）
                                    {lastSearchTerms.filter(c => c).length === 4 && 
                                        <span className="text-xs text-blue-600">(完全匹配)</span>
                                    }
                                </h4>
                                <div className="grid grid-cols-1 gap-2">
                                    {/* 勝場記錄的我方陣容 */}
                                    {searchResults
                                        .filter(record => record.result === '勝')
                                        .slice(0, 3)
                                        .map((record, idx) => (
                                            <div key={idx} className="bg-green-50 border border-green-200 rounded p-2">
                                                <div className="flex items-center justify-between">
                                                    <div className="flex items-center gap-2">
                                                        <div className="flex flex-wrap gap-1">
                                                            {record.myTeam.filter(char => char).map((char, charIdx) => (
                                                                <span key={charIdx} className="bg-green-200 text-green-800 px-1 py-0.5 rounded text-xs">
                                                                    {SecurityUtils.sanitizeHtml(char)}
                                                                </span>
                                                            ))}
                                                        </div>
                                                        <div className="text-xs text-green-700">
                                                            ({record.matchCount}/4 匹配 - {record.date})
                                                            {record.opponentName && (
                                                                <span className="ml-1">vs {SecurityUtils.sanitizeHtml(record.opponentName)}</span>
                                                            )}
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center gap-1">
                                                        <span className="text-green-600 font-bold text-sm">勝 🏆</span>
                                                        {record.notes && (
                                                            <span className="text-xs text-gray-500 max-w-24 truncate" title={SecurityUtils.sanitizeHtml(record.notes)}>
                                                                ({SecurityUtils.sanitizeHtml(record.notes)})
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        ))
                                    }
                                    
                                    {/* 如果沒有勝場記錄 */}
                                    {searchResults.filter(record => record.result === '勝').length === 0 && (
                                        <div className="bg-yellow-50 border border-yellow-200 rounded p-2 text-center">
                                            <div className="text-sm text-yellow-700">
                                                {lastSearchTerms.filter(c => c).length === 4 ? (
                                                    <span>🤔 對於此完全匹配陣容尚無勝場記錄，建議參考失敗經驗或嘗試通用反制策略</span>
                                                ) : (
                                                    <span>🤔 對於此陣容尚無勝場記錄，建議參考失敗經驗或使用通用反制策略</span>
                                                )}
                                            </div>
                                            {searchResults.filter(record => record.result === '輸').length > 0 && (
                                                <div className="text-xs text-yellow-600 mt-1">
                                                    有 {searchResults.filter(record => record.result === '輸').length} 筆失敗記錄，可參考避免相同陣容
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}


                    </div>
                    
                    {records.length === 0 ? (
                        <div className="text-center py-8 text-gray-500">
                            <IconComponents.Shield size={48} className="mx-auto mb-4 text-gray-300" />
                            <p>尚無對戰紀錄</p>
                            <p className="text-sm mt-2">您的數據將存儲在本機瀏覽器中</p>
                        </div>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="w-full text-xs">
                                <thead>
                                    <tr className="border-b bg-gray-50">
                                        <th className="text-left py-2 px-2 text-sm font-semibold">日期</th>
                                        <th className="text-left py-2 px-2 text-sm font-semibold">對手名稱</th>
                                        <th className="text-left py-2 px-2 text-sm font-semibold">對手陣容</th>
                                        <th className="text-left py-2 px-2 text-sm font-semibold">
                                            我方陣容 ({SecurityUtils.sanitizeHtml(mainRecorder)})
                                        </th>
                                        <th className="text-left py-2 px-2 text-sm font-semibold">結果</th>
                                        <th className="text-left py-2 px-2 text-sm font-semibold">排位</th>
                                        <th className="text-left py-2 px-2 text-sm font-semibold">備註</th>
                                        <th className="text-left py-2 px-2 text-sm font-semibold">上傳狀態</th>
                                        <th className="text-left py-2 px-2 text-sm font-semibold">操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {sortedRecords.map((record) => (
                                        <tr key={record.id} className={`border-b hover:bg-gray-50 ${
                                            showSearchResults && record.matchLevel === '完全匹配' ? 'bg-green-50' :
                                            showSearchResults && record.matchLevel === '高度匹配' ? 'bg-blue-50' : ''
                                        }`}>
                                            <td className="py-2 px-2 text-sm">
                                                {record.date ? new Date(record.date + 'T00:00:00').toLocaleDateString('zh-TW', { month: 'numeric', day: 'numeric' }).replace('/', '/') : '未知'}
                                                {/* 在搜索模式下顯示匹配度 */}
                                                {showSearchResults && record.matchLevel && (
                                                    <div className={`text-xs mt-1 ${
                                                        record.matchLevel === '完全匹配' ? 'text-green-600' :
                                                        record.matchLevel === '高度匹配' ? 'text-blue-600' :
                                                        'text-gray-600'
                                                    }`}>
                                                        {record.matchCount}/4 {record.matchLevel}
                                                    </div>
                                                )}
                                            </td>
                                            {/* 對手名稱欄位 - 根據勝負結果調整顏色 */}
                                            <td className="py-2 px-2 text-sm">
                                                {record.opponentName ? (
                                                    <div className={`font-bold ${
                                                        record.result === '勝' ? 'text-black' : 'text-purple-600'
                                                    }`}>
                                                        {SecurityUtils.sanitizeHtml(record.opponentName)}
                                                    </div>
                                                ) : (
                                                    <span className="text-gray-400">-</span>
                                                )}
                                            </td>
                                            <td className="py-2 px-2">
                                                <div className="flex flex-wrap gap-1">
                                                    {record.opponentTeam.map((char, idx) => {
                                                        const isMatched = showSearchResults && lastSearchTerms.some(searchChar => 
                                                            fastConvertAlias(SecurityUtils.cleanInput(searchChar)) === fastConvertAlias(char)
                                                        );
                                                        return char && (
                                                            <span key={idx} className={`px-1 py-0.5 rounded text-xs ${
                                                                isMatched 
                                                                    ? 'bg-yellow-200 text-yellow-900 border border-yellow-400 font-bold'
                                                                    : 'bg-red-100 text-red-800'
                                                            }`}>
                                                                {SecurityUtils.sanitizeHtml(char)}
                                                            </span>
                                                        );
                                                    })}
                                                </div>
                                            </td>
                                            <td className="py-2 px-2">
                                                <div className="flex flex-wrap gap-1 items-center">
                                                    {record.myTeam.map((char, idx) => char && (
                                                        <span key={idx} className="bg-blue-100 text-blue-800 px-1 py-0.5 rounded text-xs">
                                                            {SecurityUtils.sanitizeHtml(char)}
                                                        </span>
                                                    ))}
                                                    {/* 如果紀錄者不是主要紀錄者，顯示在括號中 */}
                                                    {record.recorder && record.recorder !== mainRecorder && (
                                                        <span className="text-gray-500 text-xs ml-1">
                                                            ({SecurityUtils.sanitizeHtml(record.recorder)})
                                                        </span>
                                                    )}
                                                </div>
                                            </td>
                                            <td className="py-2 px-2 text-center">
                                                <span className="text-lg" title={record.result === '勝' ? '勝利' : '失敗'}>
                                                    {record.result === '勝' ? '🏆' : '💔'}
                                                </span>
                                            </td>
                                            <td className="py-2 px-2">
                                                <span className="flex items-center gap-1 text-xs">
                                                    {Utils.getRankIcon(record.rank)}
                                                    {SecurityUtils.sanitizeHtml(record.rank)}
                                                </span>
                                            </td>
                                            <td className="py-2 px-2 max-w-32 truncate text-xs notes-cell" title={SecurityUtils.sanitizeHtml(record.notes)}>
                                                {SecurityUtils.sanitizeHtml(record.notes)}
                                                {record.notes && record.notes.length > 15 && (
                                                    <div className="tooltip">
                                                        {SecurityUtils.sanitizeHtml(record.notes)}
                                                    </div>
                                                )}
                                            </td>
                                            <td className="py-2 px-2 text-center">
                                                {communitySettings.enabled ? (
                                                    record.uploaded ? (
                                                        <div className="flex items-center justify-center gap-1">
                                                            <span className="text-lg" title={`上傳完成 (${record.uploadedAt ? new Date(record.uploadedAt).toLocaleDateString('zh-TW') : ''})`}>✅</span>
                                                            <span className="text-xs text-gray-500">已上傳</span>
                                                        </div>
                                                    ) : (
                                                        <button
                                                            onClick={() => onUploadRecord(record)}
                                                            className="flex items-center justify-center gap-1 px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600"
                                                            title="上傳到您的私人Google Sheets"
                                                        >
                                                            <span>⏳</span>
                                                            <span>上傳</span>
                                                        </button>
                                                    )
                                                ) : (
                                                    <span className="text-xs text-gray-400">未啟用</span>
                                                )}
                                            </td>
                                            <td className="py-2 px-2">
                                                <div className="flex gap-1">
                                                    {record.result === '勝' && record.opponentTeam.filter(c => c).length >= 3 && (
                                                        <button
                                                            onClick={() => onAddToCounter(record)}
                                                            className="px-1 py-1 bg-green-100 text-green-700 rounded text-xs hover:bg-green-200 border border-green-300 flex items-center gap-1"
                                                            title="將此勝場加入反制策略"
                                                        >
                                                            <IconComponents.Target size={12} />
                                                            策略
                                                        </button>
                                                    )}
                                                    <button
                                                        onClick={() => onDeleteRecord(record.id)}
                                                        className="p-1 text-gray-400 hover:text-red-500 hover:bg-gray-100 rounded transition-colors"
                                                        title="刪除此記錄"
                                                    >
                                                        <IconComponents.Trash size={14} />
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                    
                    {/* 批量刪除工具欄 */}
                    {records.length > 0 && (
                        <div className="mt-4 pt-4 border-t border-gray-200">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-4">
                                    <div className="flex items-center gap-2">
                                        <label className="text-sm font-medium text-gray-700">批量刪除：</label>
                                        <input
                                            type="date"
                                            className="px-3 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            onChange={(e) => {
                                                const selectedDate = e.target.value;
                                                if (selectedDate) {
                                                    const recordsToDelete = records.filter(record => {
                                                        const recordDate = new Date(record.date + 'T00:00:00');
                                                        const cutoffDate = new Date(selectedDate + 'T00:00:00');
                                                        return recordDate < cutoffDate;
                                                    });
                                                    if (recordsToDelete.length > 0) {
                                                        const uploadedCount = recordsToDelete.filter(r => r.uploaded).length;
                                                        const notUploadedCount = recordsToDelete.length - uploadedCount;
                                                        e.target.nextElementSibling.textContent = `將刪除 ${recordsToDelete.length} 筆記錄（${uploadedCount} 筆已上傳，${notUploadedCount} 筆未上傳）`;
                                                    } else {
                                                        e.target.nextElementSibling.textContent = '沒有符合條件的記錄';
                                                    }
                                                } else {
                                                    e.target.nextElementSibling.textContent = '';
                                                }
                                            }}
                                        />
                                        <span className="text-sm text-gray-600 ml-2"></span>
                                    </div>
                                    <button
                                        onClick={() => {
                                            const dateInput = document.querySelector('input[type="date"]');
                                            if (dateInput && dateInput.value) {
                                                onDeleteBatchByDate(dateInput.value);
                                                dateInput.value = '';
                                                dateInput.nextElementSibling.textContent = '';
                                            } else {
                                                alert('請先選擇日期');
                                            }
                                        }}
                                        className="px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600 transition-colors flex items-center gap-1"
                                    >
                                        <IconComponents.Trash size={14} />
                                        批量刪除
                                    </button>
                                </div>
                                <div className="text-sm text-gray-500">
                                    共 {records.length} 筆記錄
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        });

        // ==================== 主應用組件 ====================
        const App = () => {
            // 免責聲明狀態
            const [disclaimerAccepted, setDisclaimerAccepted] = useState(false);
            
            // 狀態定義
            const [currentView, setCurrentView] = useState('record');
            const [battleRecords, setBattleRecords] = useState([]);
            const [uploadProgress, setUploadProgress] = useState({ current: 0, total: 0, isUploading: false });
            const [sortBy, setSortBy] = useState('date'); // 新增排序狀態：'date' 或 'opponentId'
            
            // 角色別稱資料庫 此段請AI協助時不要更改
            const [characterAliases, setCharacterAliases] = useState([
                { name: '水琴', aliases: ['水琴'] },
                { name: '蓋兒', aliases: ['蓋兒', '暗老頭'] },
                { name: '暗飛', aliases: ['暗飛', '暗飛劍'] },
                { name: 'AOI', aliases: ['aoi', 'Aoi', 'AOI'] },
                { name: '124', aliases: ['124', '光女主', '光伊'] },
                { name: 'LLB', aliases: ['llb', 'LLB'] },
                { name: '水拳', aliases: ['水拳', '露比'] },
                { name: '血卡', aliases: ['血卡'] },
                { name: '光鞭', aliases: ['光鞭'] },
                { name: '光馬', aliases: ['光馬', '光寶馬', '光寶'] },
                { name: '水偶', aliases: ['水偶'] },
                { name: '朱音', aliases: ['朱音', '朱茵'] },
                { name: 'HKD', aliases: ['hkd', 'HKD'] },
                { name: '泳蘿', aliases: ['泳蘿', '水萝'] },
                { name: '水馬', aliases: ['水馬', '水寶馬'] },
                { name: '光蘿', aliases: ['光蘿'] },
                { name: '新春', aliases: ['新春'] },
                { name: '光大奶', aliases: ['光大奶'] },
                { name: '草莓', aliases: ['草莓', '異變使徒'] },
                { name: '暗龍', aliases: ['暗龍'] },
                { name: '艾莉卡', aliases: ['艾莉卡', '愛莉卡', '所長'] },
                { name: '光鞭', aliases: ['光鞭'] },
                { name: '使徒', aliases: ['使徒'] },
                { name: '香蕉', aliases: ['香蕉'] },
                { name: '兔女郎', aliases: ['兔女', '兔女郎'] },
                { name: '咪嚕', aliases: ['咪嚕', 'miru'] },
                { name: '火貓', aliases: ['火貓', '眼罩'] },
                { name: '伊娃', aliases: ['伊娃', 'eva'] },
                { name: '木鯨魚', aliases: ['木瓜', '木鯨魚'] },
                { name: '光奶', aliases: ['光奶', '柯妮絲', '薄尼斯', '復活奶'] },
                { name: '暗盾', aliases: ['暗盾'] },
                { name: '光總', aliases: ['光總'] },
                { name: '聖誕', aliases: ['聖誕', '水聖誕'] },
                { name: '拉娜', aliases: ['拉娜'] },
                { name: '光狗', aliases: ['光狗'] },
                { name: '光狙', aliases: ['光狙'] },
                { name: '河北', aliases: ['河北'] },
                { name: '赤鬼', aliases: ['赤鬼'] },
                { name: '闆娘', aliases: ['闆娘', '版娘', '板娘'] },
                { name: '木刺', aliases: ['木刺'] },
                { name: '暗拳', aliases: ['暗拳'] },
                { name: '木串', aliases: ['木串', '莎莉斯特'] },
                { name: '木飛', aliases: ['木飛'] },
                { name: '火偶', aliases: ['火偶', '偶像', '火偶像'] },
                { name: '炸彈', aliases: ['炸彈', '女兒'] },
                { name: '水奶', aliases: ['水奶', '水盾奶', '水總理'] },
                // 新角色備域 - 方便後續添加
                { name: '暗魔王', aliases: ['暗魔王', '按摩王'] },
                { name: '木奶', aliases: ['木奶', '紅茶'] },
                { name: '水盾', aliases: ['水盾', '小水盾'] },
                { name: '東云', aliases: ['東云', '東雲'] },
                { name: '光埃', aliases: ['光埃', '光唉'] },
                { name: '天宮', aliases: ['光狼', '天宮'] },
                { name: '貓祭', aliases: ['貓娘', '貓祭'] },
                { name: '小總理', aliases: ['小總理', '利希', '小公主'] },
                { name: '新角色', aliases: ['新角色'] },
                { name: '暗熊', aliases: ['暗熊'] }
            ]);

            const [formData, setFormData] = useState({
                opponentTeam: ['', '', '', ''],
                myTeam: ['', '', '', ''],
                result: '勝', // 預設勝利
                opponentName: '', // 新增對手名稱欄位
                notes: '',
                rank: '',
                date: new Date().toISOString().split('T')[0],
                recorder: '玩家1'
            });

            const [teamSuggestions, setTeamSuggestions] = useState([]);
            const [counterSuggestions, setCounterSuggestions] = useState([]);
            
            const [counterDatabase, setCounterDatabase] = useState({
                '光鞭,蓋兒,光狙,血卡': [{ combo: ['水拳', '水馬', '水偶', 'LLB'], notes: '水系壓制' }],
                '河北,赤鬼,闆娘,水琴': [{ combo: ['光鞭', '暗飛', '蓋兒', '水琴'], notes: '光鞭體系' }]
            });

            const [communitySettings, setCommunitySettings] = useState({
                enabled: false,
                apiUrl: '',
                lastSync: null
            });

            // 常數定義（更新角色名稱）
            const commonCombos = useMemo(() => [
                { combo: ['光鞭', '暗飛', '蓋兒', '水琴'], winRate: 0.75 },
                { combo: ['蓋兒', '水琴', 'AOI', '光馬'], winRate: 0.72 },
                { combo: ['兔女郎', '暗飛', '血卡', '水琴'], winRate: 0.68 },
                { combo: ['蓋兒', '暗飛', '水琴', '血卡'], winRate: 0.70 },
                { combo: ['124', '蓋兒', 'AOI', '水琴'], winRate: 0.74 },
                { combo: ['水拳', '水馬', '水琴', 'LLB'], winRate: 0.73 },
                { combo: ['光鞭', '蓋兒', 'HKD', '光馬'], winRate: 0.69 },
                { combo: ['蓋兒', '124', '伊娃', '泳蘿'], winRate: 0.67 },
                { combo: ['光鞭', '蓋兒', '光狙', '木刺'], winRate: 0.71, name: '光鞭核爆' },
                { combo: ['河北', '赤鬼', '闆娘', '水琴'], winRate: 0.69, name: '河北國家隊' },
            ], []);

            const characterOptions = useMemo(() => {
                // 收集所有角色名稱和別稱
                const allOptions = [];
                characterAliases.forEach(char => {
                    // 添加正式名稱
                    allOptions.push(char.name);
                    // 添加所有別稱
                    char.aliases.forEach(alias => {
                        if (alias && alias !== char.name) {
                            allOptions.push(alias);
                        }
                    });
                });
                // 去重並排序
                return [...new Set(allOptions)].sort();
            }, [characterAliases]);

            // 統計資料
            const stats = useMemo(() => {
                const total = battleRecords.length;
                const wins = battleRecords.filter(r => r.result === '勝').length;
                const winRate = total > 0 ? (wins / total * 100).toFixed(1) : 0;
                return { total, wins, winRate };
            }, [battleRecords]);

            // 核心函數
            const convertAlias = useCallback((input) => {
                return Utils.convertAlias(input, characterAliases);
            }, [characterAliases]);

            const getTeamSuggestions = useCallback((team) => {
                if (team.filter(x => x).length >= 2) {
                    const convertedTeam = team.map(convertAlias);
                    const inputCount = convertedTeam.filter(char => char).length; // 用戶實際輸入的角色數量
                    const allSuggestions = [];
                    
                    // 1. 預設組合建議 - 限制最多2個
                    const defaultSuggestions = commonCombos.filter(combo => 
                        convertedTeam.some(char => char && combo.combo.includes(char))
                    ).map(combo => ({ ...combo, source: 'default' }))
                    .slice(0, 2); // 限制最多2個預設推薦
                    
                    // 2. 近期80筆資料建議 - 根據輸入數量調整匹配要求
                    const recentRecords = battleRecords.slice(-80);
                    const historySuggestions = {};
                    
                    // 根據用戶輸入數量決定最低匹配要求
                    let requiredMatchCount = 2; // 默認至少2個匹配
                    if (inputCount >= 4) {
                        requiredMatchCount = 4; // 4個角色時要求完全匹配
                    } else if (inputCount >= 3) {
                        requiredMatchCount = 3; // 3個角色時要求至少3個匹配
                    }
                    
                    recentRecords.forEach(record => {
                        const recordOpponent = record.opponentTeam.filter(char => char).map(convertAlias);
                        const matchCount = convertedTeam.filter(char => char && recordOpponent.includes(char)).length;
                        
                        // 使用動態的匹配要求
                        if (matchCount >= requiredMatchCount && recordOpponent.length >= 3) {
                            // 改用完整組合作為key，不排序，保持原始順序
                            const comboKey = recordOpponent.join(',');
                            
                            if (!historySuggestions[comboKey]) {
                                historySuggestions[comboKey] = {
                                    combo: recordOpponent,
                                    count: 0,
                                    matchCount: matchCount,
                                    source: 'history'
                                };
                            }
                            
                            historySuggestions[comboKey].count += 1;
                        }
                    });
                    
                    // 轉換歷史建議為標準格式，按匹配度和出現次數排序，限制最多4個
                    const historyArray = Object.values(historySuggestions)
                        .filter(suggestion => suggestion.count >= 1) // 至少出現1次就顯示
                        .map(suggestion => ({
                            combo: suggestion.combo,
                            winRate: suggestion.count / recentRecords.length, // 用於排序的頻率比例
                            count: suggestion.count, // 實際出現次數
                            matchCount: suggestion.matchCount, // 匹配的角色數量
                            source: 'history'
                        }))
                        .sort((a, b) => {
                            // 先按匹配度排序，再按出現次數排序
                            if (a.matchCount !== b.matchCount) {
                                return b.matchCount - a.matchCount;
                            }
                            return b.count - a.count;
                        })
                        .slice(0, 4); // 限制最多4個歷史組合
                    
                    // 合併建議，歷史數據優先
                    allSuggestions.push(...historyArray, ...defaultSuggestions);
                    
                    // 去重：但這次用更精確的邏輯
                    const uniqueSuggestions = [];
                    const seenCombos = new Set();
                    
                    for (const suggestion of allSuggestions) {
                        // 對於去重，還是要排序比較
                        const comboKey = suggestion.combo.slice().sort().join(',');
                        if (!seenCombos.has(comboKey)) {
                            seenCombos.add(comboKey);
                            uniqueSuggestions.push(suggestion);
                        }
                    }
                    
                    // 最終限制：最多6個建議（4個歷史 + 2個預設）
                    setTeamSuggestions(uniqueSuggestions.slice(0, 6));
                } else {
                    setTeamSuggestions([]);
                }
            }, [commonCombos, convertAlias, battleRecords]);

            const getCounterSuggestions = useCallback((opponentTeam) => {
                const fullOpponent = opponentTeam.filter(char => char).map(convertAlias);
                if (fullOpponent.length >= 3) {
                    const opponentKey = fullOpponent.sort().join(',');
                    const exactCounter = counterDatabase[opponentKey];
                    
                    let suggestions = [];
                    
                    if (exactCounter) {
                        suggestions = exactCounter.map(strategy => ({
                            ...strategy,
                            matchLevel: '完全匹配',
                            confidence: 0.95
                        }));
                    }

                    const threeCharMatches = battleRecords
                        .filter(record => {
                            if (record.result !== '勝') return false;
                            const recordOpponent = record.opponentTeam.filter(char => char).map(convertAlias);
                            const matchCount = fullOpponent.filter(char => recordOpponent.includes(char)).length;
                            return matchCount >= 3 && recordOpponent.length >= 3;
                        })
                        .slice(-68);

                    if (threeCharMatches.length > 0) {
                        const historySuggestions = threeCharMatches.map(record => {
                            const recordOpponent = record.opponentTeam.filter(char => char).map(convertAlias);
                            const matchCount = fullOpponent.filter(char => recordOpponent.includes(char)).length;
                            
                            const notesPart = record.notes ? ` - ${record.notes}` : '';
                            const opponentNamePart = record.opponentName ? `vs ${record.opponentName}` : '';
                            const combinedNotes = opponentNamePart + notesPart || '歷史勝場';
                            
                            if (matchCount === 4) {
                                return {
                                    combo: record.myTeam,
                                    notes: `${matchCount}/4角色匹配 - ${combinedNotes}`,
                                    matchLevel: '完全匹配',
                                    confidence: 0.95
                                };
                            } else {
                                return {
                                    combo: record.myTeam,
                                    notes: `${matchCount}/4角色匹配 - ${combinedNotes}`,
                                    matchLevel: '高度匹配',
                                    confidence: 0.70
                                };
                            }
                        })
                        .sort((a, b) => b.confidence - a.confidence)
                        .slice(0, 2);

                        suggestions = [...suggestions, ...historySuggestions];
                    }

                    // 如果沒有任何匹配或建議較少，添加通用建議
                    if (suggestions.length < 3) {
                        const generalSuggestions = [
                            { combo: ['水琴', '水馬', '光馬', '水偶'], notes: '水偶肉隊', matchLevel: '通用建議', confidence: 0.55 },
                            { combo: ['河北', '赤鬼', '闆娘', '暗拳'], notes: '河北國家隊', matchLevel: '通用建議', confidence: 0.52 },
                            { combo: ['光鞭', '蓋兒', '光狙', '木刺'], notes: '光鞭核爆', matchLevel: '通用建議', confidence: 0.52 }
                        ];
                        suggestions = [...suggestions, ...generalSuggestions.slice(0, 3 - suggestions.length)];
                    }

                    setCounterSuggestions(suggestions);
                } else {
                    setCounterSuggestions([]);
                }
            }, [convertAlias, counterDatabase, battleRecords]);

            // 單次上傳函數
            const uploadToCommunity = useCallback(async (record) => {
                if (!communitySettings.enabled || !communitySettings.apiUrl) {
                    console.log('Google Sheets同步未啟用或未配置');
                    return false;
                }

                // 驗證URL
                if (!SecurityUtils.validateGoogleSheetsUrl(communitySettings.apiUrl)) {
                    alert('❌ 不正確的API URL，請檢查您的Google Sheets設定');
                    return false;
                }

                if (record.uploaded) {
                    console.log('記錄已上傳，跳過');
                    return true;
                }

                try {
                    console.log('正在上傳資料到Google Sheets:', record);
                    
                    // 清理記錄數據 - 上傳時進行最終的清理
                    const sanitizedRecord = {
                        ...record,
                        recorder: SecurityUtils.cleanInput(record.recorder),
                        notes: SecurityUtils.cleanInput(record.notes, true),
                        opponentName: SecurityUtils.cleanInput(record.opponentName, true),
                        opponentTeam: record.opponentTeam.map(SecurityUtils.cleanInput),
                        myTeam: record.myTeam.map(SecurityUtils.cleanInput),
                        result: record.result === '勝' ? '贏' : record.result
                    };
                    
                    // 嘗試上傳到Google Sheets
                    await fetch(communitySettings.apiUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(sanitizedRecord)
                    });

                    // 由於no-cors無法檢查響應狀態，我們假設請求已發送成功
                    const currentTime = new Date().toISOString();
                    
                    // 立即更新本地狀態
                    setBattleRecords(prevRecords => {
                        console.log('更新記錄狀態, ID:', record.id);
                        return prevRecords.map(r => {
                            if (r.id === record.id) {
                                console.log('找到匹配記錄，更新上傳狀態');
                                return { ...r, uploaded: true, uploadedAt: currentTime };
                            }
                            return r;
                        });
                    });

                    setCommunitySettings(prev => ({
                        ...prev,
                        lastSync: currentTime
                    }));
                    
                    console.log('✅ 記錄已標記為上傳完成');
                    return true;
                    
                } catch (error) {
                    console.error('上傳失敗:', error);
                    // 即使發生錯誤，如果是網路問題但請求可能已發送，仍標記為已上傳
                    const currentTime = new Date().toISOString();
                    setBattleRecords(prevRecords => 
                        prevRecords.map(r => 
                            r.id === record.id 
                                ? { ...r, uploaded: true, uploadedAt: currentTime }
                                : r
                        )
                    );
                    setCommunitySettings(prev => ({
                        ...prev,
                        lastSync: currentTime
                    }));
                    return true; // 改為返回true，避免批量上傳中斷
                }
            }, [communitySettings]);

            // 批量上傳函數
            const uploadAllToCommunity = useCallback(async () => {
                if (!communitySettings.enabled || !communitySettings.apiUrl) {
                    alert('請先配置Google Sheets同步功能');
                    return;
                }

                // 驗證URL
                if (!SecurityUtils.validateGoogleSheetsUrl(communitySettings.apiUrl)) {
                    alert('❌ 檢測到不正確的API URL，請重新配置');
                    return;
                }

                if (battleRecords.length === 0) {
                    alert('沒有記錄可以上傳');
                    return;
                }

                const unUploadedRecords = battleRecords.filter(record => !record.uploaded);
                
                if (unUploadedRecords.length === 0) {
                    alert('🎉 所有記錄都已經上傳完成！');
                    return;
                }

                const recordSummary = unUploadedRecords.slice(0, 5).map((record, index) => 
                    `${index + 1}. ${SecurityUtils.sanitizeInput(record.recorder)} - ${record.date} (${record.result})`
                ).join('\n');
                
                const extraCount = unUploadedRecords.length > 5 ? `\n...等共${unUploadedRecords.length}筆` : '';
                const confirmMessage = `準備批量上傳 ${unUploadedRecords.length} 筆記錄到您的私人Google Sheets：\n\n${recordSummary}${extraCount}\n\n確定要開始上傳嗎？`;

                if (!confirm(confirmMessage)) {
                    return;
                }

                setUploadProgress({ current: 0, total: unUploadedRecords.length, isUploading: true });
                
                let successCount = 0;
                let errorCount = 0;
                
                for (let i = 0; i < unUploadedRecords.length; i++) {
                    const record = unUploadedRecords[i];
                    
                    setUploadProgress(prev => ({ ...prev, current: i + 1 }));
                    
                    try {
                        const success = await uploadToCommunity(record);
                        if (success) {
                            successCount++;
                        } else {
                            errorCount++;
                        }
                        
                        if (i < unUploadedRecords.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 800));
                        }
                    } catch (error) {
                        console.error('批次上傳失敗:', record.id, error);
                        errorCount++;
                    }
                }

                setUploadProgress({ current: 0, total: 0, isUploading: false });

                alert(`批量上傳完成！\n\n✅ 成功上傳：${successCount} 筆\n❌ 失敗/跳過：${errorCount} 筆\n📋 總處理：${successCount + errorCount} 筆\n\n請到您的私人Google Sheets檢查上傳結果`);
            }, [communitySettings, battleRecords, uploadToCommunity]);

            // 事件處理函數
            const handleInputChange = useCallback((field, value, index = null) => {
                if (index !== null) {
                    const newArray = [...formData[field]];
                    newArray[index] = SecurityUtils.cleanInput(value);
                    setFormData(prev => ({ ...prev, [field]: newArray }));
                    
                    if (field === 'opponentTeam') {
                        getTeamSuggestions(newArray);
                        getCounterSuggestions(newArray);
                    }
                } else {
                    // 對於備註和對手名稱欄位，允許空白，其他欄位清理
                    let cleanValue;
                    if (field === 'notes' || field === 'opponentName') {
                        cleanValue = SecurityUtils.cleanInput(value, true);
                        // 對手名稱限制16個字符
                        if (field === 'opponentName' && cleanValue.length > 16) {
                            cleanValue = cleanValue.substring(0, 16);
                        }
                    } else {
                        cleanValue = SecurityUtils.cleanInput(value);
                    }
                    setFormData(prev => ({ ...prev, [field]: cleanValue }));
                }
            }, [formData, getTeamSuggestions, getCounterSuggestions]);

            const applySuggestion = useCallback((suggestion, isOpponent = true) => {
                const field = isOpponent ? 'opponentTeam' : 'myTeam';
                const combo = suggestion.combo || suggestion;
                const sanitizedCombo = combo.map(SecurityUtils.sanitizeInput);
                setFormData(prev => ({ ...prev, [field]: sanitizedCombo }));
                if (isOpponent) {
                    getCounterSuggestions(sanitizedCombo);
                }
            }, [getCounterSuggestions]);

            const handleSubmit = useCallback(() => {
                if (!formData.result || !formData.rank) {
                    alert('請填寫完整的勝負結果和排位信息');
                    return;
                }

                const newRecord = {
                    id: Date.now(),
                    opponentTeam: formData.opponentTeam.map(char => convertAlias(SecurityUtils.cleanInput(char))),
                    myTeam: formData.myTeam.map(char => convertAlias(SecurityUtils.cleanInput(char))),
                    result: SecurityUtils.cleanInput(formData.result),
                    opponentName: SecurityUtils.cleanInput(formData.opponentName, true).substring(0, 16), // 限制16字符
                    notes: SecurityUtils.cleanInput(formData.notes, true), // 保存時允許空白
                    rank: SecurityUtils.cleanInput(formData.rank),
                    date: SecurityUtils.cleanInput(formData.date),
                    recorder: SecurityUtils.cleanInput(formData.recorder),
                    uploaded: false,
                    uploadedAt: null
                };
                
                setBattleRecords(prev => [...prev, newRecord]);
                
                // 保持記錄者和排位
                const lastRank = formData.rank;
                const lastRecorder = formData.recorder;
                
                setFormData({
                    opponentTeam: ['', '', '', ''],
                    myTeam: ['', '', '', ''],
                    result: '勝', // 重置為預設勝利
                    opponentName: '', // 重置對手名稱
                    notes: '',
                    rank: lastRank,
                    date: new Date().toISOString().split('T')[0],
                    recorder: lastRecorder
                });
                
                setTeamSuggestions([]);
                setCounterSuggestions([]);
                
                alert('✅ 紀錄已保存！');
            }, [formData, convertAlias]);

            const handleUploadSingle = useCallback(() => {
                if (!formData.result || !formData.rank) {
                    alert('請先填寫完整資訊並保存紀錄');
                    return;
                }
                const record = {
                    opponentTeam: formData.opponentTeam.map(char => convertAlias(SecurityUtils.cleanInput(char))),
                    myTeam: formData.myTeam.map(char => convertAlias(SecurityUtils.cleanInput(char))),
                    result: SecurityUtils.cleanInput(formData.result),
                    opponentName: SecurityUtils.cleanInput(formData.opponentName, true).substring(0, 16),
                    notes: SecurityUtils.cleanInput(formData.notes, true),
                    rank: SecurityUtils.cleanInput(formData.rank),
                    date: SecurityUtils.cleanInput(formData.date),
                    recorder: SecurityUtils.cleanInput(formData.recorder),
                    uploaded: false,
                    uploadedAt: null
                };
                uploadToCommunity(record);
            }, [formData, convertAlias, uploadToCommunity]);

            const addToCounterDatabase = useCallback((record) => {
                const opponentTeam = record.opponentTeam.filter(char => char).map(convertAlias);
                const myTeam = record.myTeam.filter(char => char);
                
                if (opponentTeam.length < 3) {
                    alert('對手陣容角色數量不足');
                    return;
                }

                const key = opponentTeam.sort().join(',');
                
                let shouldAdd = true;
                if (counterDatabase[key]) {
                    shouldAdd = confirm(`已存在針對「${opponentTeam.join('+')}」的反制策略，是否覆蓋？`);
                }

                if (shouldAdd) {
                    const strategy = {
                        combo: myTeam,
                        notes: record.notes ? `${SecurityUtils.cleanInput(record.notes, true)} (來自歷史)` : `${record.date} 勝場策略`
                    };

                    setCounterDatabase(prev => ({
                        ...prev,
                        [key]: [strategy]
                    }));

                    alert(`✅ 已將勝場策略加入反制資料庫！\n對手：${opponentTeam.join('+')}\n反制：${myTeam.join('+')}`);
                }
            }, [convertAlias, counterDatabase]);

            const deleteRecord = useCallback((recordId) => {
                if (confirm('確定要刪除此記錄嗎？此操作不可復原！')) {
                    setBattleRecords(prev => prev.filter(record => record.id !== recordId));
                    alert('✅ 記錄已刪除！');
                }
            }, []);

            // 新增：按日期批量刪除記錄
            const deleteBatchByDate = useCallback((beforeDate) => {
                if (!beforeDate) {
                    alert('請選擇日期');
                    return;
                }

                // 過濾出要刪除的記錄
                const recordsToDelete = battleRecords.filter(record => {
                    const recordDate = new Date(record.date + 'T00:00:00');
                    const cutoffDate = new Date(beforeDate + 'T00:00:00');
                    return recordDate < cutoffDate;
                });

                if (recordsToDelete.length === 0) {
                    alert('📅 沒有找到符合條件的記錄');
                    return;
                }

                // 統計信息
                const uploadedCount = recordsToDelete.filter(r => r.uploaded).length;
                const notUploadedCount = recordsToDelete.length - uploadedCount;
                
                // 顯示詳細確認信息
                const confirmMessage = `⚠️ 準備刪除 ${beforeDate} 之前的所有對戰記錄：

📊 刪除統計：
• 總計：${recordsToDelete.length} 筆記錄
• 已上傳：${uploadedCount} 筆
• 未上傳：${notUploadedCount} 筆

📋 最近幾筆記錄預覽：
${recordsToDelete.slice(0, 5).map((record, index) => 
    `${index + 1}. ${record.date} - ${SecurityUtils.sanitizeInput(record.recorder)} (${record.result}) ${record.uploaded ? '✅' : '⏳'}`
).join('\n')}${recordsToDelete.length > 5 ? `\n...等共${recordsToDelete.length}筆` : ''}

⚠️ 此操作將永久刪除這些記錄，無法復原！
建議在刪除前先進行完整備份。

確定要繼續嗎？`;

                if (!confirm(confirmMessage)) {
                    return;
                }

                // 二次確認
                if (!confirm(`🔴 最後確認：您即將刪除 ${recordsToDelete.length} 筆記錄（包含 ${uploadedCount} 筆已上傳記錄）\n\n此操作不可復原，確定繼續嗎？`)) {
                    return;
                }

                // 執行刪除
                setBattleRecords(prev => {
                    const recordIdsToDelete = new Set(recordsToDelete.map(r => r.id));
                    const newRecords = prev.filter(record => !recordIdsToDelete.has(record.id));
                    
                    // 在狀態更新後顯示完成訊息
                    setTimeout(() => {
                        alert(`✅ 批量刪除完成！\n\n📊 刪除統計：\n• 總計：${recordsToDelete.length} 筆\n• 已上傳：${uploadedCount} 筆\n• 未上傳：${notUploadedCount} 筆\n\n剩餘記錄：${newRecords.length} 筆`);
                    }, 0);
                    
                    return newRecords;
                });
            }, [battleRecords]);

            const resetData = useCallback(() => {
                if (confirm('確定要重置所有資料嗎？此操作不可復原！')) {
                    // 清理localStorage
                    const keysToRemove = [
                        'arkrecode_dataVersion', 'arkrecode_battleRecords', 
                        'arkrecode_characterAliases', 'arkrecode_counterDatabase', 
                        'arkrecode_communitySettings', 'arkrecode_disclaimer_accepted',
                        'arkrecode_formData'
                    ];
                    
                    keysToRemove.forEach(key => {
                        try {
                            localStorage.removeItem(key);
                        } catch (error) {
                            console.error('清理localStorage失敗:', error);
                        }
                    });
                    
                    setBattleRecords([]);
                    setCounterDatabase({});
                    setCommunitySettings({ enabled: false, apiUrl: '', lastSync: null });
                    alert('資料已重置！');
                }
            }, []);

            const importData = useCallback((event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                // 檢查文件大小（最大10MB）
                if (file.size > 10 * 1024 * 1024) {
                    alert('❌ 檔案太大，請選擇小於10MB的檔案');
                    event.target.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // 驗證導入的數據
                        if (data.battleRecords && Array.isArray(data.battleRecords)) {
                            const sanitizedRecords = data.battleRecords.map(record => ({
                                ...record,
                                recorder: SecurityUtils.cleanInput(record.recorder || ''),
                                notes: SecurityUtils.cleanInput(record.notes || '', true),
                                opponentName: SecurityUtils.cleanInput(record.opponentName || '', true).substring(0, 16),
                                opponentTeam: (record.opponentTeam || []).map(SecurityUtils.cleanInput),
                                myTeam: (record.myTeam || []).map(SecurityUtils.cleanInput),
                                // 簡單轉換：贏 -> 勝
                                result: record.result === '贏' ? '勝' : record.result
                            }));
                            setBattleRecords(sanitizedRecords);
                        }
                        
                        if (data.characterAliases && Array.isArray(data.characterAliases)) {
                            const sanitizedAliases = data.characterAliases.map(alias => ({
                                name: SecurityUtils.cleanInput(alias.name || ''),
                                aliases: (alias.aliases || []).map(SecurityUtils.cleanInput)
                            }));
                            setCharacterAliases(sanitizedAliases);
                        }
                        
                        if (data.counterDatabase && typeof data.counterDatabase === 'object') {
                            setCounterDatabase(data.counterDatabase);
                        }
                        
                        if (data.communitySettings && typeof data.communitySettings === 'object') {
                            // 驗證Google Sheets URL
                            if (data.communitySettings.apiUrl && !SecurityUtils.validateGoogleSheetsUrl(data.communitySettings.apiUrl)) {
                                alert('⚠️ 導入的Google Sheets URL不正確，已清除該設定');
                                setCommunitySettings({ ...data.communitySettings, apiUrl: '' });
                            } else {
                                setCommunitySettings(data.communitySettings);
                            }
                        }
                        
                        alert('✅ 資料已導入！');
                    } catch (error) {
                        console.error('導入資料錯誤:', error);
                        alert('❌ 導入失敗：文件格式錯誤');
                    }
                };
                reader.onerror = () => {
                    alert('❌ 檔案讀取失敗');
                };
                reader.readAsText(file);
                event.target.value = '';
            }, []);

            // 檢查免責聲明接受狀態
            useEffect(() => {
                const accepted = localStorage.getItem('arkrecode_disclaimer_accepted');
                if (accepted === 'true') {
                    setDisclaimerAccepted(true);
                }
                
                // 檢查瀏覽器存儲支援
                if (!SecurityUtils.checkStorageSupport()) {
                    alert('⚠️ 您的瀏覽器不支援本地存儲，建議使用現代瀏覽器以確保最佳體驗');
                }
            }, []);

            // 接受免責聲明
            const handleAcceptDisclaimer = useCallback(() => {
                localStorage.setItem('arkrecode_disclaimer_accepted', 'true');
                setDisclaimerAccepted(true);
                alert('✅ 歡迎使用 ArkRecode v2.5.3！您的資料將存儲在本機瀏覽器中。');
            }, []);

            // 拒絕免責聲明
            const handleDeclineDisclaimer = useCallback(() => {
                alert('感謝您的關注，為了您的安全，請在充分了解風險後再使用本工具。');
            }, []);

            // 資料持久化
            useEffect(() => {
                if (!disclaimerAccepted) return;
                
                try {
                    const savedRecords = localStorage.getItem('arkrecode_battleRecords');
                    const savedAliases = localStorage.getItem('arkrecode_characterAliases');
                    const savedCounters = localStorage.getItem('arkrecode_counterDatabase');
                    const savedCommunitySettings = localStorage.getItem('arkrecode_communitySettings');
                    const savedFormData = localStorage.getItem('arkrecode_formData');
                    const dataVersion = localStorage.getItem('arkrecode_dataVersion');
                    const hasVisitedBefore = localStorage.getItem('arkrecode_hasVisited');
                    
                    if (savedRecords) {
                        try {
                            const records = SecurityUtils.deobfuscateData(savedRecords);
                            if (records && Array.isArray(records)) {
                                const updatedRecords = records.map(record => ({
                                    ...record,
                                    uploaded: record.uploaded !== undefined ? record.uploaded : false,
                                    uploadedAt: record.uploadedAt || null,
                                    // 簡單轉換：贏 -> 勝
                                    result: record.result === '贏' ? '勝' : record.result
                                }));
                                
                                setBattleRecords(updatedRecords);
                                console.log(`載入 ${updatedRecords.length} 筆對戰紀錄`);
                            }
                            
                            if (dataVersion !== '2.5.3') {
                                console.log(`版本從 ${dataVersion || '舊版'} 升級到 2.5.3`);
                                localStorage.setItem('arkrecode_dataVersion', '2.5.3');
                            }
                            
                        } catch (parseError) {
                            console.error('解析儲存資料失敗:', parseError);
                            if (hasVisitedBefore && confirm('⚠️ 偵測到儲存資料可能損壞！\n是否要重置為預設資料？\n\n點擊「確定」重置，「取消」保持空白資料')) {
                                setBattleRecords([
                                    {
                                        id: Date.now() - 3000,
                                        recorder: '測試',
                                        date: '2025-08-01',
                                        opponentTeam: ['光鞭', '蓋兒', '光狙', '血卡'],
                                        myTeam: ['水拳', '水馬', '水琴', 'LLB'],
                                        result: '勝',
                                        rank: '挑戰者',
                                        notes: '測試記錄',
                                        opponentName: '測試對手',
                                        uploaded: false,
                                        uploadedAt: null
                                    }
                                ]);
                            }
                        }
                    } else {
                        if (!hasVisitedBefore) {
                            console.log('👋 歡迎首次使用 ArkRecode v2.5.3！');
                            setBattleRecords([]);
                            localStorage.setItem('arkrecode_hasVisited', 'true');
                        }
                        localStorage.setItem('arkrecode_dataVersion', '2.5.3');
                    }
                    
                    if (savedAliases) {
                        try {
                            const aliases = SecurityUtils.deobfuscateData(savedAliases);
                            if (aliases && Array.isArray(aliases)) {
                                setCharacterAliases(aliases);
                            }
                        } catch (error) {
                            console.warn('角色別稱資料載入失敗，使用預設值');
                        }
                    }
                    
                    if (savedCounters) {
                        try {
                            const counters = SecurityUtils.deobfuscateData(savedCounters);
                            if (counters && typeof counters === 'object') {
                                setCounterDatabase(counters);
                            }
                        } catch (error) {
                            console.warn('反制策略資料載入失敗，使用預設值');
                        }
                    }

                    if (savedCommunitySettings) {
                        try {
                            const settings = SecurityUtils.deobfuscateData(savedCommunitySettings);
                            if (settings && typeof settings === 'object') {
                                // 驗證Google Sheets URL
                                if (settings.apiUrl && !SecurityUtils.validateGoogleSheetsUrl(settings.apiUrl)) {
                                    console.warn('檢測到不正確的Google Sheets URL，已清除');
                                    setCommunitySettings({ ...settings, apiUrl: '', enabled: false });
                                } else {
                                    setCommunitySettings(settings);
                                }
                            }
                        } catch (error) {
                            console.warn('社群設定載入失敗，使用預設值');
                        }
                    }

                    // 載入保存的表單數據（記錄者和排位）
                    if (savedFormData) {
                        try {
                            const formDataSaved = SecurityUtils.deobfuscateData(savedFormData);
                            if (formDataSaved && typeof formDataSaved === 'object') {
                                setFormData(prev => ({
                                    ...prev,
                                    recorder: SecurityUtils.cleanInput(formDataSaved.recorder || prev.recorder),
                                    rank: SecurityUtils.cleanInput(formDataSaved.rank || prev.rank)
                                }));
                            }
                        } catch (error) {
                            console.warn('表單資料載入失敗，使用預設值');
                        }
                    }
                    
                    if (!hasVisitedBefore) {
                        localStorage.setItem('arkrecode_hasVisited', 'true');
                    }
                    
                } catch (error) {
                    console.error('整體載入資料失敗:', error);
                    alert('⚠️ 資料載入時發生錯誤，可能需要重置應用程式');
                }
            }, [disclaimerAccepted]);

            // 自動保存
            useEffect(() => {
                if (!disclaimerAccepted) return;
                
                try {
                    const obfuscatedData = SecurityUtils.obfuscateData(battleRecords);
                    localStorage.setItem('arkrecode_battleRecords', obfuscatedData);
                } catch (error) {
                    console.error('保存對戰記錄失敗:', error);
                }
            }, [battleRecords, disclaimerAccepted]);

            useEffect(() => {
                if (!disclaimerAccepted) return;
                
                try {
                    const obfuscatedData = SecurityUtils.obfuscateData(characterAliases);
                    localStorage.setItem('arkrecode_characterAliases', obfuscatedData);
                } catch (error) {
                    console.error('保存角色別稱失敗:', error);
                }
            }, [characterAliases, disclaimerAccepted]);
            
            useEffect(() => {
                if (!disclaimerAccepted) return;
                
                try {
                    const obfuscatedData = SecurityUtils.obfuscateData(counterDatabase);
                    localStorage.setItem('arkrecode_counterDatabase', obfuscatedData);
                } catch (error) {
                    console.error('保存反制資料庫失敗:', error);
                }
            }, [counterDatabase, disclaimerAccepted]);

            useEffect(() => {
                if (!disclaimerAccepted) return;
                
                try {
                    const obfuscatedData = SecurityUtils.obfuscateData(communitySettings);
                    localStorage.setItem('arkrecode_communitySettings', obfuscatedData);
                } catch (error) {
                    console.error('保存社群設定失敗:', error);
                }
            }, [communitySettings, disclaimerAccepted]);

            // 保存表單數據（記錄者和排位）
            useEffect(() => {
                if (!disclaimerAccepted) return;
                
                try {
                    const formDataToSave = {
                        recorder: formData.recorder,
                        rank: formData.rank
                    };
                    const obfuscatedData = SecurityUtils.obfuscateData(formDataToSave);
                    localStorage.setItem('arkrecode_formData', obfuscatedData);
                } catch (error) {
                    console.error('保存表單資料失敗:', error);
                }
            }, [formData.recorder, formData.rank, disclaimerAccepted]);

            // 如果尚未接受免責聲明，顯示免責聲明對話框
            if (!disclaimerAccepted) {
                return (
                    <DisclaimerModal 
                        onAccept={handleAcceptDisclaimer}
                        onDecline={handleDeclineDisclaimer}
                    />
                );
            }

            // 渲染主應用
            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-2">
                    <div className="max-w-6xl mx-auto">
                        {/* 標題列 */}
                        <div className="bg-white rounded-lg shadow-lg mb-4 p-3">
                            <div className="flex flex-wrap gap-3 items-center justify-between">
                                <h1 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                                    <IconComponents.Trophy className="text-yellow-500" size={24} />
                                    ArkRecode 對戰紀錄器 v2.5.3
                                </h1>
                                <div className="flex gap-1">
                                    <button
                                        onClick={() => setCurrentView('record')}
                                        className={`px-3 py-1 rounded text-sm flex items-center gap-1 ${
                                            currentView === 'record' ? 'bg-blue-500 text-white' : 'bg-gray-200'
                                        }`}
                                    >
                                        <IconComponents.Plus size={14} />
                                        紀錄
                                    </button>
                                    <button
                                        onClick={() => setCurrentView('history')}
                                        className={`px-3 py-1 rounded text-sm flex items-center gap-1 ${
                                            currentView === 'history' ? 'bg-blue-500 text-white' : 'bg-gray-200'
                                        }`}
                                    >
                                        <IconComponents.FileText size={14} />
                                        歷史
                                    </button>
                                    <button
                                        onClick={() => setCurrentView('settings')}
                                        className={`px-3 py-1 rounded text-sm flex items-center gap-1 ${
                                            currentView === 'settings' ? 'bg-blue-500 text-white' : 'bg-gray-200'
                                        }`}
                                    >
                                        <IconComponents.Settings size={14} />
                                        設定
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* 批量上傳進度條 */}
                        {uploadProgress.isUploading && (
                            <div className="bg-white rounded-lg shadow p-4 mb-4">
                                <div className="flex justify-between items-center mb-2">
                                    <span className="text-sm font-medium">批量上傳進度</span>
                                    <span className="text-sm text-gray-600">
                                        {uploadProgress.current} / {uploadProgress.total}
                                    </span>
                                </div>
                                <div className="upload-progress">
                                    <div 
                                        className="upload-progress-bar" 
                                        style={{ 
                                            width: `${(uploadProgress.current / uploadProgress.total) * 100}%` 
                                        }}
                                    ></div>
                                </div>
                                <div className="text-xs text-gray-500 mt-1">
                                    正在上傳第 {uploadProgress.current} 筆記錄...
                                </div>
                            </div>
                        )}

                        {/* 主要內容區 */}
                        {currentView === 'record' && (
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
                                <BattleForm
                                    formData={formData}
                                    onInputChange={handleInputChange}
                                    onSubmit={handleSubmit}
                                    characterOptions={characterOptions}
                                    teamSuggestions={teamSuggestions}
                                    counterSuggestions={counterSuggestions}
                                    onApplySuggestion={applySuggestion}
                                    onUploadSingle={handleUploadSingle}
                                    communitySettings={communitySettings}
                                />

                                <div className="space-y-4">
                                    <StatsComponents.StatsDashboard
                                        stats={stats}
                                        onExportData={() => Utils.exportData({
                                            battleRecords,
                                            characterAliases,
                                            counterDatabase,
                                            communitySettings
                                        })}
                                        onBatchUpload={uploadAllToCommunity}
                                        communitySettings={communitySettings}
                                        battleRecords={battleRecords}
                                    />
                                </div>
                            </div>
                        )}

                        {currentView === 'history' && (
                            <HistoryTable
                                records={battleRecords}
                                onAddToCounter={addToCounterDatabase}
                                onUploadRecord={uploadToCommunity}
                                onDeleteRecord={deleteRecord}
                                onDeleteBatchByDate={deleteBatchByDate}
                                onResetData={resetData}
                                onImportData={importData}
                                communitySettings={communitySettings}
                                sortBy={sortBy}
                                onSortChange={setSortBy}
                                characterOptions={characterOptions}
                                convertAlias={convertAlias}
                                // 新增這兩行
                                onSetFormData={setFormData}
                                onSetCurrentView={setCurrentView}
                            />
                        )}

                        {currentView === 'settings' && (
                            <div className="space-y-4">
                                {/* Google Sheets 同步設定 */}
                                <div className="bg-white rounded-lg shadow-lg p-4">
                                    <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <IconComponents.Shield className="text-purple-500" size={20} />
                                        Google Sheets 同步
                                    </h2>
                                    
                                    <div className="space-y-4">
                                        <div className="p-4 bg-purple-50 rounded-lg">
                                            <h3 className="font-medium text-purple-800 mb-2">🛡️ 功能特色</h3>
                                            <div className="text-sm text-purple-700 space-y-2">
                                                <div>🔒 <strong>URL驗證</strong>：只允許Google域名</div>
                                                <div>🧹 <strong>資料清理</strong>：上傳前自動清理所有輸入</div>
                                                <div>🔐 <strong>私人同步</strong>：每個用戶使用獨立的API URL</div>
                                                <div>⚡ <strong>一鍵批量</strong>：優化的批量上傳體驗</div>
                                            </div>
                                        </div>

                                        <div className="border rounded-lg p-4">
                                            <div className="flex items-center gap-3 mb-3">
                                                <label className="flex items-center cursor-pointer">
                                                    <input
                                                        type="checkbox"
                                                        checked={communitySettings.enabled}
                                                        onChange={(e) => setCommunitySettings(prev => ({
                                                            ...prev,
                                                            enabled: e.target.checked
                                                        }))}
                                                        className="mr-2"
                                                    />
                                                    <span className="font-medium">啟用Google Sheets同步</span>
                                                </label>
                                            </div>

                                            {communitySettings.enabled && (
                                                <div className="space-y-3">
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                                            您的私人Google Apps Script URL:
                                                        </label>
                                                        <input
                                                            type="url"
                                                            value={communitySettings.apiUrl}
                                                            onChange={(e) => {
                                                                const url = SecurityUtils.cleanInput(e.target.value);
                                                                if (url && !SecurityUtils.validateGoogleSheetsUrl(url)) {
                                                                    alert('⚠️ 請輸入有效的Google Apps Script URL');
                                                                    return;
                                                                }
                                                                setCommunitySettings(prev => ({
                                                                    ...prev,
                                                                    apiUrl: url
                                                                }));
                                                            }}
                                                            placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec"
                                                            className="w-full text-sm border rounded px-3 py-2 focus:ring-1 focus:ring-purple-500"
                                                        />
                                                        <div className="text-xs text-gray-500 mt-1">
                                                            系統會自動驗證URL
                                                        </div>
                                                    </div>

                                                    <div className="flex gap-2">
                                                        <button
                                                            onClick={() => {
                                                                if (!communitySettings.apiUrl) {
                                                                    alert('請先輸入API URL');
                                                                    return;
                                                                }
                                                                
                                                                if (!SecurityUtils.validateGoogleSheetsUrl(communitySettings.apiUrl)) {
                                                                    alert('❌ URL驗證失敗，請檢查您的Google Sheets設定');
                                                                    return;
                                                                }
                                                                
                                                                const testRecord = {
                                                                    recorder: '測試用戶',
                                                                    date: new Date().toLocaleDateString('zh-TW'),
                                                                    opponentTeam: ['測試角色1', '測試角色2', '', ''],
                                                                    myTeam: ['測試角色3', '測試角色4', '', ''],
                                                                    result: '勝',
                                                                    rank: '測試排位',
                                                                    opponentName: '測試對手',
                                                                    notes: `v2.5.3測試 - ${new Date().toLocaleString('zh-TW')}`
                                                                };
                                                                uploadToCommunity(testRecord);
                                                                alert('測試上傳完成！請到您的私人Google Sheets確認');
                                                            }}
                                                            className="px-3 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600"
                                                        >
                                                            測試連接
                                                        </button>
                                                        
                                                        <button
                                                            onClick={() => window.open('https://docs.google.com/', '_blank')}
                                                            className="px-3 py-1 text-xs bg-green-500 text-white rounded hover:bg-green-600"
                                                        >
                                                            開啟Google Sheets
                                                        </button>
                                                        
                                                        <button
                                                            onClick={() => {
                                                                alert('提醒：\n\n1. 只與信任的人分享您的Google Sheets\n2. 定期檢查資料是否正確\n3. 如發現異常請立即停用同步\n4. 建議使用專用的Google帳戶');
                                                            }}
                                                            className="px-3 py-1 text-xs bg-yellow-500 text-white rounded hover:bg-yellow-600"
                                                        >
                                                            使用提醒
                                                        </button>
                                                    </div>

                                                    {communitySettings.lastSync && (
                                                        <div className="text-xs text-gray-500">
                                                            最後同步: {new Date(communitySettings.lastSync).toLocaleString('zh-TW', { 
                                                                month: 'numeric', 
                                                                day: 'numeric', 
                                                                hour: '2-digit', 
                                                                minute: '2-digit' 
                                                            })}
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                {/* 資料備份與匯入 */}
                                <div className="bg-white rounded-lg shadow-lg p-4">
                                    <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <IconComponents.Shield className="text-blue-500" size={20} />
                                        資料管理
                                    </h2>
                                    
                                    <div className="space-y-4">
                                        <div className="p-4 bg-blue-50 rounded-lg">
                                            <h3 className="font-medium text-blue-800 mb-2">✅ 資料保護</h3>
                                            <div className="text-sm text-blue-700 space-y-1">
                                                <div>🔐 資料已加密混淆存儲在瀏覽器中</div>
                                                <div>🛡️ 匯入時自動清理惡意內容</div>
                                                <div>🏷️ 備份包含驗證標記</div>
                                                <div>📄 建議定期備份重要資料</div>
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-1 gap-2">
                                            <button
                                                onClick={() => Utils.exportData({
                                                    battleRecords,
                                                    characterAliases,
                                                    counterDatabase,
                                                    communitySettings
                                                })}
                                                disabled={battleRecords.length === 0}
                                                className={`px-4 py-2 rounded text-sm flex items-center justify-center gap-2 ${
                                                    battleRecords.length === 0
                                                        ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                                        : 'bg-blue-500 text-white hover:bg-blue-600'
                                                }`}
                                            >
                                                <IconComponents.Shield size={16} />
                                                完整備份 (JSON)
                                            </button>
                                            
                                            <button
                                                onClick={() => Utils.exportToCSV(battleRecords)}
                                                disabled={battleRecords.length === 0}
                                                className={`px-4 py-2 rounded text-sm flex items-center justify-center gap-2 ${
                                                    battleRecords.length === 0
                                                        ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                                        : 'bg-green-500 text-white hover:bg-green-600'
                                                }`}
                                            >
                                                <IconComponents.Upload size={16} />
                                                匯出CSV
                                            </button>
                                        </div>
                                        
                                        <div className="p-3 bg-yellow-50 rounded-lg">
                                            <div className="text-sm text-yellow-700">
                                                <strong>匯入說明：</strong><br />
                                                • 僅接受10MB以下的JSON檔案<br />
                                                • 自動驗證和清理導入資料<br />
                                                • 不正確的Google Sheets URL會被移除<br />
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* 反制策略管理 */}
                                <div className="bg-white rounded-lg shadow-lg p-4">
                                    <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <IconComponents.Target className="text-purple-500" size={20} />
                                        🎯 反制策略管理
                                    </h2>
                                    
                                    <div className="space-y-4">
                                        <div className="p-4 bg-purple-50 rounded-lg">
                                            <h3 className="font-medium text-purple-800 mb-2">🛡️ 策略資料庫</h3>
                                            <div className="text-sm text-purple-700 space-y-1">
                                                <div>📚 目前共有 {Object.keys(counterDatabase).length} 組策略</div>
                                                <div>🎯 <strong>匹配優先級：</strong></div>
                                                <ol className="ml-4 space-y-1 text-xs">
                                                    <li>1️⃣ <strong>完全匹配</strong> - 4個角色完全相同（最準確）</li>
                                                    <li>2️⃣ <strong>高度匹配</strong> - 3個角色相同（高可信度）</li>
                                                    <li>3️⃣ <strong>通用建議</strong> - 萬能組合（保底方案）</li>
                                                </ol>
                                            </div>
                                        </div>

                                        {/* 手動新增反制策略 */}
                                        <div className="border-2 border-dashed border-blue-300 rounded-lg p-4 bg-blue-50">
                                            <h4 className="font-medium text-blue-800 mb-3 flex items-center gap-2">
                                                <IconComponents.Shield size={16} />
                                                新增反制策略
                                            </h4>
                                            
                                            <div className="space-y-3">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">對手陣容:</label>
                                                    <div className="grid grid-cols-4 gap-2">
                                                        {[0, 1, 2, 3].map((idx) => (
                                                            <input
                                                                key={idx}
                                                                type="text"
                                                                placeholder={`對手${idx + 1}`}
                                                                className="text-sm border rounded px-2 py-1 focus:ring-1 focus:ring-blue-500"
                                                                list={`manual-opponent-${idx}-options`}
                                                                id={`manualOpponent${idx}`}
                                                                maxLength="20"
                                                                onChange={(e) => {
                                                                    e.target.value = SecurityUtils.cleanInput(e.target.value);
                                                                }}
                                                            />
                                                        ))}
                                                        {[0, 1, 2, 3].map((idx) => (
                                                            <datalist key={idx} id={`manual-opponent-${idx}-options`}>
                                                                {characterOptions.map(option => (
                                                                    <option key={option} value={option} />
                                                                ))}
                                                            </datalist>
                                                        ))}
                                                    </div>
                                                </div>

                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">反制陣容:</label>
                                                    <div className="grid grid-cols-4 gap-2">
                                                        {[0, 1, 2, 3].map((idx) => (
                                                            <input
                                                                key={idx}
                                                                type="text"
                                                                placeholder={`反制${idx + 1}`}
                                                                className="text-sm border rounded px-2 py-1 focus:ring-1 focus:ring-blue-500"
                                                                list={`manual-counter-${idx}-options`}
                                                                id={`manualCounter${idx}`}
                                                                maxLength="20"
                                                                onChange={(e) => {
                                                                    e.target.value = SecurityUtils.cleanInput(e.target.value);
                                                                }}
                                                            />
                                                        ))}
                                                        {[0, 1, 2, 3].map((idx) => (
                                                            <datalist key={idx} id={`manual-counter-${idx}-options`}>
                                                                {characterOptions.map(option => (
                                                                    <option key={option} value={option} />
                                                                ))}
                                                            </datalist>
                                                        ))}
                                                    </div>
                                                </div>

                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">策略備註:</label>
                                                    <input
                                                        type="text"
                                                        placeholder="策略說明、使用心得等..."
                                                        className="w-full text-sm border rounded px-2 py-1 focus:ring-1 focus:ring-blue-500"
                                                        id="manualNotes"
                                                        maxLength="200"
                                                        onChange={(e) => {
                                                            e.target.value = SecurityUtils.cleanInput(e.target.value, true);
                                                        }}
                                                    />
                                                </div>

                                                <button
                                                    onClick={() => {
                                                        // 取得輸入的對手陣容
                                                        const opponentTeam = [0, 1, 2, 3].map(i => {
                                                            const element = document.getElementById(`manualOpponent${i}`);
                                                            return convertAlias(SecurityUtils.cleanInput(element.value.trim()));
                                                        }).filter(char => char);

                                                        // 取得輸入的反制陣容
                                                        const counterTeam = [0, 1, 2, 3].map(i => {
                                                            const element = document.getElementById(`manualCounter${i}`);
                                                            return convertAlias(SecurityUtils.cleanInput(element.value.trim()));
                                                        }).filter(char => char);

                                                        // 取得策略備註
                                                        const notes = SecurityUtils.cleanInput(document.getElementById('manualNotes').value.trim(), true);

                                                        // 驗證輸入
                                                        if (opponentTeam.length < 3) {
                                                            alert('請至少輸入3個對手角色');
                                                            return;
                                                        }

                                                        if (counterTeam.length < 3) {
                                                            alert('請至少輸入3個反制角色');
                                                            return;
                                                        }

                                                        // 生成策略鍵值
                                                        const key = opponentTeam.sort().join(',');

                                                        // 檢查是否已存在
                                                        if (counterDatabase[key]) {
                                                            if (!confirm(`已存在針對「${opponentTeam.join('+')}」的反制策略，是否覆蓋？`)) {
                                                                return;
                                                            }
                                                        }

                                                        // 添加到反制資料庫
                                                        const strategy = {
                                                            combo: counterTeam,
                                                            notes: notes || '手動新增策略'
                                                        };

                                                        setCounterDatabase(prev => ({
                                                            ...prev,
                                                            [key]: [strategy]
                                                        }));

                                                        // 清空輸入欄位
                                                        [0, 1, 2, 3].forEach(i => {
                                                            document.getElementById(`manualOpponent${i}`).value = '';
                                                            document.getElementById(`manualCounter${i}`).value = '';
                                                        });
                                                        document.getElementById('manualNotes').value = '';

                                                        alert(`✅ 反制策略已新增！\n對手：${opponentTeam.join('+')}\n反制：${counterTeam.join('+')}`);
                                                    }}
                                                    className="w-full bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 font-medium flex items-center justify-center gap-2"
                                                >
                                                    <IconComponents.Shield size={16} />
                                                    新增策略
                                                </button>
                                            </div>
                                        </div>

                                        {/* 現有策略列表 */}
                                        <div>
                                            <h4 className="font-medium text-gray-800 mb-2 flex items-center gap-2">
                                                <IconComponents.Shield size={16} className="text-green-500" />
                                                策略列表:
                                            </h4>
                                            <div className="space-y-3 max-h-64 overflow-y-auto">
                                                {Object.entries(counterDatabase).map(([key, strategies], idx) => (
                                                    <div key={idx} className="border rounded-lg p-3 bg-gray-50">
                                                        <div className="flex justify-between items-start mb-2">
                                                            <div className="flex-1">
                                                                <div className="text-sm font-medium text-gray-700 mb-1">
                                                                    對手陣容: {key.split(',').join(' + ')}
                                                                </div>
                                                                {strategies.map((strategy, strategyIdx) => (
                                                                    <div key={strategyIdx} className="text-xs text-gray-600 mb-1">
                                                                        反制: {strategy.combo.filter(c => c).join(' + ')}
                                                                        {strategy.notes && (
                                                                            <span className="text-purple-600 ml-2">
                                                                                ({SecurityUtils.sanitizeHtml(strategy.notes)})
                                                                            </span>
                                                                        )}
                                                                    </div>
                                                                ))}
                                                            </div>
                                                            <button
                                                                onClick={() => {
                                                                    if (confirm(`確定要刪除針對「${key.split(',').join('+')}」的反制策略嗎？`)) {
                                                                        const newDatabase = { ...counterDatabase };
                                                                        delete newDatabase[key];
                                                                        setCounterDatabase(newDatabase);
                                                                    }
                                                                }}
                                                                className="text-red-500 hover:text-red-700 text-xs ml-2"
                                                            >
                                                                刪除
                                                            </button>
                                                        </div>
                                                    </div>
                                                ))}

                                                {Object.keys(counterDatabase).length === 0 && (
                                                    <div className="text-center py-8 text-gray-500">
                                                        <IconComponents.Shield size={48} className="mx-auto mb-4 text-gray-300" />
                                                        <p className="mb-2">🔍 還沒有任何反制策略</p>
                                                        <p className="text-sm">可以透過上方表單手動新增，或在歷史紀錄中點擊「🎯策略」按鈕</p>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* 角色別稱設定 */}
                                <div className="bg-white rounded-lg shadow-lg p-4">
                                    <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <IconComponents.Shield className="text-indigo-500" size={20} />
                                        角色別稱設定
                                    </h2>
                                    
                                    <div className="mb-4 p-3 bg-indigo-50 rounded-lg">
                                        <div className="text-sm text-indigo-700">
                                            <strong>保護：</strong> 所有角色名稱和別稱會自動清理，防止XSS攻擊
                                        </div>
                                    </div>
                                    
                                    <div className="space-y-3 max-h-96 overflow-y-auto">
                                        {characterAliases.map((character, idx) => (
                                            <div key={idx} className="border rounded-lg p-3">
                                                <div className="flex gap-3 items-center mb-2">
                                                    <label className="text-sm font-medium text-gray-700 w-16">正式名稱:</label>
                                                    <input
                                                        type="text"
                                                        placeholder="角色正式名稱"
                                                        value={character.name}
                                                        onChange={(e) => {
                                                            const cleanName = SecurityUtils.cleanInput(e.target.value);
                                                            const newAliases = [...characterAliases];
                                                            newAliases[idx].name = cleanName;
                                                            setCharacterAliases(newAliases);
                                                        }}
                                                        className="flex-1 text-sm border rounded px-2 py-1"
                                                        maxLength="30"
                                                    />
                                                    <button
                                                        onClick={() => {
                                                            if (confirm('確定要刪除此角色嗎？')) {
                                                                const newAliases = [...characterAliases];
                                                                newAliases.splice(idx, 1);
                                                                setCharacterAliases(newAliases);
                                                            }
                                                        }}
                                                        className="text-red-500 hover:text-red-700 text-sm"
                                                    >
                                                        刪除
                                                    </button>
                                                </div>
                                                
                                                <div>
                                                    <label className="text-sm font-medium text-gray-700 block mb-1">別稱/簡稱:</label>
                                                    <div className="flex flex-wrap gap-1">
                                                        {character.aliases.map((alias, aliasIdx) => (
                                                            <div key={aliasIdx} className="flex items-center gap-1">
                                                                <input
                                                                    type="text"
                                                                    value={alias}
                                                                    onChange={(e) => {
                                                                        const cleanAlias = SecurityUtils.cleanInput(e.target.value);
                                                                        const newAliases = [...characterAliases];
                                                                        newAliases[idx].aliases[aliasIdx] = cleanAlias;
                                                                        setCharacterAliases(newAliases);
                                                                    }}
                                                                    className="border rounded px-1 py-0.5 text-xs w-16"
                                                                    placeholder="別稱"
                                                                    maxLength="20"
                                                                />
                                                                <button
                                                                    onClick={() => {
                                                                        const newAliases = [...characterAliases];
                                                                        newAliases[idx].aliases.splice(aliasIdx, 1);
                                                                        setCharacterAliases(newAliases);
                                                                    }}
                                                                    className="text-red-500 hover:text-red-700 text-xs"
                                                                    title="刪除此別稱"
                                                                >
                                                                    ×
                                                                </button>
                                                            </div>
                                                        ))}
                                                        <button
                                                            onClick={() => {
                                                                const newAliases = [...characterAliases];
                                                                newAliases[idx].aliases.push('');
                                                                setCharacterAliases(newAliases);
                                                            }}
                                                            className="bg-gray-100 hover:bg-gray-200 px-2 py-0.5 rounded text-xs"
                                                        >
                                                            + 別稱
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                        
                                        <button
                                            onClick={() => setCharacterAliases([...characterAliases, { name: '', aliases: [''] }])}
                                            className="w-full border-2 border-dashed border-gray-300 rounded-lg py-3 text-gray-500 hover:border-gray-400 text-sm flex items-center justify-center gap-2"
                                        >
                                            <IconComponents.Shield size={16} />
                                            新增角色
                                        </button>
                                    </div>
                                </div>

                                {/* 相關工具 */}
                                <div className="bg-white rounded-lg shadow-lg p-4 mb-4">
                                    <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <IconComponents.FileText className="text-blue-500" size={20} />
                                        相關工具
                                    </h2>
                                    
                                    <div className="space-y-3">
                                        <div className="p-4 bg-blue-50 rounded-lg">
                                            <h3 className="font-medium text-blue-800 mb-2">🔍 角色資料庫</h3>
                                            <div className="text-sm text-blue-700 space-y-2">
                                                <p>完整的角色查詢系統，包含:</p>
                                                <ul className="ml-4 space-y-1 text-xs">
                                                    <li>• 中英文角色名稱對照</li>
                                                    <li>• 屬性、職業分類篩選</li>
                                                    <li>• 角色暱稱搜尋功能</li>
                                                    <li>• 未來將整合TAG培養系統</li>
                                                </ul>
                                            </div>
                                            <div className="mt-3">
                                                <a 
                                                    href="character-db.html"
                                                    className="inline-flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm"
                                                >
                                                    <IconComponents.FileText size={16} />
                                                    前往角色資料庫
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* 版本說明 */}
                                <div className="bg-white rounded-lg shadow-lg p-4">
                                    <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                                        <IconComponents.Shield className="text-green-500" size={20} />
                                        v2.5.3 更新說明
                                    </h2>
                                    
                                    <div className="space-y-3">
                                        <div className="p-3 bg-green-50 rounded-lg">
                                            <h4 className="font-medium text-green-800 mb-2">🔧 v2.5.3 新功能與優化</h4>
                                            <ul className="text-sm text-green-700 space-y-1">
                                                <li>• <strong>加快搜尋後紀錄步驟</strong>：優化搜索功能，提升記錄效率</li>
                                                <li>• <strong>角色資料庫連結</strong>：新增相關工具區塊，快速連結角色資料庫</li>
                                                <li>• <strong>日期批次刪除</strong>：得以選擇日期批次刪除該日期前(不含)之紀錄</li>
                                                <li>• <strong>歷史搜索新功能</strong>：輸入對手陣容快速找到相關記錄和我方勝場策略</li>
                                                <li>• <strong>匹配系統</strong>：自動顯示完全/高度匹配記錄，高亮匹配角色</li>
                                                <li>• <strong>別名緩存系統</strong>：預計算角色別名轉換，大幅提升搜索速度</li>
                                                <li>• <strong>勝場策略推薦</strong>：基於歷史勝場記錄推薦最適我方陣容</li>
                                                <li>• <strong>視覺化增強</strong>：搜索模式下不同匹配等級用不同背景色區分</li>
                                            </ul>
                                        </div>
                                        
                                        <div className="p-3 bg-purple-50 rounded-lg">
                                            <h4 className="font-medium text-purple-800 mb-2">🎯 持續功能：速度計算器 & 歷史搜索</h4>
                                            <ul className="text-sm text-purple-700 space-y-1">
                                                <li>• <strong>速度計算</strong>：根據我方參考數據計算對手角色速度</li>
                                                <li>• <strong>可選功能</strong>：在記錄頁面點擊「速度計算器」按鈕開啟</li>
                                                <li>• <strong>精確計算</strong>：支援已知隨機值的精確速度計算</li>
                                                <li>• <strong>範圍估算</strong>：未知隨機值時提供速度範圍估算</li>
                                                <li>• <strong>歷史搜索新功能</strong>：輸入3-4個對手角色，立即找到相關歷史記錄</li>
                                                <li>• <strong>智能匹配</strong>：自動顯示完全/高度匹配記錄，高亮匹配角色</li>
                                                <li>• <strong>勝場策略推薦</strong>：基於歷史勝場記錄推薦最適我方陣容</li>
                                            </ul>
                                        </div>
                                        
                                        <div className="p-3 bg-blue-50 rounded-lg">
                                            <h4 className="font-medium text-blue-800 mb-2">🛡️ 安全防護</h4>
                                            <ul className="text-sm text-blue-700 space-y-1">
                                                <li>• <strong>XSS防護</strong>：所有輸入自動清理HTML標籤和腳本</li>
                                                <li>• <strong>資料混淆</strong>：本地存儲數據採用Base64編碼</li>
                                                <li>• <strong>URL驗證</strong>：Google Sheets同步僅允許官方域名</li>
                                            </ul>
                                        </div>
                                        
                                        <div className="p-3 bg-yellow-50 rounded-lg">
                                            <h4 className="font-medium text-yellow-800 mb-2">📞 技術資訊</h4>
                                            <div className="text-sm text-yellow-700 space-y-1">
                                                <div>• <strong>版本</strong>：v2.5.3</div>
                                                <div>• <strong>發布日期</strong>：{new Date().toLocaleDateString('zh-TW')}</div>
                                                <div>• <strong>安全等級</strong>：高度 🛡️</div>
                                                <div>• <strong>適用環境</strong>：離線使用，私人部署</div>
                                                <div>• <strong>開發者</strong>：zzas</div>
                                                <div>• <strong>主要改進</strong>：加快搜尋後紀錄步驟，新增角色資料庫連結</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        <div className="mt-4 text-center text-xs text-gray-500">
                            ArkRecode 對戰紀錄器 v2.5.3 | 離線使用 | 歷史搜索功能 + 策略推薦
                        </div>
                    </div>
                </div>
            );
        };

        // 初始化應用
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
